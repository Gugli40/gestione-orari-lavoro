<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B0000">
    <meta name="description" content="Gestione professionale orari lavorativi con calcolo automatico straordinari e maggiorazioni">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gestione Orari Lavorativi Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        button, a, input, select {
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
            color: #212529;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(139, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .header {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
            background: #f8f9fa;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
            color: #8B0000;
        }

        .tab.active {
            color: #8B0000;
            border-bottom-color: #8B0000;
            background: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .section h2 {
            color: #212529;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .time-input {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .time-input label {
            display: block;
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #212529;
        }

        .btn {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
            background: linear-gradient(135deg, #A0000A 0%, #E6164D 100%);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-success {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #157347 0%, #1aa179 100%);
            box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e83 100%);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #b02a37 0%, #fc616a 100%);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #0dcaf0 0%, #6edff6 100%);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #0aa2c0 0%, #5bc3d4 100%);
            box-shadow: 0 5px 15px rgba(13, 202, 240, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            color: #000;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e55e00 0%, #ffb30d 100%);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .config-item input {
            flex: 1;
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .timesheet-table th, .timesheet-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .timesheet-table th {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .timesheet-table tr:hover {
            background: #f8f9fa;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(139, 0, 0, 0.15);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .summary-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 2.2em;
            font-weight: 700;
        }

        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            border-left: 4px solid #f44336;
        }

        .success {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        .auto-calc {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #8B0000;
            border: 1px solid #e9ecef;
        }

        .auto-calc h4 {
            color: #8B0000;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .calc-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .calc-item .label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 500;
        }

        .calc-item .value {
            font-size: 18px;
            font-weight: 700;
            color: #8B0000;
        }

        .calendar-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
        }

        .calendar-day-header {
            padding: 15px 5px;
            text-align: center;
            font-weight: 600;
            color: white;
            font-size: 14px;
        }

        .calendar-day-header.sab {
            background: rgba(255, 152, 0, 0.2);
        }

        .calendar-day-header.dom {
            background: rgba(220, 53, 69, 0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            border-color: #8B0000;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }

        .calendar-day.today {
            background: #fff5f5;
            border: 2px solid #8B0000;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.2);
        }

        .calendar-day.weekend {
            background: #fff8f0;
        }

        .calendar-day.has-work {
            background: #f8fff8;
            border-left: 4px solid #198754;
        }

        .calendar-day.selected {
            background: #fff5f5;
            border: 2px solid #DC143C;
            box-shadow: 0 0 15px rgba(220, 20, 60, 0.3);
        }

        .calendar-day-number {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            color: #212529;
        }

        .calendar-day-info {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.2;
        }

        .calendar-day-hours {
            font-weight: 600;
            color: #198754;
        }

        .calendar-day-pay {
            color: #8B0000;
            font-weight: 600;
        }

        .calendar-quick-add {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #8B0000;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 600;
        }

        .calendar-day:hover .calendar-quick-add {
            opacity: 1;
        }

        .calendar-quick-add:hover {
            background: #DC143C;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .content {
                padding: 15px;
            }
            
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                gap: 5px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 14px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .time-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
            }
            
            .time-input {
                padding: 12px;
            }
            
            .time-input label {
                font-size: 11px;
            }
            
            .time-input input {
                font-size: 16px;
                padding: 8px;
            }
            
            .form-group input, 
            .form-group select {
                padding: 14px;
                font-size: 16px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
                width: 100%;
            }
            
            .btn-small {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .section {
                padding: 15px;
            }
            
            .timesheet-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .timesheet-table th,
            .timesheet-table td {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 5px;
            }
            
            .calendar-day-number {
                font-size: 14px;
            }
            
            .calendar-day-info {
                font-size: 9px;
            }
            
            .calendar-quick-add {
                opacity: 1;
            }
            
            .summary {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-card {
                padding: 20px;
            }
            
            .summary-card .value {
                font-size: 1.8em;
            }
            
            .calc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }
            
            .section div[style*="grid-template-columns: 1fr 1fr"] > div {
                margin-bottom: 20px;
            }
            
            .overtime-item {
                flex-direction: column !important;
                text-align: center;
                gap: 10px !important;
            }
            
            .break-item {
                flex-direction: column !important;
                gap: 10px;
            }
            
            .break-item > div {
                width: 100% !important;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: block !important;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] > div {
                margin-bottom: 15px;
                padding: 0 !important;
                border: none !important;
            }
            
            .config-item {
                flex-wrap: wrap;
            }
            
            .config-item input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Gestione Orari Lavorativi Pro</h1>
            <p>Sistema avanzato per la gestione completa degli orari di lavoro - Versione v3.1 Mobile Optimized</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('inserimento')">‚è∞ Inserimento</button>
                <button class="tab" onclick="showTab('calendario')">üìÖ Calendario</button>
                <button class="tab" onclick="showTab('configurazione')">‚öôÔ∏è Configurazione</button>
                <button class="tab" onclick="showTab('registro')">üìä Registro</button>
                <button class="tab" onclick="showTab('riepilogo')">üìà Riepilogo</button>
            </div>

            <div id="tab-calendario" class="tab-content">
                <div class="section">
                    <h2>üìÖ Calendario Mensile</h2>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); border-radius: 8px; color: white; flex-wrap: wrap; gap: 10px;">
                        <button class="btn" onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">‚¨ÖÔ∏è Precedente</button>
                        <h3 id="calendarTitle" style="margin: 0; font-size: 1.5em; font-weight: 600;">Marzo 2025</h3>
                        <button class="btn" onclick="changeMonth(1)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">Successivo ‚û°Ô∏è</button>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header sab">Sab</div>
                            <div class="calendar-day-header dom">Dom</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border-left: 4px solid #8B0000; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #8B0000; font-weight: 600;">üìã Legenda</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #198754; border-radius: 3px; margin-right: 8px;"></span>‚úÖ Giornata completa</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #ffc107; border-radius: 3px; margin-right: 8px;"></span>‚è≥ Giornata in corso</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #dc3545; border-radius: 3px; margin-right: 8px;"></span>‚ùå Giornata incompleta</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #8B0000; border-radius: 3px; margin-right: 8px;"></span>Giorno corrente</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #ff9800; border-radius: 3px; margin-right: 8px;"></span>Weekend</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #adb5bd; border-radius: 3px; margin-right: 8px;"></span>Altro mese</div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px; color: #495057;">
                            <strong>üí° Suggerimento:</strong> Puoi salvare una giornata anche con solo l'orario di entrata per tenerla tracciata. Completa con l'uscita quando finisci di lavorare!
                        </div>
                    </div>
                </div>
                
                <div class="section" id="dayDetails" style="display: none;">
                    <h2>üìã Dettaglio Giorno Selezionato</h2>
                    <div id="dayDetailsContent">
                    </div>
                </div>
            </div>

            <div id="tab-inserimento" class="tab-content active">
                <div class="section">
                    <h2>‚è∞ Inserimento Giornata Lavorativa</h2>
                    
                    <div class="grid grid-2" style="margin-bottom: 25px;">
                        <div class="form-group">
                            <label for="workDate">üìÖ Data</label>
                            <input type="date" id="workDate">
                        </div>
                        <div class="form-group">
                            <label for="travelType">‚úàÔ∏è Tipo Trasferta</label>
                            <select id="travelType">
                                <option value="">Nessuna</option>
                            </select>
                        </div>
                    </div>

                    <div class="time-grid">
                        <div class="time-input">
                            <label>üü¢ Entrata</label>
                            <input type="time" id="entryTime">
                        </div>
                        <div class="time-input">
                            <label>‚è∏Ô∏è Pausa</label>
                            <input type="time" id="breakStart">
                        </div>
                        <div class="time-input">
                            <label>‚ñ∂Ô∏è Rientro</label>
                            <input type="time" id="breakEnd">
                        </div>
                        <div class="time-input">
                            <label>üî¥ Uscita</label>
                            <input type="time" id="exitTime">
                        </div>
                    </div>

                    <div class="section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <h4 style="margin: 0; color: #17a2b8; font-weight: 600;">‚è∏Ô∏è Pause Aggiuntive</h4>
                            <button type="button" class="btn btn-info btn-small" onclick="addBreak()">‚ûï Aggiungi Pausa</button>
                        </div>
                        
                        <div id="breaksContainer">
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                <em>Nessuna pausa aggiuntiva. La pausa principale √® gi√† inclusa sopra.</em>
                            </div>
                        </div>
                        
                        <div id="breaksSummary" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e9ecef; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>üìä Pause Aggiuntive:</strong></span>
                                <span id="totalBreakTime" style="font-weight: 600; color: #17a2b8;">0h 00m</span>
                            </div>
                        </div>
                    </div>

                    <div class="auto-calc" id="autoCalc" style="display: none;">
                        <h4>üìä Calcolo Automatico Dettagliato</h4>
                        <div class="calc-grid">
                            <div class="calc-item">
                                <div class="label">Tipo Giorno</div>
                                <div class="value" id="calcDayType">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Pausa Totale</div>
                                <div class="value" id="calcBreak">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Ore Lavorate</div>
                                <div class="value" id="calcWork">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Ore Notturne</div>
                                <div class="value" id="calcNight">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Straordinari</div>
                                <div class="value" id="calcOvertime">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Compenso</div>
                                <div class="value" id="calcPay">--</div>
                            </div>
                        </div>
                        <div id="calcBreakdown" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-size: 12px; color: #666;">
                        </div>
                    </div>

                    <div class="grid grid-2" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="notes">üìù Note</label>
                            <input type="text" id="notes" placeholder="Note opzionali...">
                        </div>
                        <div style="display: flex; align-items: end; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="addWorkDay()" style="flex: 1; min-width: 150px;">‚ûï Aggiungi Giornata</button>
                            <button class="btn btn-info" onclick="clearForm()" style="flex: 1; min-width: 150px;">üîÑ Pulisci</button>
                        </div>
                    </div>

                    <div id="message"></div>
                </div>
            </div>

            <div id="tab-configurazione" class="tab-content">
                <div class="section">
                    <h2>‚öôÔ∏è Configurazione Base</h2>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="hourlyRate">üí∞ Paga Oraria (‚Ç¨)</label>
                            <input type="number" id="hourlyRate" value="15" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="standardHours">‚è±Ô∏è Ore Standard/Giorno</label>
                            <input type="number" id="standardHours" value="8" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="standardBreak">‚òï Pausa Standard (min)</label>
                            <input type="number" id="standardBreak" value="60" step="15">
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #198754; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #198754; font-weight: 600;">‚ÑπÔ∏è Maggiorazioni Automatiche Attive</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px; color: #495057;">
                            <div><strong>Feriali oltre 8h:</strong> +25%</div>
                            <div><strong>Sabato 1-3h:</strong> +25%</div>
                            <div><strong>Sabato oltre 3h:</strong> +50%</div>
                            <div><strong>Domenica:</strong> +45%</div>
                            <div><strong>Notturno normale:</strong> +15%</div>
                            <div><strong>Notturno straordinario:</strong> +55%</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>‚úàÔ∏è Gestione Tipi Trasferte</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label for="newTravelName">Nome Tipo</label>
                                <input type="text" id="newTravelName" placeholder="es. Nazionale, Estero...">
                            </div>
                            <div class="form-group">
                                <label for="newTravelAmount">Importo Fisso (‚Ç¨)</label>
                                <input type="number" id="newTravelAmount" placeholder="15" step="0.50">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button class="btn btn-success" onclick="addTravelType()">‚ûï Aggiungi</button>
                            </div>
                        </div>
                    </div>
                    <div id="travelList"></div>
                </div>
            </div>

            <div id="tab-registro" class="tab-content">
                <div class="section">
                    <h2>üìä Registro Orari Completo</h2>
                    <div style="overflow-x: auto;">
                        <table class="timesheet-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Entrata</th>
                                    <th>Pausa</th>
                                    <th>Rientro</th>
                                    <th>Uscita</th>
                                    <th>Pause Agg.</th>
                                    <th>Pausa Tot.</th>
                                    <th>Ore Lav.</th>
                                    <th>Straord.</th>
                                    <th>Notturne</th>
                                    <th>Tipo Giorno</th>
                                    <th>Trasferta</th>
                                    <th>Compenso</th>
                                    <th>Note</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="timesheet-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-riepilogo" class="tab-content">
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #4a90e2; border: 1px solid #e9ecef;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <label for="monthSelector" style="font-weight: 600; color: #4a90e2; font-size: 16px;">üìÖ Visualizza mese:</label>
                            <select id="monthSelector" onchange="updateMonthFilter()" style="padding: 10px 15px; border: 2px solid #4a90e2; border-radius: 6px; font-size: 16px; font-weight: 500; background: white; min-width: 200px;">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px; color: #6c757d; font-size: 14px; flex-wrap: wrap;">
                            <span>üìä Giornate: <strong id="monthDaysCount" style="color: #4a90e2;">0</strong></span>
                            <span>üíº Ore: <strong id="monthHoursCount" style="color: #198754;">0h</strong></span>
                        </div>
                    </div>
                </div>

                <div class="summary">
                    <div class="summary-card">
                        <h3>Ore Ordinarie Lavorate</h3>
                        <div class="value" id="regularHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Ore Straordinari</h3>
                        <div class="value" id="overtimeHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Ore Notturne</h3>
                        <div class="value" id="nightHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Giorni Trasferta</h3>
                        <div class="value" id="travelDays">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Totale Mensile</h3>
                        <div class="value" id="monthlyTotal">‚Ç¨0</div>
                    </div>
                </div>

                <div class="section" style="margin-top: 30px;">
                    <div style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <h2 style="margin: 0; color: white; border: none; padding: 0;">‚ö° BREAKDOWN DETTAGLIATO STRAORDINARI E MAGGIORAZIONI</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;" id="breakdownSubtitle">Analisi completa di tutti i compensi aggiuntivi del mese</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h3 style="color: #8B0000; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #8B0000; padding-bottom: 10px;">üìÖ Straordinari per Tipo Giorno</h3>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #198754;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üü¢ Feriali (oltre 8h) +25%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="weekdayBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 1.25 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #198754;" id="weekdayAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üü† Sabato (prime 3h) +25%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="saturdayFirstBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 1.25 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #ff9800;" id="saturdayFirstAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff5722;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üî¥ Sabato (oltre 3h) +50%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="saturdayRestBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 1.50 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #ff5722;" id="saturdayRestAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #dc3545;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üî¥ Domenica (tutto) +45%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="sundayBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 1.45 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #dc3545;" id="sundayAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div style="padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 6px; border: 1px solid #2196f3;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #1976d2;">üìä Subtotale Straordinari:</span>
                                    <span style="font-size: 20px; font-weight: 700; color: #1976d2;" id="overtimeSubtotal">‚Ç¨0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h3 style="color: #8B0000; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #8B0000; padding-bottom: 10px;">üåô Maggiorazioni Speciali</h3>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4a90e2;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üåô Notturno Normale +15%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="nightNormalBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 0.15 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #4a90e2;" id="nightNormalAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #673ab7;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">üåú Notturno Straord. +55%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="nightOvertimeBreakdown">0h 00m √ó ‚Ç¨0.00 √ó 0.55 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #673ab7;" id="nightOvertimeAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #00bcd4;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">‚úàÔ∏è Trasferte</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="travelBreakdown">0 giorni √ó ‚Ç¨0.00 = ‚Ç¨0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #00bcd4;" id="travelAmount">‚Ç¨0.00</div>
                            </div>
                            
                            <div style="padding: 15px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 6px; border: 1px solid #9c27b0; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #7b1fa2;">üéØ Subtotale Maggiorazioni:</span>
                                    <span style="font-size: 20px; font-weight: 700; color: #7b1fa2;" id="bonusSubtotal">‚Ç¨0.00</span>
                                </div>
                            </div>
                            
                            <div style="padding: 15px; background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); border-radius: 6px; border: 1px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #2e7d32;">üí∞ TOTALE MAGGIORAZIONI:</span>
                                    <span style="font-size: 22px; font-weight: 700; color: #2e7d32;" id="totalBonuses">‚Ç¨0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; padding: 25px; border-radius: 8px; text-align: center;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üíµ Paga Base:</div>
                                <div style="font-size: 24px; font-weight: 600;" id="basePay">‚Ç¨0.00</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">‚ûï Maggiorazioni:</div>
                                <div style="font-size: 24px; font-weight: 600;" id="totalBonusesDisplay">‚Ç¨0.00</div>
                            </div>
                            <div style="border-left: 2px solid rgba(255,255,255,0.3); padding-left: 20px;">
                                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">üéØ TOTALE FINALE:</div>
                                <div style="font-size: 32px; font-weight: 700;" id="grandTotal">‚Ç¨0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>üîß Azioni</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="importFromExcelFixed()">üìÅ Importa Excel</button>
                        <button class="btn btn-success" onclick="exportToExcelFiltered()">üìÑ Esporta Excel (Mese)</button>
                        <button class="btn btn-warning" onclick="exportToPDFFiltered()">üìë Esporta PDF (Mese)</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Cancella Tutto</button>
                        <button class="btn" onclick="saveConfig()">üíæ Forza Salvataggio</button>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #ffffff; border-radius: 8px; border-left: 4px solid #0dcaf0; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #0dcaf0; font-weight: 600;">‚ÑπÔ∏è Informazioni v3.1 Mobile Optimized</h4>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Novit√† v3.1:</strong> Riepilogo separato per ogni mese + Export per mese selezionato!
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Mobile:</strong> Interfaccia ottimizzata per smartphone e tablet
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Nota:</strong> Le configurazioni si salvano automaticamente nel browser
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workDays = [];
        let travelTypes = [
            { name: 'In Regione', amount: 10 },
            { name: 'Fuori Regione', amount: 15 },
            { name: 'Estero', amount: 25 }
        ];
        
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;
        let additionalBreaks = [];
        let breakCounter = 0;

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('üöÄ Inizializzazione Gestione Orari Pro v3.1 Mobile Optimized');
            
            const configLoaded = loadConfig();
            const workDaysCount = loadWorkDays();
            
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            
            additionalBreaks = [];
            breakCounter = 0;
            renderBreaks();
            
            updateTravelDropdown();
            updateTravelList();
            updateTable();
            populateMonthSelector();
            updateSummary();
            generateCalendar();
            addCalculationListeners();
            addConfigListeners();
            
            if (configLoaded || workDaysCount > 0) {
                let message = '‚úÖ ';
                if (configLoaded) message += 'Configurazione caricata';
                if (workDaysCount > 0) {
                    if (message.length > 3) message += ' + ';
                    message += `${workDaysCount} giornate caricate`;
                }
                message += ' - v3.1 Mobile Optimized attivo!';
                showMessage(message, 'success');
            }
            
            console.log('üì± Sistema v3.1 Mobile pronto');
        }

        function addConfigListeners() {
            ['hourlyRate', 'standardHours', 'standardBreak'].forEach(id => {
                document.getElementById(id).addEventListener('change', autoSaveConfig);
            });
        }

        function addBreak() {
            breakCounter++;
            const breakId = `break_${breakCounter}`;
            
            const breakItem = {
                id: breakId,
                start: '',
                end: ''
            };
            
            additionalBreaks.push(breakItem);
            renderBreaks();
            
            setTimeout(() => {
                document.getElementById(`${breakId}_start`).focus();
            }, 100);
        }
        
        function removeBreak(breakId) {
            additionalBreaks = additionalBreaks.filter(br => br.id !== breakId);
            renderBreaks();
            updateBreaksSummary();
            calculateAutomatic();
        }
        
        function renderBreaks() {
            const container = document.getElementById('breaksContainer');
            
            if (additionalBreaks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        <em>Nessuna pausa aggiuntiva. La pausa principale √® gi√† inclusa sopra.</em>
                    </div>
                `;
                document.getElementById('breaksSummary').style.display = 'none';
                return;
            }
            
            let html = '';
            additionalBreaks.forEach((breakItem, index) => {
                html += `
                    <div class="break-item" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef;">
                        <div style="flex: 0 0 auto; font-weight: 600; color: #17a2b8;">
                            Pausa ${index + 2}:
                        </div>
                        <div style="flex: 1; display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                            <div>
                                <label style="font-size: 12px; color: #6c757d; margin-bottom: 5px; display: block;">Inizio</label>
                                <input type="time" id="${breakItem.id}_start" value="${breakItem.start}" 
                                       onchange="updateBreak('${breakItem.id}', 'start', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px;">
                            </div>
                            <div style="text-align: center; color: #6c757d; font-weight: bold;">‚Üí</div>
                            <div>
                                <label style="font-size: 12px; color: #6c757d; margin-bottom: 5px; display: block;">Fine</label>
                                <input type="time" id="${breakItem.id}_end" value="${breakItem.end}"
                                       onchange="updateBreak('${breakItem.id}', 'end', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px;">
                            </div>
                        </div>
                        <div style="flex: 0 0 auto;">
                            <button type="button" class="btn btn-small btn-danger" onclick="removeBreak('${breakItem.id}')" title="Rimuovi pausa">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('breaksSummary').style.display = 'block';
            updateBreaksSummary();
        }
        
        function updateBreak(breakId, field, value) {
            const breakItem = additionalBreaks.find(br => br.id === breakId);
            if (breakItem) {
                breakItem[field] = value;
                updateBreaksSummary();
                calculateAutomatic();
            }
        }
        
        function updateBreaksSummary() {
            let totalMinutes = 0;
            let validBreaks = 0;
            
            additionalBreaks.forEach(breakItem => {
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (end > start) {
                        totalMinutes += (end - start) / (1000 * 60);
                        validBreaks++;
                    }
                }
            });
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            
            document.getElementById('totalBreakTime').textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m`;
            
            const summaryElement = document.getElementById('breaksSummary');
            if (validBreaks > 0) {
                summaryElement.style.borderLeft = '4px solid #28a745';
            } else {
                summaryElement.style.borderLeft = '4px solid #ffc107';
            }
        }
        
        function validateBreaks() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            
            if (!entryTime || !exitTime) return true;
            
            const entry = new Date(`2000-01-01T${entryTime}`);
            let exit = new Date(`2000-01-01T${exitTime}`);
            
            if (exit <= entry) {
                exit = new Date(`2000-01-02T${exitTime}`);
            }
            
            if (breakStart && breakEnd) {
                const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (mainBreakEnd <= mainBreakStart) {
                    mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                
                if (mainBreakStart < entry || mainBreakEnd > exit) {
                    return 'La pausa principale deve essere compresa tra entrata e uscita';
                }
            }
            
            for (let i = 0; i < additionalBreaks.length; i++) {
                const breakItem = additionalBreaks[i];
                
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (start < entry || end > exit) {
                        return `La pausa aggiuntiva ${i + 1} deve essere compresa tra entrata e uscita`;
                    }
                    
                    if (breakStart && breakEnd) {
                        const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                        let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                        
                        if (mainBreakEnd <= mainBreakStart) {
                            mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                        }
                        
                        if ((start < mainBreakEnd && end > mainBreakStart)) {
                            return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa principale`;
                        }
                    }
                    
                    for (let j = i + 1; j < additionalBreaks.length; j++) {
                        const otherBreak = additionalBreaks[j];
                        if (otherBreak.start && otherBreak.end) {
                            const otherStart = new Date(`2000-01-01T${otherBreak.start}`);
                            let otherEnd = new Date(`2000-01-01T${otherBreak.end}`);
                            
                            if (otherEnd <= otherStart) {
                                otherEnd = new Date(`2000-01-02T${otherBreak.end}`);
                            }
                            
                            if ((start < otherEnd && end > otherStart)) {
                                return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa aggiuntiva ${j + 1}`;
                            }
                        }
                    }
                }
            }
            
            return true;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function addTravelType() {
            const name = document.getElementById('newTravelName').value.trim();
            const amount = parseFloat(document.getElementById('newTravelAmount').value);
            
            if (!name || isNaN(amount)) {
                showMessage('Compila nome e importo per il tipo trasferta', 'error');
                return;
            }
            
            if (travelTypes.find(type => type.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Tipo trasferta gi√† esistente', 'error');
                return;
            }
            
            travelTypes.push({ name, amount });
            updateTravelDropdown();
            updateTravelList();
            autoSaveConfig();
            
            document.getElementById('newTravelName').value = '';
            document.getElementById('newTravelAmount').value = '';
            
            showMessage('Tipo trasferta aggiunto con successo', 'success');
        }

        function removeTravelType(index) {
            if (confirm('Sei sicuro di voler eliminare questo tipo trasferta?')) {
                travelTypes.splice(index, 1);
                updateTravelDropdown();
                updateTravelList();
                autoSaveConfig();
                showMessage('Tipo trasferta eliminato', 'success');
            }
        }

        function updateTravelDropdown() {
            const select = document.getElementById('travelType');
            select.innerHTML = '<option value="">Nessuna</option>';
            
            travelTypes.forEach((type, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${type.name} (+‚Ç¨${type.amount})`;
                select.appendChild(option);
            });
        }

        function updateTravelList() {
            const container = document.getElementById('travelList');
            container.innerHTML = '';
            
            travelTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <input type="text" value="${type.name}" onchange="updateTravelName(${index}, this.value)" style="flex: 2; font-size: 16px;">
                    <input type="number" value="${type.amount}" onchange="updateTravelAmount(${index}, this.value)" style="flex: 1; font-size: 16px;" step="0.50">
                    <span>‚Ç¨</span>
                    <button class="btn btn-small btn-danger" onclick="removeTravelType(${index})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function updateTravelName(index, newName) {
            travelTypes[index].name = newName;
            updateTravelDropdown();
            autoSaveConfig();
        }

        function updateTravelAmount(index, newAmount) {
            travelTypes[index].amount = parseFloat(newAmount) || 0;
            updateTravelDropdown();
            autoSaveConfig();
        }

        function exportToPDFFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Non ci sono dati per il mese selezionato da esportare', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const currentMonth = getCurrentMonthName();
                
                doc.setFontSize(20);
                doc.setTextColor(139, 0, 0);
                doc.text(`REGISTRO ORARI - ${currentMonth.toUpperCase()}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const today = new Date().toLocaleDateString('it-IT');
                doc.text(`Generato il: ${today}`, pageWidth / 2, 40, { align: 'center' });
                
                const monthlyData = calculateMonthlyTotals(filteredDays);
                
                let yPos = 55;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`RIEPILOGO ${currentMonth.toUpperCase()}`, margin, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                
                const summaryData = [
                    [`Ore Ordinarie Lavorate:`, formatHours(monthlyData.regularHours)],
                    [`Ore Straordinari:`, formatHours(monthlyData.overtimeHours)],
                    [`Ore Notturne:`, formatHours(monthlyData.nightHours)],
                    [`Giorni Trasferta:`, monthlyData.travelDays.toString()],
                    [`TOTALE COMPENSO:`, `‚Ç¨${monthlyData.monthlyTotal.toFixed(2)}`]
                ];
                
                summaryData.forEach(([label, value], index) => {
                    doc.text(label, margin, yPos + (index * 6));
                    doc.setFont(undefined, 'bold');
                    if (index === summaryData.length - 1) {
                        doc.setTextColor(139, 0, 0);
                        doc.setFontSize(12);
                    }
                    doc.text(value, margin + 60, yPos + (index * 6));
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(50, 50, 50);
                    doc.setFontSize(10);
                });
                
                yPos += 45;
                
                const tableData = filteredDays.map(day => [
                    formatDate(day.date),
                    day.entryTime,
                    day.breakStart || '--',
                    day.breakEnd || '--',
                    day.exitTime,
                    day.breakTime,
                    formatHours(parseFloat(day.workHours)),
                    formatHours(parseFloat(day.overtimeHours)),
                    formatHours(parseFloat(day.nightHours || 0)),
                    day.dayType?.substring(0, 15) || 'Feriale',
                    day.travelType || '--',
                    `‚Ç¨${day.dailyPay}`,
                    (day.notes || '').substring(0, 20)
                ]);
                
                const tableHeaders = [
                    'Data', 'Entrata', 'Pausa', 'Rientro', 'Uscita', 
                    'Pausa Tot.', 'Ore Lav.', 'Straord.', 'Notturne', 
                    'Tipo Giorno', 'Trasferta', 'Compenso', 'Note'
                ];
                
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [139, 0, 0],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 22 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 22 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 18 },
                        5: { cellWidth: 22 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 18 },
                        8: { cellWidth: 18 },
                        9: { cellWidth: 32 },
                        10: { cellWidth: 22 },
                        11: { cellWidth: 22, fontStyle: 'bold' },
                        12: { cellWidth: 30, fontSize: 8 }
                    },
                    didDrawPage: function(data) {
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Pagina ${data.pageNumber}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                        doc.text('Generato con Gestione Orari Lavorativi Pro v3.1 Mobile', margin, pageHeight - 10);
                    }
                });
                
                const fileName = `registro_${currentMonth.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showMessage(`PDF per ${currentMonth} generato con successo!`, 'success');
                
            } catch (error) {
                console.error('Errore export PDF:', error);
                showMessage('Errore nella generazione del PDF: ' + error.message, 'error');
            }
        }

        function exportToExcelFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Non ci sono dati per il mese selezionato da esportare', 'error');
                return;
            }

            const currentMonth = getCurrentMonthName();
            
            const exportData = filteredDays.map(day => ({
                'Data': formatDate(day.date),
                'Entrata': day.entryTime,
                'Pausa': day.breakStart || '--',
                'Rientro': day.breakEnd || '--',
                'Uscita': day.exitTime,
                'Pausa Totale': day.breakTime,
                'Ore Lavorate': formatHours(parseFloat(day.workHours)),
                'Straordinari': formatHours(parseFloat(day.overtimeHours)),
                'Ore Notturne': formatHours(parseFloat(day.nightHours || 0)),
                'Tipo Giorno': day.dayType || 'Feriale',
                'Tipo Trasferta': day.travelType || '--',
                'Compenso (‚Ç¨)': day.dailyPay,
                'Note': day.notes
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            const monthlyData = calculateMonthlyTotals(filteredDays);
            
            const summary = [
                [`RIEPILOGO MENSILE - ${currentMonth.toUpperCase()}`],
                [''],
                ['Ore Ordinarie Lavorate:', formatHours(monthlyData.regularHours)],
                ['Ore Straordinari:', formatHours(monthlyData.overtimeHours)],
                ['Ore Notturne:', formatHours(monthlyData.nightHours)],
                ['Giorni Trasferta:', monthlyData.travelDays.toString()],
                ['Totale Mensile:', `‚Ç¨${monthlyData.monthlyTotal.toFixed(2)}`]
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Orari Dettagliati');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Riepilogo');

            const fileName = `orari_${currentMonth.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage(`File Excel per ${currentMonth} esportato con successo!`, 'success');
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa operazione non pu√≤ essere annullata.')) {
                workDays = [];
                updateTable();
                populateMonthSelector();
                updateSummary();
                generateCalendar();
                autoSaveWorkDays();
                showMessage('Tutti i dati sono stati cancellati', 'success');
            }
        }

        function addCalculationListeners() {
            const timeInputs = ['entryTime', 'breakStart', 'breakEnd', 'exitTime'];
            const typeInputs = ['travelType'];
            
            timeInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateAutomatic);
            });
            
            typeInputs.forEach(id => {
                document.getElementById(id).addEventListener('change', calculateAutomatic);
            });
        }

        function calculateAutomatic() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            
            const autoCalc = document.getElementById('autoCalc');
            
            if (entryTime && exitTime) {
                const breakValidation = validateBreaks();
                if (breakValidation !== true) {
                    autoCalc.style.display = 'block';
                    document.getElementById('calcDayType').textContent = 'Errore';
                    document.getElementById('calcBreak').textContent = '--';
                    document.getElementById('calcWork').textContent = '--';
                    document.getElementById('calcNight').textContent = '--';
                    document.getElementById('calcOvertime').textContent = '--';
                    document.getElementById('calcPay').textContent = '--';
                    document.getElementById('calcBreakdown').innerHTML = `<strong>‚ùå Errore:</strong> ${breakValidation}`;
                    return;
                }
                
                autoCalc.style.display = 'block';
                
                const result = calculateWorkHours(entryTime, exitTime);
                
                document.getElementById('calcDayType').textContent = result.dayType || '--';
                document.getElementById('calcBreak').textContent = result.breakTime;
                document.getElementById('calcWork').textContent = formatHours(parseFloat(result.workHours));
                document.getElementById('calcNight').textContent = formatHours(parseFloat(result.nightHours));
                document.getElementById('calcOvertime').textContent = formatHours(parseFloat(result.overtimeHours));
                document.getElementById('calcPay').textContent = '‚Ç¨' + result.dailyPay;
                
                showDetailedBreakdown(result);
            } else if (entryTime || exitTime || additionalBreaks.length > 0) {
                autoCalc.style.display = 'block';
                
                document.getElementById('calcDayType').textContent = entryTime ? 'In corso...' : 'Incompleto';
                document.getElementById('calcBreak').textContent = '--';
                document.getElementById('calcWork').textContent = '--';
                document.getElementById('calcNight').textContent = '--';
                document.getElementById('calcOvertime').textContent = '--';
                document.getElementById('calcPay').textContent = '--';
                
                const statusMsg = entryTime && !exitTime ? 
                    'Giornata in corso - aggiungi l\'uscita per calcolare il totale' :
                    'Compila entrata e uscita per il calcolo automatico';
                    
                document.getElementById('calcBreakdown').innerHTML = 
                    `<strong>‚ÑπÔ∏è Stato:</strong> ${statusMsg}`;
            } else {
                autoCalc.style.display = 'none';
            }
        }

        function showDetailedBreakdown(result) {
            const workDate = new Date(document.getElementById('workDate').value);
            const dayOfWeek = workDate.getDay();
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const workHours = parseFloat(result.workHours);
            const nightHours = parseFloat(result.nightHours);
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            let breakdown = '<strong>üìã Breakdown Calcolo Preciso:</strong><br>';
            
            if (dayOfWeek === 0) {
                breakdown += `üéØ Domenica: ${formatHours(workHours)} √ó ‚Ç¨${hourlyRate} √ó 1.45 = ‚Ç¨${(workHours * hourlyRate * 1.45).toFixed(2)}<br>`;
                breakdown += `‚ÑπÔ∏è Tutte le ore domenicali sono maggiorate del +45%`;
            } else if (dayOfWeek === 6) {
                const firstThree = Math.min(workHours, 3);
                const remaining = Math.max(0, workHours - 3);
                
                breakdown += `üéØ Sabato prime 3h: ${formatHours(firstThree)} √ó ‚Ç¨${hourlyRate} √ó 1.25 = ‚Ç¨${(firstThree * hourlyRate * 1.25).toFixed(2)}<br>`;
                if (remaining > 0) {
                    breakdown += `üéØ Sabato oltre 3h: ${formatHours(remaining)} √ó ‚Ç¨${hourlyRate} √ó 1.50 = ‚Ç¨${(remaining * hourlyRate * 1.50).toFixed(2)}<br>`;
                }
            } else {
                const regularHours = Math.min(workHours, standardHours);
                const overtimeHours = Math.max(0, workHours - standardHours);
                
                breakdown += `‚òÄÔ∏è Ore normali: ${formatHours(regularHours)} √ó ‚Ç¨${hourlyRate} = ‚Ç¨${(regularHours * hourlyRate).toFixed(2)}<br>`;
                
                if (overtimeHours > 0) {
                    breakdown += `‚ö° Straordinari: ${formatHours(overtimeHours)} √ó ‚Ç¨${hourlyRate} √ó 1.25 = ‚Ç¨${(overtimeHours * hourlyRate * 1.25).toFixed(2)}<br>`;
                }
                
                if (nightHours > 0) {
                    breakdown += `üåô Notturno: ${formatHours(nightHours)} √ó maggiorazione +15%/+55%<br>`;
                }
            }
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            if (breakStart && breakEnd) {
                breakdown += `<br><strong>‚è∏Ô∏è Pausa principale:</strong> ${breakStart} ‚Üí ${breakEnd}<br>`;
            }
            
            if (additionalBreaks.length > 0) {
                const validBreaks = additionalBreaks.filter(br => br.start && br.end);
                if (validBreaks.length > 0) {
                    breakdown += `<strong>‚è∏Ô∏è Pause aggiuntive (${validBreaks.length}):</strong><br>`;
                    validBreaks.forEach((br, index) => {
                        breakdown += `‚Ä¢ Pausa ${index + 2}: ${br.start} ‚Üí ${br.end}<br>`;
                    });
                }
            }
            
            const travelTypeIndex = document.getElementById('travelType').value;
            if (travelTypeIndex !== '') {
                const travelAmount = travelTypes[travelTypeIndex].amount;
                breakdown += `<br>‚úàÔ∏è Trasferta: +‚Ç¨${travelAmount}`;
            }
            
            document.getElementById('calcBreakdown').innerHTML = breakdown;
        }

        function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = new Date(firstDay);
            const dayOfWeek = (firstDay.getDay() + 6) % 7;
            startDate.setDate(startDate.getDate() - dayOfWeek);
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = createCalendarDay(currentDate, month, today);
                calendarGrid.appendChild(dayElement);
            }
        }

        function createCalendarDay(date, currentMonth, today) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dayNumber = date.getDate();
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.getTime() === today.getTime();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            
            if (!isCurrentMonth) dayElement.classList.add('other-month');
            if (isToday) dayElement.classList.add('today');
            if (isWeekend) dayElement.classList.add('weekend');
            if (workData) dayElement.classList.add('has-work');
            
            let dayContent = `<div class="calendar-day-number">${dayNumber}</div>`;
            
            if (workData && isCurrentMonth) {
                let statusIndicator = '';
                let statusColor = '#198754';
                
                if (workData.status === 'in_corso') {
                    statusIndicator = '‚è≥';
                    statusColor = '#ffc107';
                } else if (workData.status === 'incompleto') {
                    statusIndicator = '‚ùå';
                    statusColor = '#dc3545';
                } else {
                    statusIndicator = '‚úÖ';
                }
                
                if (workData.status === 'completo') {
                    dayContent += `
                        <div class="calendar-day-info">
                            <div class="calendar-day-hours">${formatHours(parseFloat(workData.workHours))}</div>
                            <div class="calendar-day-pay">‚Ç¨${workData.dailyPay}</div>
                            ${workData.travelType ? `<div style="color: #ff9800;">‚úàÔ∏è ${workData.travelType}</div>` : ''}
                        </div>
                    `;
                } else {
                    dayContent += `
                        <div class="calendar-day-info">
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 12px;">
                                ${statusIndicator} ${workData.status === 'in_corso' ? 'In corso' : 'Incompleto'}
                            </div>
                            ${workData.entryTime ? `<div style="font-size: 10px;">Da: ${workData.entryTime}</div>` : ''}
                            ${workData.exitTime ? `<div style="font-size: 10px;">A: ${workData.exitTime}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            if (!workData && isCurrentMonth) {
                dayContent += '<button class="calendar-quick-add" onclick="quickAddDay(\'' + dateString + '\')">+</button>';
            }
            
            dayElement.innerHTML = dayContent;
            
            dayElement.addEventListener('click', () => selectCalendarDay(date, dayElement));
            
            return dayElement;
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            generateCalendar();
        }

        function selectCalendarDay(date, element) {
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedCalendarDay = date;
            
            showDayDetails(date);
        }

        function showDayDetails(date) {
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            
            const detailsSection = document.getElementById('dayDetails');
            const detailsContent = document.getElementById('dayDetailsContent');
            
            let content = `<h3>${dayNames[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}</h3>`;
            
            if (workData) {
                if (workData.
