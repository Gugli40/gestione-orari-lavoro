<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Orari Lavorativi Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
            color: #212529;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(139, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .header {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
            background: #f8f9fa;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
            color: #8B0000;
        }

        .tab.active {
            color: #8B0000;
            border-bottom-color: #8B0000;
            background: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: #212529;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .time-input {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .time-input label {
            display: block;
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #212529;
        }

        .btn {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
            background: linear-gradient(135deg, #A0000A 0%, #E6164D 100%);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-success {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #157347 0%, #1aa179 100%);
            box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e83 100%);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #b02a37 0%, #fc616a 100%);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #0dcaf0 0%, #6edff6 100%);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #0aa2c0 0%, #5bc3d4 100%);
            box-shadow: 0 5px 15px rgba(13, 202, 240, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            color: #000;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e55e00 0%, #ffb30d 100%);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .config-item input {
            flex: 1;
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .timesheet-table th, .timesheet-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .timesheet-table th {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .timesheet-table tr:hover {
            background: #f8f9fa;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(139, 0, 0, 0.15);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .summary-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 2.2em;
            font-weight: 700;
        }

        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            border-left: 4px solid #f44336;
        }

        .success {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        .auto-calc {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #8B0000;
            border: 1px solid #e9ecef;
        }

        .auto-calc h4 {
            color: #8B0000;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .calc-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .calc-item .label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 500;
        }

        .calc-item .value {
            font-size: 18px;
            font-weight: 700;
            color: #8B0000;
        }

        /* === STILI CALENDARIO === */
        .calendar-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
        }

        .calendar-day-header {
            padding: 15px 5px;
            text-align: center;
            font-weight: 600;
            color: white;
            font-size: 14px;
        }

        .calendar-day-header.sab {
            background: rgba(255, 152, 0, 0.2);
        }

        .calendar-day-header.dom {
            background: rgba(220, 53, 69, 0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            border-color: #8B0000;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }

        .calendar-day.today {
            background: #fff5f5;
            border: 2px solid #8B0000;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.2);
        }

        .calendar-day.weekend {
            background: #fff8f0;
        }

        .calendar-day.has-work {
            background: #f8fff8;
            border-left: 4px solid #198754;
        }

        .calendar-day.selected {
            background: #fff5f5;
            border: 2px solid #DC143C;
            box-shadow: 0 0 15px rgba(220, 20, 60, 0.3);
        }

        .calendar-day-number {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            color: #212529;
        }

        .calendar-day-info {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.2;
        }

        .calendar-day-hours {
            font-weight: 600;
            color: #198754;
        }

        .calendar-day-pay {
            color: #8B0000;
            font-weight: 600;
        }

        .calendar-quick-add {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #8B0000;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 600;
        }

        .calendar-day:hover .calendar-quick-add {
            opacity: 1;
        }

        .calendar-quick-add:hover {
            background: #DC143C;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .time-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 100px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            
            .calendar-day-number {
                font-size: 14px;
            }
            
            .calendar-day-info {
                font-size: 10px;
            }
            
            /* NOVITÀ v3.0: Responsive Breakdown Straordinari */
            .section div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }
            
            .section div[style*="grid-template-columns: 1fr 1fr"] > div {
                margin-bottom: 20px;
            }
            
            .overtime-item {
                flex-direction: column !important;
                text-align: center;
            }
            
            .overtime-item > div:first-child {
                margin-bottom: 10px;
            }
            
            /* Calcolo finale responsive */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: block !important;
                text-align: center;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] > div {
                margin-bottom: 15px;
                padding: 0 !important;
                border: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💼 Gestione Orari Lavorativi Pro</h1>
            <p>Sistema avanzato per la gestione completa degli orari di lavoro - Versione v3.1 con Filtro Mensile</p>
        </div>

        <div class="content">
            <!-- Sistema di Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('inserimento')">⏰ Inserimento</button>
                <button class="tab" onclick="showTab('calendario')">📅 Calendario</button>
                <button class="tab" onclick="showTab('configurazione')">⚙️ Configurazione</button>
                <button class="tab" onclick="showTab('registro')">📊 Registro</button>
                <button class="tab" onclick="showTab('riepilogo')">📈 Riepilogo</button>
            </div>

            <!-- TAB: Calendario -->
            <div id="tab-calendario" class="tab-content">
                <div class="section">
                    <h2>📅 Calendario Mensile</h2>
                    
                    <!-- Controlli Navigazione -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); border-radius: 8px; color: white;">
                        <button class="btn" onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">⬅️ Precedente</button>
                        <h3 id="calendarTitle" style="margin: 0; font-size: 1.5em; font-weight: 600;">Marzo 2025</h3>
                        <button class="btn" onclick="changeMonth(1)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">Successivo ➡️</button>
                    </div>
                    
                    <!-- Calendario -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header sab">Sab</div>
                            <div class="calendar-day-header dom">Dom</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- I giorni verranno generati dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div style="margin-top: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border-left: 4px solid #8B0000; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #8B0000; font-weight: 600;">📋 Legenda</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #198754; border-radius: 3px; margin-right: 8px;"></span>✅ Giornata completa</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #ffc107; border-radius: 3px; margin-right: 8px;"></span>⏳ Giornata in corso</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #dc3545; border-radius: 3px; margin-right: 8px;"></span>❌ Giornata incompleta</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #8B0000; border-radius: 3px; margin-right: 8px;"></span>Giorno corrente</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #ff9800; border-radius: 3px; margin-right: 8px;"></span>Weekend</div>
                            <div><span style="display: inline-block; width: 15px; height: 15px; background: #adb5bd; border-radius: 3px; margin-right: 8px;"></span>Altro mese</div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px; color: #495057;">
                            <strong>💡 Suggerimento:</strong> Puoi salvare una giornata anche con solo l'orario di entrata per tenerla tracciata. Completa con l'uscita quando finisci di lavorare!
                        </div>
                    </div>
                </div>
                
                <!-- Dettaglio Giorno Selezionato -->
                <div class="section" id="dayDetails" style="display: none;">
                    <h2>📋 Dettaglio Giorno Selezionato</h2>
                    <div id="dayDetailsContent">
                        <!-- Contenuto dinamico -->
                    </div>
                </div>
            </div>

            <!-- TAB: Inserimento Orari -->
            <div id="tab-inserimento" class="tab-content active">
                <div class="section">
                    <h2>⏰ Inserimento Giornata Lavorativa</h2>
                    
                    <!-- Info Base -->
                    <div class="grid grid-2" style="margin-bottom: 25px;">
                        <div class="form-group">
                            <label for="workDate">📅 Data</label>
                            <input type="date" id="workDate">
                        </div>
                        <div class="form-group">
                            <label for="travelType">✈️ Tipo Trasferta</label>
                            <select id="travelType">
                                <option value="">Nessuna</option>
                            </select>
                        </div>
                    </div>

                    <!-- Orari con 4 campi -->
                    <div class="time-grid">
                        <div class="time-input">
                            <label>🟢 Entrata</label>
                            <input type="time" id="entryTime">
                        </div>
                        <div class="time-input">
                            <label>⏸️ Pausa</label>
                            <input type="time" id="breakStart">
                        </div>
                        <div class="time-input">
                            <label>▶️ Rientro</label>
                            <input type="time" id="breakEnd">
                        </div>
                        <div class="time-input">
                            <label>🔴 Uscita</label>
                            <input type="time" id="exitTime">
                        </div>
                    </div>

                    <!-- Pause Aggiuntive -->
                    <div class="section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #17a2b8; font-weight: 600;">⏸️ Pause Aggiuntive</h4>
                            <button type="button" class="btn btn-info btn-small" onclick="addBreak()">➕ Aggiungi Pausa</button>
                        </div>
                        
                        <div id="breaksContainer">
                            <!-- Le pause aggiuntive verranno generate dinamicamente -->
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                <em>Nessuna pausa aggiuntiva. La pausa principale è già inclusa sopra.</em>
                            </div>
                        </div>
                        
                        <div id="breaksSummary" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e9ecef; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>📊 Pause Aggiuntive:</strong></span>
                                <span id="totalBreakTime" style="font-weight: 600; color: #17a2b8;">0h 00m</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calcolo Automatico -->
                    <div class="auto-calc" id="autoCalc" style="display: none;">
                        <h4>📊 Calcolo Automatico Dettagliato</h4>
                        <div class="calc-grid">
                            <div class="calc-item">
                                <div class="label">Tipo Giorno</div>
                                <div class="value" id="calcDayType">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Pausa Totale</div>
                                <div class="value" id="calcBreak">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Ore Lavorate</div>
                                <div class="value" id="calcWork">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Ore Notturne</div>
                                <div class="value" id="calcNight">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Straordinari</div>
                                <div class="value" id="calcOvertime">--</div>
                            </div>
                            <div class="calc-item">
                                <div class="label">Compenso</div>
                                <div class="value" id="calcPay">--</div>
                            </div>
                        </div>
                        <div id="calcBreakdown" style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-size: 12px; color: #666;">
                            <!-- Breakdown dettagliato apparirà qui -->
                        </div>
                    </div>

                    <!-- Note e Azioni -->
                    <div class="grid grid-2" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="notes">📝 Note</label>
                            <input type="text" id="notes" placeholder="Note opzionali...">
                        </div>
                        <div style="display: flex; align-items: end; gap: 10px;">
                            <button class="btn btn-success" onclick="addWorkDay()">➕ Aggiungi Giornata</button>
                            <button class="btn btn-info" onclick="clearForm()">🔄 Pulisci</button>
                        </div>
                    </div>

                    <div id="message"></div>
                </div>
            </div>

            <!-- TAB: Configurazione -->
            <div id="tab-configurazione" class="tab-content">
                <!-- Configurazione Base -->
                <div class="section">
                    <h2>⚙️ Configurazione Base</h2>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="hourlyRate">💰 Paga Oraria (€)</label>
                            <input type="number" id="hourlyRate" value="15" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="standardHours">⏱️ Ore Standard/Giorno</label>
                            <input type="number" id="standardHours" value="8" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="standardBreak">☕ Pausa Standard (min)</label>
                            <input type="number" id="standardBreak" value="60" step="15">
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #198754; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #198754; font-weight: 600;">ℹ️ Maggiorazioni Automatiche Attive</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px; color: #495057;">
                            <div><strong>Feriali oltre 8h:</strong> +25%</div>
                            <div><strong>Sabato 1-3h:</strong> +25%</div>
                            <div><strong>Sabato oltre 3h:</strong> +50%</div>
                            <div><strong>Domenica:</strong> +45%</div>
                            <div><strong>Notturno normale:</strong> +15%</div>
                            <div><strong>Notturno straordinario:</strong> +55%</div>
                        </div>
                    </div>
                </div>

                <!-- Tipi Trasferte -->
                <div class="section">
                    <h2>✈️ Gestione Tipi Trasferte</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label for="newTravelName">Nome Tipo</label>
                                <input type="text" id="newTravelName" placeholder="es. Nazionale, Estero...">
                            </div>
                            <div class="form-group">
                                <label for="newTravelAmount">Importo Fisso (€)</label>
                                <input type="number" id="newTravelAmount" placeholder="15" step="0.50">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button class="btn btn-success" onclick="addTravelType()">➕ Aggiungi</button>
                            </div>
                        </div>
                    </div>
                    <div id="travelList"></div>
                </div>
            </div>

            <!-- TAB: Registro -->
            <div id="tab-registro" class="tab-content">
                <div class="section">
                    <h2>📊 Registro Orari Completo</h2>
                    <div style="overflow-x: auto;">
                        <table class="timesheet-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Entrata</th>
                                    <th>Pausa</th>
                                    <th>Rientro</th>
                                    <th>Uscita</th>
                                    <th>Pause Agg.</th>
                                    <th>Pausa Tot.</th>
                                    <th>Ore Lav.</th>
                                    <th>Straord.</th>
                                    <th>Notturne</th>
                                    <th>Tipo Giorno</th>
                                    <th>Trasferta</th>
                                    <th>Compenso</th>
                                    <th>Note</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="timesheet-body">
                                <!-- Dati inseriti dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: Riepilogo -->
            <div id="tab-riepilogo" class="tab-content">
                <!-- NUOVO: Selettore Mese -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 8px; border-left: 4px solid #4a90e2; border: 1px solid #e9ecef;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label for="monthSelector" style="font-weight: 600; color: #4a90e2; font-size: 16px;">📅 Visualizza mese:</label>
                            <select id="monthSelector" onchange="updateMonthFilter()" style="padding: 10px 15px; border: 2px solid #4a90e2; border-radius: 6px; font-size: 16px; font-weight: 500; background: white; min-width: 200px;">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px; color: #6c757d; font-size: 14px;">
                            <span>📊 Giornate trovate: <strong id="monthDaysCount" style="color: #4a90e2;">0</strong></span>
                            <span>💼 Ore totali: <strong id="monthHoursCount" style="color: #198754;">0h</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards Principale -->
                <div class="summary">
                    <div class="summary-card">
                        <h3>Ore Ordinarie Lavorate</h3>
                        <div class="value" id="regularHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Ore Straordinari</h3>
                        <div class="value" id="overtimeHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Ore Notturne</h3>
                        <div class="value" id="nightHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Giorni Trasferta</h3>
                        <div class="value" id="travelDays">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Totale Mensile</h3>
                        <div class="value" id="monthlyTotal">€0</div>
                    </div>
                </div>

                <!-- NUOVA SEZIONE: Breakdown Dettagliato Straordinari -->
                <div class="section" style="margin-top: 30px;">
                    <div style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <h2 style="margin: 0; color: white; border: none; padding: 0;">⚡ BREAKDOWN DETTAGLIATO STRAORDINARI E MAGGIORAZIONI</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;" id="breakdownSubtitle">Analisi completa di tutti i compensi aggiuntivi del mese</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                        <!-- Colonna Sinistra: Straordinari per Tipo Giorno -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h3 style="color: #8B0000; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #8B0000; padding-bottom: 10px;">📅 Straordinari per Tipo Giorno</h3>
                            
                            <!-- Feriali -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #198754;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🟢 Feriali (oltre 8h) +25%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="weekdayBreakdown">0h 00m × €0.00 × 1.25 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #198754;" id="weekdayAmount">€0.00</div>
                            </div>
                            
                            <!-- Sabato 1-3h -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🟠 Sabato (prime 3h) +25%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="saturdayFirstBreakdown">0h 00m × €0.00 × 1.25 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #ff9800;" id="saturdayFirstAmount">€0.00</div>
                            </div>
                            
                            <!-- Sabato oltre 3h -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff5722;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🔴 Sabato (oltre 3h) +50%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="saturdayRestBreakdown">0h 00m × €0.00 × 1.50 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #ff5722;" id="saturdayRestAmount">€0.00</div>
                            </div>
                            
                            <!-- Domenica -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #dc3545;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🔴 Domenica (tutto) +45%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="sundayBreakdown">0h 00m × €0.00 × 1.45 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #dc3545;" id="sundayAmount">€0.00</div>
                            </div>
                            
                            <!-- Subtotale Straordinari -->
                            <div style="padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 6px; border: 1px solid #2196f3;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #1976d2;">📊 Subtotale Straordinari:</span>
                                    <span style="font-size: 20px; font-weight: 700; color: #1976d2;" id="overtimeSubtotal">€0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Colonna Destra: Maggiorazioni Speciali -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h3 style="color: #8B0000; margin-bottom: 20px; font-size: 1.2em; border-bottom: 2px solid #8B0000; padding-bottom: 10px;">🌙 Maggiorazioni Speciali</h3>
                            
                            <!-- Notturno Normale -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4a90e2;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🌙 Notturno Normale +15%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="nightNormalBreakdown">0h 00m × €0.00 × 0.15 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #4a90e2;" id="nightNormalAmount">€0.00</div>
                            </div>
                            
                            <!-- Notturno Straordinario -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #673ab7;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">🌜 Notturno Straord. +55%</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="nightOvertimeBreakdown">0h 00m × €0.00 × 0.55 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #673ab7;" id="nightOvertimeAmount">€0.00</div>
                            </div>
                            
                            <!-- Trasferte -->
                            <div class="overtime-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #00bcd4;">
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 3px;">✈️ Trasferte</div>
                                    <div style="font-size: 12px; color: #6c757d;" id="travelBreakdown">0 giorni × €0.00 = €0.00</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: #00bcd4;" id="travelAmount">€0.00</div>
                            </div>
                            
                            <!-- Subtotale Maggiorazioni -->
                            <div style="padding: 15px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 6px; border: 1px solid #9c27b0; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #7b1fa2;">🎯 Subtotale Maggiorazioni:</span>
                                    <span style="font-size: 20px; font-weight: 700; color: #7b1fa2;" id="bonusSubtotal">€0.00</span>
                                </div>
                            </div>
                            
                            <!-- Totale Generale Maggiorazioni -->
                            <div style="padding: 15px; background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); border-radius: 6px; border: 1px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #2e7d32;">💰 TOTALE MAGGIORAZIONI:</span>
                                    <span style="font-size: 22px; font-weight: 700; color: #2e7d32;" id="totalBonuses">€0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calcolo Finale -->
                    <div style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; padding: 25px; border-radius: 8px; text-align: center;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">💵 Paga Base:</div>
                                <div style="font-size: 24px; font-weight: 600;" id="basePay">€0.00</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">➕ Maggiorazioni:</div>
                                <div style="font-size: 24px; font-weight: 600;" id="totalBonusesDisplay">€0.00</div>
                            </div>
                            <div style="border-left: 2px solid rgba(255,255,255,0.3); padding-left: 20px;">
                                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">🎯 TOTALE FINALE:</div>
                                <div style="font-size: 32px; font-weight: 700;" id="grandTotal">€0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Azioni -->
                <div class="section">
                    <h2>🔧 Azioni</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="importFromExcelFixed()">📁 Importa Excel</button>
                        <button class="btn btn-success" onclick="exportToExcelFiltered()">📄 Esporta Excel (Mese)</button>
                        <button class="btn btn-warning" onclick="exportToPDFFiltered()">📑 Esporta PDF (Mese)</button>
                        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Cancella Tutto</button>
                        <button class="btn" onclick="saveConfig()">💾 Forza Salvataggio</button>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="safeExcelImport()">🛡️ Import Sicuro</button>
                        <button class="btn btn-warning" onclick="testOvertimeCalculation()">🧪 Test Calcoli</button>
                        <button class="btn" onclick="checkConfigBeforeImport()">🔍 Verifica Config</button>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #ffffff; border-radius: 8px; border-left: 4px solid #0dcaf0; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 10px; color: #0dcaf0; font-weight: 600;">ℹ️ Informazioni v3.1 - Filtro per Mese</h4>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Novità v3.1:</strong> Riepilogo separato per ogni mese + Export per mese selezionato!
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Filtro Mese:</strong> Seleziona il mese per vedere solo le giornate di quel periodo
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Excel/PDF:</strong> Esportano solo i dati del mese selezionato
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Import Sicuro:</strong> Con backup automatico e possibilità rollback
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Test Calcoli:</strong> Verifica il corretto funzionamento degli straordinari
                        </p>
                        <p style="margin: 5px 0; font-size: 14px; color: #495057;">
                            <strong>Nota:</strong> Le configurazioni si salvano automaticamente nel browser (F12 per debug)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === VARIABILI GLOBALI ===
        let workDays = [];
        let travelTypes = [
            { name: 'In Regione', amount: 10 },
            { name: 'Fuori Regione', amount: 15 },
            { name: 'Estero', amount: 25 }
        ];
        
        // Variabili calendario
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;
        
        // Array per pause aggiuntive
        let additionalBreaks = [];
        let breakCounter = 0;

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('🚀 Inizializzazione Gestione Orari Pro v3.1 - Filtro per Mese Attivo');
            
            // Carica configurazione e dati salvati
            const configLoaded = loadConfig();
            const workDaysCount = loadWorkDays();
            
            // Imposta data corrente
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            
            // Inizializza pause aggiuntive
            additionalBreaks = [];
            breakCounter = 0;
            renderBreaks();
            
            // Aggiorna tutti i dropdown e tabelle
            updateTravelDropdown();
            updateTravelList();
            updateTable();
            
            // *** NOVITÀ v3.1: Popola selettore mese e aggiorna riepilogo ***
            populateMonthSelector();
            updateSummary();
            
            generateCalendar();
            
            // Aggiunge listener per calcolo automatico
            addCalculationListeners();
            
            // Aggiunge listener per salvataggio automatico configurazione
            addConfigListeners();
            
            // Mostra messaggio di caricamento
            if (configLoaded || workDaysCount > 0) {
                let message = '✅ ';
                if (configLoaded) message += 'Configurazione caricata';
                if (workDaysCount > 0) {
                    if (message.length > 3) message += ' + ';
                    message += `${workDaysCount} giornate caricate`;
                }
                message += ' dal browser - v3.1 con Filtro per Mese attivo!';
                showMessage(message, 'success');
            }
            
            console.log('📊 Sistema v3.1 pronto - Import Excel corretto + Breakdown Straordinari + Filtro Mensile');
        }

        function addConfigListeners() {
            // Salva automaticamente quando si modificano le impostazioni base
            ['hourlyRate', 'standardHours', 'standardBreak'].forEach(id => {
                document.getElementById(id).addEventListener('change', autoSaveConfig);
            });
        }

        // === GESTIONE PAUSE AGGIUNTIVE ===
        function addBreak() {
            breakCounter++;
            const breakId = `break_${breakCounter}`;
            
            const breakItem = {
                id: breakId,
                start: '',
                end: ''
            };
            
            additionalBreaks.push(breakItem);
            renderBreaks();
            
            // Focus sul primo campo della nuova pausa
            setTimeout(() => {
                document.getElementById(`${breakId}_start`).focus();
            }, 100);
        }
        
        function removeBreak(breakId) {
            additionalBreaks = additionalBreaks.filter(br => br.id !== breakId);
            renderBreaks();
            updateBreaksSummary();
            calculateAutomatic();
        }
        
        function renderBreaks() {
            const container = document.getElementById('breaksContainer');
            
            if (additionalBreaks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        <em>Nessuna pausa aggiuntiva. La pausa principale è già inclusa sopra.</em>
                    </div>
                `;
                document.getElementById('breaksSummary').style.display = 'none';
                return;
            }
            
            let html = '';
            additionalBreaks.forEach((breakItem, index) => {
                html += `
                    <div class="break-item" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef;">
                        <div style="flex: 0 0 auto; font-weight: 600; color: #17a2b8;">
                            Pausa ${index + 2}:
                        </div>
                        <div style="flex: 1; display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                            <div>
                                <label style="font-size: 12px; color: #6c757d; margin-bottom: 5px; display: block;">Inizio</label>
                                <input type="time" id="${breakItem.id}_start" value="${breakItem.start}" 
                                       onchange="updateBreak('${breakItem.id}', 'start', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            </div>
                            <div style="text-align: center; color: #6c757d; font-weight: bold;">→</div>
                            <div>
                                <label style="font-size: 12px; color: #6c757d; margin-bottom: 5px; display: block;">Fine</label>
                                <input type="time" id="${breakItem.id}_end" value="${breakItem.end}"
                                       onchange="updateBreak('${breakItem.id}', 'end', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="flex: 0 0 auto;">
                            <button type="button" class="btn btn-small btn-danger" onclick="removeBreak('${breakItem.id}')" title="Rimuovi pausa">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('breaksSummary').style.display = 'block';
            updateBreaksSummary();
        }
        
        function updateBreak(breakId, field, value) {
            const breakItem = additionalBreaks.find(br => br.id === breakId);
            if (breakItem) {
                breakItem[field] = value;
                updateBreaksSummary();
                calculateAutomatic();
            }
        }
        
        function updateBreaksSummary() {
            let totalMinutes = 0;
            let validBreaks = 0;
            
            additionalBreaks.forEach(breakItem => {
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (end > start) {
                        totalMinutes += (end - start) / (1000 * 60);
                        validBreaks++;
                    }
                }
            });
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            
            document.getElementById('totalBreakTime').textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m`;
            
            const summaryElement = document.getElementById('breaksSummary');
            if (validBreaks > 0) {
                summaryElement.style.borderLeft = '4px solid #28a745';
            } else {
                summaryElement.style.borderLeft = '4px solid #ffc107';
            }
        }
        
        function validateBreaks() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            
            if (!entryTime || !exitTime) return true;
            
            const entry = new Date(`2000-01-01T${entryTime}`);
            let exit = new Date(`2000-01-01T${exitTime}`);
            
            if (exit <= entry) {
                exit = new Date(`2000-01-02T${exitTime}`);
            }
            
            // Valida pausa principale
            if (breakStart && breakEnd) {
                const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (mainBreakEnd <= mainBreakStart) {
                    mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                
                if (mainBreakStart < entry || mainBreakEnd > exit) {
                    return 'La pausa principale deve essere compresa tra entrata e uscita';
                }
            }
            
            // Valida pause aggiuntive
            for (let i = 0; i < additionalBreaks.length; i++) {
                const breakItem = additionalBreaks[i];
                
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (start < entry || end > exit) {
                        return `La pausa aggiuntiva ${i + 1} deve essere compresa tra entrata e uscita`;
                    }
                    
                    // Verifica sovrapposizioni con pausa principale
                    if (breakStart && breakEnd) {
                        const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                        let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                        
                        if (mainBreakEnd <= mainBreakStart) {
                            mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                        }
                        
                        if ((start < mainBreakEnd && end > mainBreakStart)) {
                            return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa principale`;
                        }
                    }
                    
                    // Verifica sovrapposizioni con altre pause aggiuntive
                    for (let j = i + 1; j < additionalBreaks.length; j++) {
                        const otherBreak = additionalBreaks[j];
                        if (otherBreak.start && otherBreak.end) {
                            const otherStart = new Date(`2000-01-01T${otherBreak.start}`);
                            let otherEnd = new Date(`2000-01-01T${otherBreak.end}`);
                            
                            if (otherEnd <= otherStart) {
                                otherEnd = new Date(`2000-01-02T${otherBreak.end}`);
                            }
                            
                            if ((start < otherEnd && end > otherStart)) {
                                return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa aggiuntiva ${j + 1}`;
                            }
                        }
                    }
                }
            }
            
            return true;
        }

        function showTab(tabName) {
            // Nasconde tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra il tab selezionato
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // === GESTIONE TIPI TRASFERTE ===
        function addTravelType() {
            const name = document.getElementById('newTravelName').value.trim();
            const amount = parseFloat(document.getElementById('newTravelAmount').value);
            
            if (!name || isNaN(amount)) {
                showMessage('Compila nome e importo per il tipo trasferta', 'error');
                return;
            }
            
            if (travelTypes.find(type => type.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Tipo trasferta già esistente', 'error');
                return;
            }
            
            travelTypes.push({ name, amount });
            updateTravelDropdown();
            updateTravelList();
            autoSaveConfig();
            
            document.getElementById('newTravelName').value = '';
            document.getElementById('newTravelAmount').value = '';
            
            showMessage('Tipo trasferta aggiunto con successo', 'success');
        }

        function removeTravelType(index) {
            if (confirm('Sei sicuro di voler eliminare questo tipo trasferta?')) {
                travelTypes.splice(index, 1);
                updateTravelDropdown();
                updateTravelList();
                autoSaveConfig();
                showMessage('Tipo trasferta eliminato', 'success');
            }
        }

        function updateTravelDropdown() {
            const select = document.getElementById('travelType');
            select.innerHTML = '<option value="">Nessuna</option>';
            
            travelTypes.forEach((type, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${type.name} (+€${type.amount})`;
                select.appendChild(option);
            });
        }

        function updateTravelList() {
            const container = document.getElementById('travelList');
            container.innerHTML = '';
            
            travelTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <input type="text" value="${type.name}" onchange="updateTravelName(${index}, this.value)" style="flex: 2;">
                    <input type="number" value="${type.amount}" onchange="updateTravelAmount(${index}, this.value)" style="flex: 1;" step="0.50">
                    <span>€</span>
                    <button class="btn btn-small btn-danger" onclick="removeTravelType(${index})">🗑️</button>
                `;
                container.appendChild(item);
            });
        }

        function updateTravelName(index, newName) {
            travelTypes[index].name = newName;
            updateTravelDropdown();
            autoSaveConfig();
        }

        function updateTravelAmount(index, newAmount) {
            travelTypes[index].amount = parseFloat(newAmount) || 0;
            updateTravelDropdown();
            autoSaveConfig();
        }

        // === EXPORT PDF ===
        function exportToPDF() {
            if (workDays.length === 0) {
                showMessage('Non ci sono dati da esportare', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                
                // === INTESTAZIONE ===
                doc.setFontSize(20);
                doc.setTextColor(139, 0, 0);
                doc.text('REGISTRO ORARI LAVORATIVI', pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const today = new Date().toLocaleDateString('it-IT');
                doc.text(`Generato il: ${today}`, pageWidth / 2, 40, { align: 'center' });
                
                // === RIEPILOGO GENERALE ===
                const completeDays = workDays.filter(day => day.status === 'completo');
                const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
                
                // Calcola ore ordinarie (solo feriali entro 8h)
                const regularHours = completeDays.reduce((sum, day) => {
                    const workHours = parseFloat(day.workHours);
                    const dayOfWeek = new Date(day.date).getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) return sum; // Weekend: 0 ore ordinarie
                    return sum + Math.min(workHours, standardHours);
                }, 0);
                
                const overtimeHours = completeDays.reduce((sum, day) => sum + parseFloat(day.overtimeHours), 0);
                const nightHours = completeDays.reduce((sum, day) => sum + parseFloat(day.nightHours || 0), 0);
                const travelDays = completeDays.filter(day => day.travelType).length;
                const monthlyTotal = completeDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);
                
                let yPos = 55;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('RIEPILOGO MENSILE', margin, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                
                const summaryData = [
                    [`Ore Ordinarie Lavorate:`, formatHours(regularHours)],
                    [`Ore Straordinari:`, formatHours(overtimeHours)],
                    [`Ore Notturne:`, formatHours(nightHours)],
                    [`Giorni Trasferta:`, travelDays.toString()],
                    [`TOTALE COMPENSO:`, `€${monthlyTotal.toFixed(2)}`]
                ];
                
                summaryData.forEach(([label, value], index) => {
                    doc.text(label, margin, yPos + (index * 6));
                    doc.setFont(undefined, 'bold');
                    if (index === summaryData.length - 1) {
                        doc.setTextColor(139, 0, 0);
                        doc.setFontSize(12);
                    }
                    doc.text(value, margin + 60, yPos + (index * 6));
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(50, 50, 50);
                    doc.setFontSize(10);
                });
                
                yPos += 45;
                
                const tableData = workDays.map(day => [
                    formatDate(day.date),
                    day.entryTime,
                    day.breakStart || '--',
                    day.breakEnd || '--',
                    day.exitTime,
                    day.breakTime,
                    formatHours(parseFloat(day.workHours)),
                    formatHours(parseFloat(day.overtimeHours)),
                    formatHours(parseFloat(day.nightHours || 0)),
                    day.dayType?.substring(0, 15) || 'Feriale',
                    day.travelType || '--',
                    `€${day.dailyPay}`,
                    (day.notes || '').substring(0, 20)
                ]);
                
                const tableHeaders = [
                    'Data', 'Entrata', 'Pausa', 'Rientro', 'Uscita', 
                    'Pausa Tot.', 'Ore Lav.', 'Straord.', 'Notturne', 
                    'Tipo Giorno', 'Trasferta', 'Compenso', 'Note'
                ];
                
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [139, 0, 0],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 22 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 22 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 18 },
                        5: { cellWidth: 22 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 18 },
                        8: { cellWidth: 18 },
                        9: { cellWidth: 32 },
                        10: { cellWidth: 22 },
                        11: { cellWidth: 22, fontStyle: 'bold' },
                        12: { cellWidth: 30, fontSize: 8 }
                    },
                    didDrawPage: function(data) {
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Pagina ${data.pageNumber}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                        doc.text('Generato con Gestione Orari Lavorativi Pro v3.0 - Breakdown Straordinari', margin, pageHeight - 10);
                    }
                });
                
                const fileName = `registro_orari_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showMessage('PDF generato e scaricato con successo!', 'success');
                
            } catch (error) {
                console.error('Errore export PDF:', error);
                showMessage('Errore nella generazione del PDF: ' + error.message, 'error');
            }
        }

        // === EXPORT EXCEL ===
        function exportToExcel() {
            if (workDays.length === 0) {
                showMessage('Non ci sono dati da esportare', 'error');
                return;
            }

            const exportData = workDays.map(day => ({
                'Data': formatDate(day.date),
                'Entrata': day.entryTime,
                'Pausa': day.breakStart || '--',
                'Rientro': day.breakEnd || '--',
                'Uscita': day.exitTime,
                'Pausa Totale': day.breakTime,
                'Ore Lavorate': formatHours(parseFloat(day.workHours)),
                'Straordinari': formatHours(parseFloat(day.overtimeHours)),
                'Ore Notturne': formatHours(parseFloat(day.nightHours || 0)),
                'Tipo Giorno': day.dayType || 'Feriale',
                'Tipo Trasferta': day.travelType || '--',
                'Compenso (€)': day.dailyPay,
                'Note': day.notes
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            const summary = [
                ['RIEPILOGO MENSILE'],
                [''],
                ['Ore Ordinarie Lavorate:', document.getElementById('regularHours').textContent],
                ['Ore Straordinari:', document.getElementById('overtimeHours').textContent],
                ['Ore Notturne:', document.getElementById('nightHours').textContent],
                ['Giorni Trasferta:', document.getElementById('travelDays').textContent],
                ['Totale Mensile:', document.getElementById('monthlyTotal').textContent]
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Orari Dettagliati');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Riepilogo');

            const fileName = `orari_lavorativi_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('File Excel esportato con successo!', 'success');
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa operazione non può essere annullata.')) {
                workDays = [];
                updateTable();
                populateMonthSelector(); // NOVITÀ v3.1: Aggiorna selettore mese
                updateSummary();
                generateCalendar();
                autoSaveWorkDays();
                showMessage('Tutti i dati sono stati cancellati', 'success');
            }
        }

        // === CALCOLO AUTOMATICO ===
        function addCalculationListeners() {
            const timeInputs = ['entryTime', 'breakStart', 'breakEnd', 'exitTime'];
            const typeInputs = ['travelType'];
            
            timeInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateAutomatic);
            });
            
            typeInputs.forEach(id => {
                document.getElementById(id).addEventListener('change', calculateAutomatic);
            });
        }

        function calculateAutomatic() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            
            const autoCalc = document.getElementById('autoCalc');
            
            if (entryTime && exitTime) {
                const breakValidation = validateBreaks();
                if (breakValidation !== true) {
                    autoCalc.style.display = 'block';
                    document.getElementById('calcDayType').textContent = 'Errore';
                    document.getElementById('calcBreak').textContent = '--';
                    document.getElementById('calcWork').textContent = '--';
                    document.getElementById('calcNight').textContent = '--';
                    document.getElementById('calcOvertime').textContent = '--';
                    document.getElementById('calcPay').textContent = '--';
                    document.getElementById('calcBreakdown').innerHTML = `<strong>❌ Errore:</strong> ${breakValidation}`;
                    return;
                }
                
                autoCalc.style.display = 'block';
                
                const result = calculateWorkHours(entryTime, exitTime);
                
                document.getElementById('calcDayType').textContent = result.dayType || '--';
                document.getElementById('calcBreak').textContent = result.breakTime;
                document.getElementById('calcWork').textContent = formatHours(parseFloat(result.workHours));
                document.getElementById('calcNight').textContent = formatHours(parseFloat(result.nightHours));
                document.getElementById('calcOvertime').textContent = formatHours(parseFloat(result.overtimeHours));
                document.getElementById('calcPay').textContent = '€' + result.dailyPay;
                
                showDetailedBreakdown(result);
            } else if (entryTime || exitTime || additionalBreaks.length > 0) {
                autoCalc.style.display = 'block';
                
                document.getElementById('calcDayType').textContent = entryTime ? 'In corso...' : 'Incompleto';
                document.getElementById('calcBreak').textContent = '--';
                document.getElementById('calcWork').textContent = '--';
                document.getElementById('calcNight').textContent = '--';
                document.getElementById('calcOvertime').textContent = '--';
                document.getElementById('calcPay').textContent = '--';
                
                const statusMsg = entryTime && !exitTime ? 
                    'Giornata in corso - aggiungi l\'uscita per calcolare il totale' :
                    'Compila entrata e uscita per il calcolo automatico';
                    
                document.getElementById('calcBreakdown').innerHTML = 
                    `<strong>ℹ️ Stato:</strong> ${statusMsg}`;
            } else {
                autoCalc.style.display = 'none';
            }
        }

        function showDetailedBreakdown(result) {
            const workDate = new Date(document.getElementById('workDate').value);
            const dayOfWeek = workDate.getDay();
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const workHours = parseFloat(result.workHours);
            const nightHours = parseFloat(result.nightHours);
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            let breakdown = '<strong>📋 Breakdown Calcolo Preciso:</strong><br>';
            
            if (dayOfWeek === 0) {
                breakdown += `🎯 Domenica: ${formatHours(workHours)} × €${hourlyRate} × 1.45 = €${(workHours * hourlyRate * 1.45).toFixed(2)}<br>`;
                breakdown += `ℹ️ Tutte le ore domenicali sono maggiorate del +45%`;
            } else if (dayOfWeek === 6) {
                const firstThree = Math.min(workHours, 3);
                const remaining = Math.max(0, workHours - 3);
                
                breakdown += `🎯 Sabato prime 3h: ${formatHours(firstThree)} × €${hourlyRate} × 1.25 = €${(firstThree * hourlyRate * 1.25).toFixed(2)}<br>`;
                if (remaining > 0) {
                    breakdown += `🎯 Sabato oltre 3h: ${formatHours(remaining)} × €${hourlyRate} × 1.50 = €${(remaining * hourlyRate * 1.50).toFixed(2)}<br>`;
                }
            } else {
                const regularHours = Math.min(workHours, standardHours);
                const overtimeHours = Math.max(0, workHours - standardHours);
                
                breakdown += `☀️ Ore normali: ${formatHours(regularHours)} × €${hourlyRate} = €${(regularHours * hourlyRate).toFixed(2)}<br>`;
                
                if (overtimeHours > 0) {
                    breakdown += `⚡ Straordinari: ${formatHours(overtimeHours)} × €${hourlyRate} × 1.25 = €${(overtimeHours * hourlyRate * 1.25).toFixed(2)}<br>`;
                }
                
                if (nightHours > 0) {
                    breakdown += `🌙 Notturno: ${formatHours(nightHours)} × maggiorazione +15%/+55%<br>`;
                }
            }
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            if (breakStart && breakEnd) {
                breakdown += `<br><strong>⏸️ Pausa principale:</strong> ${breakStart} → ${breakEnd}<br>`;
            }
            
            if (additionalBreaks.length > 0) {
                const validBreaks = additionalBreaks.filter(br => br.start && br.end);
                if (validBreaks.length > 0) {
                    breakdown += `<strong>⏸️ Pause aggiuntive (${validBreaks.length}):</strong><br>`;
                    validBreaks.forEach((br, index) => {
                        breakdown += `• Pausa ${index + 2}: ${br.start} → ${br.end}<br>`;
                    });
                }
            }
            
            const travelTypeIndex = document.getElementById('travelType').value;
            if (travelTypeIndex !== '') {
                const travelAmount = travelTypes[travelTypeIndex].amount;
                breakdown += `<br>✈️ Trasferta: +€${travelAmount}`;
            }
            
            document.getElementById('calcBreakdown').innerHTML = breakdown;
        }

        // === GESTIONE CALENDARIO ===
        function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = new Date(firstDay);
            const dayOfWeek = (firstDay.getDay() + 6) % 7;
            startDate.setDate(startDate.getDate() - dayOfWeek);
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = createCalendarDay(currentDate, month, today);
                calendarGrid.appendChild(dayElement);
            }
        }

        function createCalendarDay(date, currentMonth, today) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dayNumber = date.getDate();
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.getTime() === today.getTime();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            
            if (!isCurrentMonth) dayElement.classList.add('other-month');
            if (isToday) dayElement.classList.add('today');
            if (isWeekend) dayElement.classList.add('weekend');
            if (workData) dayElement.classList.add('has-work');
            
            let dayContent = `<div class="calendar-day-number">${dayNumber}</div>`;
            
            if (workData && isCurrentMonth) {
                let statusIndicator = '';
                let statusColor = '#198754';
                
                if (workData.status === 'in_corso') {
                    statusIndicator = '⏳';
                    statusColor = '#ffc107';
                } else if (workData.status === 'incompleto') {
                    statusIndicator = '❌';
                    statusColor = '#dc3545';
                } else {
                    statusIndicator = '✅';
                }
                
                if (workData.status === 'completo') {
                    dayContent += `
                        <div class="calendar-day-info">
                            <div class="calendar-day-hours">${formatHours(parseFloat(workData.workHours))}</div>
                            <div class="calendar-day-pay">€${workData.dailyPay}</div>
                            ${workData.travelType ? `<div style="color: #ff9800;">✈️ ${workData.travelType}</div>` : ''}
                        </div>
                    `;
                } else {
                    dayContent += `
                        <div class="calendar-day-info">
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 12px;">
                                ${statusIndicator} ${workData.status === 'in_corso' ? 'In corso' : 'Incompleto'}
                            </div>
                            ${workData.entryTime ? `<div style="font-size: 10px;">Da: ${workData.entryTime}</div>` : ''}
                            ${workData.exitTime ? `<div style="font-size: 10px;">A: ${workData.exitTime}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            if (!workData && isCurrentMonth) {
                dayContent += '<button class="calendar-quick-add" onclick="quickAddDay(\'' + dateString + '\')">+</button>';
            }
            
            dayElement.innerHTML = dayContent;
            
            dayElement.addEventListener('click', () => selectCalendarDay(date, dayElement));
            
            return dayElement;
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            generateCalendar();
        }

        function selectCalendarDay(date, element) {
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedCalendarDay = date;
            
            showDayDetails(date);
        }

        function showDayDetails(date) {
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            const dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            
            const detailsSection = document.getElementById('dayDetails');
            const detailsContent = document.getElementById('dayDetailsContent');
            
            let content = `<h3>${dayNames[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}</h3>`;
            
            if (workData) {
                if (workData.status === 'completo') {
                    content += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="summary-card" style="background: #4CAF50;">
                                <h4>✅ Completo</h4>
                                <div style="font-size: 1.2em;">Ore: ${formatHours(parseFloat(workData.workHours))}</div>
                            </div>
                            <div class="summary-card" style="background: #2196f3;">
                                <h4>Compenso</h4>
                                <div style="font-size: 1.5em;">€${workData.dailyPay}</div>
                            </div>
                            <div class="summary-card" style="background: #ff9800;">
                                <h4>Tipo Giorno</h4>
                                <div style="font-size: 1em;">${workData.dayType || 'Feriale'}</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4>📋 Dettagli Orari</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px;">
                                <div><strong>Entrata:</strong> ${workData.entryTime}</div>
                                <div><strong>Pausa:</strong> ${workData.breakStart || '--'}</div>
                                <div><strong>Rientro:</strong> ${workData.breakEnd || '--'}</div>
                                <div><strong>Uscita:</strong> ${workData.exitTime}</div>
                            </div>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                <div><strong>Straordinari:</strong> ${formatHours(parseFloat(workData.overtimeHours))}</div>
                                <div><strong>Ore Notturne:</strong> ${formatHours(parseFloat(workData.nightHours || 0))}</div>
                            </div>
                            ${(() => {
                                let pausesInfo = '';
                                if (workData.additionalBreaks && Array.isArray(workData.additionalBreaks)) {
                                    const validBreaks = workData.additionalBreaks.filter(br => br.start && br.end);
                                    if (validBreaks.length > 0) {
                                        pausesInfo = '<div style="margin-top: 10px;"><strong>Pause aggiuntive:</strong> ' + 
                                            validBreaks.map((br, idx) => `${idx + 2}) ${br.start} → ${br.end}`).join(', ') + '</div>';
                                    }
                                }
                                return pausesInfo;
                            })()}
                            ${workData.notes ? `<div style="margin-top: 10px;"><strong>Note:</strong> ${workData.notes}</div>` : ''}
                        </div>
                    `;
                } else {
                    const statusColor = workData.status === 'in_corso' ? '#ffc107' : '#dc3545';
                    const statusText = workData.status === 'in_corso' ? 'In Corso' : 'Incompleto';
                    const statusIcon = workData.status === 'in_corso' ? '⏳' : '❌';
                    
                    content += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="summary-card" style="background: ${statusColor};">
                                <h4>${statusIcon} ${statusText}</h4>
                                <div style="font-size: 1em;">Da completare</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4>📋 Dati Parziali</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px;">
                                <div><strong>Entrata:</strong> ${workData.entryTime || '--'}</div>
                                <div><strong>Pausa:</strong> ${workData.breakStart || '--'}</div>
                                <div><strong>Rientro:</strong> ${workData.breakEnd || '--'}</div>
                                <div><strong>Uscita:</strong> ${workData.exitTime || '--'}</div>
                            </div>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                <div><strong>Trasferta:</strong> ${workData.travelType || '--'}</div>
                            </div>
                            ${workData.notes ? `<div style="margin-top: 10px;"><strong>Note:</strong> ${workData.notes}</div>` : ''}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${statusColor};">
                            <p style="margin: 0; color: #495057;">
                                <strong>💡 Suggerimento:</strong> 
                                ${workData.status === 'in_corso' ? 
                                    'Aggiungi l\'ora di uscita per completare la giornata e calcolare il compenso.' :
                                    'Aggiungi almeno entrata e uscita per calcolare automaticamente ore e compenso.'
                                }
                            </p>
                        </div>
                    `;
                }
                
                content += `
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="editDay('${dateString}')">✏️ ${workData.status === 'completo' ? 'Modifica' : 'Completa'}</button>
                        <button class="btn btn-danger" onclick="deleteDay('${dateString}')">🗑️ Elimina</button>
                    </div>
                `;
            } else {
                content += `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                        <p style="color: #666; margin-bottom: 15px;">Nessuna giornata lavorativa registrata per questa data.</p>
                        <button class="btn btn-success" onclick="addDayFromCalendar('${dateString}')">➕ Aggiungi Giornata</button>
                    </div>
                `;
            }
            
            detailsContent.innerHTML = content;
            detailsSection.style.display = 'block';
        }

        function quickAddDay(dateString) {
            document.getElementById('workDate').value = dateString;
            showTab('inserimento');
            
            setTimeout(() => {
                document.getElementById('entryTime').focus();
            }, 100);
        }

        function addDayFromCalendar(dateString) {
            quickAddDay(dateString);
        }

        function editDay(dateString) {
            const workData = workDays.find(day => day.date === dateString);
            if (workData) {
                document.getElementById('workDate').value = dateString;
                document.getElementById('entryTime').value = workData.entryTime;
                document.getElementById('breakStart').value = workData.breakStart || '';
                document.getElementById('breakEnd').value = workData.breakEnd || '';
                document.getElementById('exitTime').value = workData.exitTime;
                document.getElementById('notes').value = workData.notes || '';
                
                additionalBreaks = [];
                breakCounter = 0;
                
                if (workData.additionalBreaks && Array.isArray(workData.additionalBreaks)) {
                    workData.additionalBreaks.forEach((br, index) => {
                        if (br.start || br.end) {
                            breakCounter++;
                            additionalBreaks.push({
                                id: `break_${breakCounter}`,
                                start: br.start || '',
                                end: br.end || ''
                            });
                        }
                    });
                }
                
                renderBreaks();
                
                const travelIndex = travelTypes.findIndex(t => t.name === workData.travelType);
                document.getElementById('travelType').value = travelIndex >= 0 ? travelIndex : '';
                
                showTab('inserimento');
                
                calculateAutomatic();
                
                showMessage('Dati caricati per modifica - clicca "Aggiungi Giornata" per salvare le modifiche', 'success');
            }
        }

        function deleteDay(dateString) {
            const index = workDays.findIndex(day => day.date === dateString);
            if (index >= 0) {
                removeWorkDay(index);
                generateCalendar();
                document.getElementById('dayDetails').style.display = 'none';
            }
        }

        function calculateWorkHours(entryTime, exitTime) {
            const entry = new Date(`2000-01-01T${entryTime}`);
            let exit = new Date(`2000-01-01T${exitTime}`);
            
            if (exit <= entry) {
                exit = new Date(`2000-01-02T${exitTime}`);
            }
            
            let totalMinutes = (exit - entry) / (1000 * 60);
            let breakMinutes = 0;
            let breakTime = 'Nessuna';
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            
            if (breakStart && breakEnd) {
                let bStart = new Date(`2000-01-01T${breakStart}`);
                let bEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (bEnd <= bStart) {
                    bEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                
                if (bEnd > bStart) {
                    breakMinutes += (bEnd - bStart) / (1000 * 60);
                }
            }
            
            let additionalBreakMinutes = 0;
            let validAdditionalBreaks = 0;
            
            additionalBreaks.forEach((breakItem) => {
                if (breakItem.start && breakItem.end) {
                    let bStart = new Date(`2000-01-01T${breakItem.start}`);
                    let bEnd = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (bEnd <= bStart) {
                        bEnd = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (bEnd > bStart) {
                        additionalBreakMinutes += (bEnd - bStart) / (1000 * 60);
                        validAdditionalBreaks++;
                    }
                }
            });
            
            breakMinutes += additionalBreakMinutes;
            
            if (breakMinutes > 0) {
                const hours = Math.floor(breakMinutes / 60);
                const minutes = Math.round(breakMinutes % 60);
                
                let pauseDescription = `${hours}h ${minutes}m`;
                if (breakStart && breakEnd && validAdditionalBreaks > 0) {
                    pauseDescription += ` (principale + ${validAdditionalBreaks} aggiuntive)`;
                } else if (breakStart && breakEnd) {
                    pauseDescription += ' (principale)';
                } else if (validAdditionalBreaks > 0) {
                    pauseDescription += ` (${validAdditionalBreaks} aggiuntive)`;
                }
                
                breakTime = pauseDescription;
            }
            
            const workMinutes = totalMinutes - breakMinutes;
            const workHours = workMinutes / 60;
            
            const workDate = new Date(document.getElementById('workDate').value);
            const dayOfWeek = workDate.getDay();
            
            const preciseResult = calculatePreciseHours(entry, exit, workHours);
            
            const result = calculateContractualPay(
                workHours, 
                dayOfWeek, 
                preciseResult.totalNightHours,
                preciseResult.regularNightHours,
                preciseResult.overtimeNightHours
            );
            
            const travelTypeIndex = document.getElementById('travelType').value;
            if (travelTypeIndex !== '') {
                const travelAmount = travelTypes[travelTypeIndex].amount;
                result.dailyPay += travelAmount;
            }
            
            return {
                breakTime,
                workHours: workHours.toFixed(2),
                overtimeHours: result.overtimeHours.toFixed(2),
                dailyPay: result.dailyPay.toFixed(2),
                nightHours: preciseResult.totalNightHours.toFixed(2),
                dayType: result.dayType
            };
        }

        function calculatePreciseHours(entry, exit, totalWorkHours) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            const pausePeriods = [];
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            if (breakStart && breakEnd) {
                let pauseStart = new Date(`2000-01-01T${breakStart}`);
                let pauseEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (pauseEnd <= pauseStart) {
                    pauseEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                if (pauseStart < entry) {
                    pauseStart = new Date(`2000-01-02T${breakStart}`);
                }
                
                pausePeriods.push({ start: pauseStart, end: pauseEnd });
            }
            
            additionalBreaks.forEach(breakItem => {
                if (breakItem.start && breakItem.end) {
                    let pauseStart = new Date(`2000-01-01T${breakItem.start}`);
                    let pauseEnd = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (pauseEnd <= pauseStart) {
                        pauseEnd = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    if (pauseStart < entry) {
                        pauseStart = new Date(`2000-01-02T${breakItem.start}`);
                    }
                    
                    pausePeriods.push({ start: pauseStart, end: pauseEnd });
                }
            });
            
            let currentTime = new Date(entry);
            let workedMinutes = 0;
            let regularNightMinutes = 0;
            let overtimeNightMinutes = 0;
            
            const nightStart = 22 * 60;
            const nightEnd = 6 * 60;
            
            while (currentTime < exit && workedMinutes < totalWorkHours * 60) {
                const inBreak = pausePeriods.some(pause => 
                    currentTime >= pause.start && currentTime < pause.end
                );
                
                if (!inBreak) {
                    const timeMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
                    const isNight = timeMinutes >= nightStart || timeMinutes < nightEnd;
                    
                    const workedHours = workedMinutes / 60;
                    const isRegularTime = workedHours < standardHours;
                    
                    if (isNight) {
                        if (isRegularTime) {
                            regularNightMinutes++;
                        } else {
                            overtimeNightMinutes++;
                        }
                    }
                    
                    workedMinutes++;
                }
                
                currentTime = new Date(currentTime.getTime() + 60000);
            }
            
            return {
                totalNightHours: (regularNightMinutes + overtimeNightMinutes) / 60,
                regularNightHours: regularNightMinutes / 60,
                overtimeNightHours: overtimeNightMinutes / 60
            };
        }

        function calculateContractualPay(workHours, dayOfWeek, totalNightHours, regularNightHours = 0, overtimeNightHours = 0) {
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            let dailyPay = 0;
            let overtimeHours = 0;
            let dayType = '';
            
            if (dayOfWeek === 0) {
                dayType = 'Domenica (+45%)';
                dailyPay = workHours * hourlyRate * 1.45;
                overtimeHours = workHours;
            } else if (dayOfWeek === 6) {
                dayType = 'Sabato';
                const firstThreeHours = Math.min(workHours, 3);
                const remainingHours = Math.max(0, workHours - 3);
                
                dailyPay = firstThreeHours * hourlyRate * 1.25;
                dailyPay += remainingHours * hourlyRate * 1.50;
                overtimeHours = workHours;
                
                if (totalNightHours > 0) {
                    dayType += ' + Notturno';
                    const nightNormalRate = Math.min(totalNightHours, 3) * hourlyRate * 0.15;
                    const nightOvertimeRate = Math.max(0, totalNightHours - 3) * hourlyRate * 0.05;
                    dailyPay += nightNormalRate + nightOvertimeRate;
                }
            } else {
                dayType = 'Feriale';
                
                const regularHours = Math.min(workHours, standardHours);
                overtimeHours = Math.max(0, workHours - standardHours);
                
                const regularDayHours = regularHours - regularNightHours;
                const overtimeDayHours = overtimeHours - overtimeNightHours;
                
                dailyPay += regularDayHours * hourlyRate;
                dailyPay += regularNightHours * hourlyRate * 1.15;
                dailyPay += overtimeDayHours * hourlyRate * 1.25;
                dailyPay += overtimeNightHours * hourlyRate * 1.55;
                
                if (totalNightHours > 0) {
                    if (overtimeNightHours > 0) {
                        dayType += ` + Notturno (+15%/+55%)`;
                    } else {
                        dayType += ` + Notturno (+15%)`;
                    }
                }
            }
            
            return {
                dailyPay,
                overtimeHours,
                dayType
            };
        }

        // === GESTIONE GIORNATE LAVORATIVE ===
        function addWorkDay() {
            const date = document.getElementById('workDate').value;
            const entryTime = document.getElementById('entryTime').value;
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            const exitTime = document.getElementById('exitTime').value;
            const travelTypeIndex = document.getElementById('travelType').value;
            const notes = document.getElementById('notes').value;

            if (!date) {
                showMessage('La data è obbligatoria', 'error');
                return;
            }

            if (entryTime && exitTime) {
                const entry = new Date(`2000-01-01T${entryTime}`);
                let exit = new Date(`2000-01-01T${exitTime}`);
                
                if (exit <= entry) {
                    exit = new Date(`2000-01-02T${exitTime}`);
                }
                
                const breakValidation = validateBreaks();
                if (breakValidation !== true) {
                    showMessage(breakValidation, 'error');
                    return;
                }
            }

            const existingIndex = workDays.findIndex(day => day.date === date);
            if (existingIndex !== -1) {
                if (!confirm('Esiste già un record per questa data. Vuoi sostituirlo?')) {
                    return;
                }
                workDays.splice(existingIndex, 1);
            }

            let workDay = {
                date,
                entryTime: entryTime || '',
                breakStart: breakStart || '',
                breakEnd: breakEnd || '',
                additionalBreaks: JSON.parse(JSON.stringify(additionalBreaks)),
                exitTime: exitTime || '',
                travelType: travelTypeIndex !== '' ? travelTypes[travelTypeIndex].name : '',
                notes: notes || ''
            };

            if (entryTime && exitTime) {
                const result = calculateWorkHours(entryTime, exitTime);
                
                workDay = {
                    ...workDay,
                    breakTime: result.breakTime,
                    workHours: result.workHours,
                    overtimeHours: result.overtimeHours,
                    nightHours: result.nightHours,
                    dayType: result.dayType,
                    dailyPay: result.dailyPay,
                    status: 'completo'
                };
            } else {
                workDay = {
                    ...workDay,
                    breakTime: '--',
                    workHours: '0.00',
                    overtimeHours: '0.00',
                    nightHours: '0.00',
                    dayType: '--',
                    dailyPay: '0.00',
                    status: entryTime ? 'in_corso' : 'incompleto'
                };
            }

            workDays.push(workDay);
            workDays.sort((a, b) => new Date(a.date) - new Date(b.date));

            updateTable();
            populateMonthSelector(); // NOVITÀ v3.1: Aggiorna selettore mese
            updateSummary();
            generateCalendar();
            autoSaveWorkDays();
            clearForm();
            
            const statusText = workDay.status === 'completo' ? 'completa' : 
                              workDay.status === 'in_corso' ? 'in corso' : 'incompleta';
            showMessage(`Giornata ${statusText} salvata con successo!`, 'success');
        }

        function removeWorkDay(index) {
            if (confirm('Sei sicuro di voler eliminare questa giornata?')) {
                workDays.splice(index, 1);
                updateTable();
                populateMonthSelector(); // NOVITÀ v3.1: Aggiorna selettore mese
                updateSummary();
                generateCalendar();
                autoSaveWorkDays();
                showMessage('Giornata eliminata', 'success');
            }
        }

        function clearForm() {
            document.getElementById('entryTime').value = '';
            document.getElementById('breakStart').value = '';
            document.getElementById('breakEnd').value = '';
            document.getElementById('exitTime').value = '';
            document.getElementById('travelType').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('autoCalc').style.display = 'none';
            
            additionalBreaks = [];
            breakCounter = 0;
            renderBreaks();
            
            const currentDate = new Date(document.getElementById('workDate').value);
            currentDate.setDate(currentDate.getDate() + 1);
            document.getElementById('workDate').value = currentDate.toISOString().split('T')[0];
        }

        // === AGGIORNAMENTO VISUALIZZAZIONI ===
        function updateTable() {
            const tbody = document.getElementById('timesheet-body');
            tbody.innerHTML = '';

            workDays.forEach((day, index) => {
                const row = tbody.insertRow();
                
                let rowClass = '';
                let statusIcon = '';
                
                if (day.status === 'in_corso') {
                    rowClass = 'style="background-color: #fff3cd; opacity: 0.8;"';
                    statusIcon = '⏳';
                } else if (day.status === 'incompleto') {
                    rowClass = 'style="background-color: #f8d7da; opacity: 0.7;"';
                    statusIcon = '❌';
                } else {
                    statusIcon = '✅';
                }
                
                let additionalBreaksDisplay = '--';
                if (day.additionalBreaks && Array.isArray(day.additionalBreaks)) {
                    const validBreaks = day.additionalBreaks.filter(br => br.start && br.end);
                    if (validBreaks.length > 0) {
                        additionalBreaksDisplay = validBreaks.map((br, idx) => 
                            `${br.start}-${br.end}`
                        ).join(', ');
                        if (validBreaks.length > 1) {
                            additionalBreaksDisplay = `${validBreaks.length}: ${additionalBreaksDisplay}`;
                        }
                    }
                }
                
                row.innerHTML = `
                    <td ${rowClass}>${statusIcon} ${formatDate(day.date)}</td>
                    <td ${rowClass}>${day.entryTime || '--'}</td>
                    <td ${rowClass}>${day.breakStart || '--'}</td>
                    <td ${rowClass}>${day.breakEnd || '--'}</td>
                    <td ${rowClass}>${day.exitTime || '--'}</td>
                    <td ${rowClass} style="font-size: 12px; max-width: 100px; word-wrap: break-word;">${additionalBreaksDisplay}</td>
                    <td ${rowClass}>${day.breakTime}</td>
                    <td ${rowClass}>${day.status === 'completo' ? formatHours(parseFloat(day.workHours)) : '--'}</td>
                    <td ${rowClass}>${day.status === 'completo' ? formatHours(parseFloat(day.overtimeHours)) : '--'}</td>
                    <td ${rowClass}>${day.status === 'completo' ? formatHours(parseFloat(day.nightHours || 0)) : '--'}</td>
                    <td ${rowClass}><span style="font-size:12px; background:#e3f2fd; padding:2px 6px; border-radius:3px;">${day.dayType || '--'}</span></td>
                    <td ${rowClass}>${day.travelType || '--'}</td>
                    <td ${rowClass}><strong>${day.status === 'completo' ? '€' + day.dailyPay : '--'}</strong></td>
                    <td ${rowClass}>${day.notes}</td>
                    <td ${rowClass}><button class="btn btn-small btn-danger" onclick="removeWorkDay(${index})">🗑️</button></td>
                `;
            });
        }

        // === NUOVE FUNZIONI v3.1: FILTRO PER MESE ===
        
        function populateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            
            if (workDays.length === 0) {
                selector.innerHTML = '<option value="">Nessun dato disponibile</option>';
                return;
            }
            
            // Estrai tutti i mesi univoci dai dati
            const monthsSet = new Set();
            workDays.forEach(day => {
                const date = new Date(day.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthsSet.add(monthKey);
            });
            
            // Converti in array e ordina
            const months = Array.from(monthsSet).sort().reverse(); // Più recenti prima
            
            selector.innerHTML = '';
            
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(parseInt(year), parseInt(month) - 1, 1)
                    .toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                selector.appendChild(option);
            });
            
            // Seleziona il mese più recente
            if (months.length > 0) {
                selector.value = months[0];
            }
            
            console.log('📅 Selettore mese popolato con', months.length, 'mesi:', months);
        }
        
        function updateMonthFilter() {
            console.log('🔄 Aggiornamento filtro mese...');
            updateSummary();
        }
        
        function getFilteredDaysByMonth() {
            const selectedMonth = document.getElementById('monthSelector').value;
            
            if (!selectedMonth) {
                return workDays.filter(day => day.status === 'completo');
            }
            
            const filteredDays = workDays.filter(day => {
                if (day.status !== 'completo') return false;
                
                const date = new Date(day.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                return monthKey === selectedMonth;
            });
            
            console.log(`📊 Filtrati ${filteredDays.length} giorni per mese ${selectedMonth}`);
            return filteredDays;
        }
        
        function getCurrentMonthName() {
            const selectedMonth = document.getElementById('monthSelector').value;
            if (!selectedMonth) return 'Nessun mese selezionato';
            
            const [year, month] = selectedMonth.split('-');
            const monthName = new Date(parseInt(year), parseInt(month) - 1, 1)
                .toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            
            return monthName.charAt(0).toUpperCase() + monthName.slice(1);
        }

        function updateSummary() {
            const completeDays = getFilteredDaysByMonth(); // NOVITÀ: Usa dati filtrati per mese
            const incompleteDays = workDays.filter(day => day.status !== 'completo');
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            // Aggiorna contatori nel selettore mese
            document.getElementById('monthDaysCount').textContent = completeDays.length;
            
            // NUOVO: Calcola ore ordinarie (solo entro le 8h per giorno nei feriali)
            const regularHours = completeDays.reduce((sum, day) => {
                const workHours = parseFloat(day.workHours);
                const dayOfWeek = new Date(day.date).getDay();
                
                // Per weekend, le "ore ordinarie" sono 0 perché tutto è straordinario
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    return sum; // Weekend: 0 ore ordinarie
                }
                
                // Per feriali: massimo 8h ordinarie per giorno
                return sum + Math.min(workHours, standardHours);
            }, 0);
            
            const totalWorkHours = completeDays.reduce((sum, day) => sum + parseFloat(day.workHours), 0);
            const overtimeHours = completeDays.reduce((sum, day) => sum + parseFloat(day.overtimeHours), 0);
            const nightHours = completeDays.reduce((sum, day) => sum + parseFloat(day.nightHours || 0), 0);
            const travelDays = completeDays.filter(day => day.travelType).length;
            const monthlyTotal = completeDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);

            // Aggiorna contatori aggiuntivi
            document.getElementById('monthHoursCount').textContent = formatHours(totalWorkHours);

            // AGGIORNATO: Usa regularHours invece di totalHours
            document.getElementById('regularHours').textContent = formatHours(regularHours);
            document.getElementById('overtimeHours').textContent = formatHours(overtimeHours);
            document.getElementById('nightHours').textContent = formatHours(nightHours);
            document.getElementById('travelDays').textContent = travelDays;
            
            let totalText = '€' + monthlyTotal.toFixed(2);
            if (incompleteDays.length > 0) {
                totalText += ` (${incompleteDays.length} incomp.)`;
            }
            document.getElementById('monthlyTotal').textContent = totalText;
            
            // Aggiorna subtitle del breakdown con il mese corrente
            const currentMonth = getCurrentMonthName();
            document.getElementById('breakdownSubtitle').textContent = 
                `Analisi completa di tutti i compensi aggiuntivi di ${currentMonth}`;
            
            // *** NOVITÀ v3.0: Calcola e aggiorna breakdown dettagliato per il mese ***
            updateOvertimeBreakdown(completeDays);
        }

        // === NUOVE FUNZIONI EXPORT FILTRATE PER MESE v3.1 ===
        
        function exportToExcelFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Non ci sono dati per il mese selezionato da esportare', 'error');
                return;
            }

            const currentMonth = getCurrentMonthName();
            
            const exportData = filteredDays.map(day => ({
                'Data': formatDate(day.date),
                'Entrata': day.entryTime,
                'Pausa': day.breakStart || '--',
                'Rientro': day.breakEnd || '--',
                'Uscita': day.exitTime,
                'Pausa Totale': day.breakTime,
                'Ore Lavorate': formatHours(parseFloat(day.workHours)),
                'Straordinari': formatHours(parseFloat(day.overtimeHours)),
                'Ore Notturne': formatHours(parseFloat(day.nightHours || 0)),
                'Tipo Giorno': day.dayType || 'Feriale',
                'Tipo Trasferta': day.travelType || '--',
                'Compenso (€)': day.dailyPay,
                'Note': day.notes
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Calcola riepilogo per il mese
            const monthlyData = calculateMonthlyTotals(filteredDays);
            
            const summary = [
                [`RIEPILOGO MENSILE - ${currentMonth.toUpperCase()}`],
                [''],
                ['Ore Ordinarie Lavorate:', formatHours(monthlyData.regularHours)],
                ['Ore Straordinari:', formatHours(monthlyData.overtimeHours)],
                ['Ore Notturne:', formatHours(monthlyData.nightHours)],
                ['Giorni Trasferta:', monthlyData.travelDays.toString()],
                ['Totale Mensile:', `€${monthlyData.monthlyTotal.toFixed(2)}`]
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Orari Dettagliati');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Riepilogo');

            const fileName = `orari_${currentMonth.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage(`File Excel per ${currentMonth} esportato con successo!`, 'success');
        }
        
        function exportToPDFFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Non ci sono dati per il mese selezionato da esportare', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const currentMonth = getCurrentMonthName();
                
                // === INTESTAZIONE ===
                doc.setFontSize(20);
                doc.setTextColor(139, 0, 0);
                doc.text(`REGISTRO ORARI - ${currentMonth.toUpperCase()}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const today = new Date().toLocaleDateString('it-IT');
                doc.text(`Generato il: ${today}`, pageWidth / 2, 40, { align: 'center' });
                
                // === RIEPILOGO MENSILE ===
                const monthlyData = calculateMonthlyTotals(filteredDays);
                
                let yPos = 55;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`RIEPILOGO ${currentMonth.toUpperCase()}`, margin, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                
                const summaryData = [
                    [`Ore Ordinarie Lavorate:`, formatHours(monthlyData.regularHours)],
                    [`Ore Straordinari:`, formatHours(monthlyData.overtimeHours)],
                    [`Ore Notturne:`, formatHours(monthlyData.nightHours)],
                    [`Giorni Trasferta:`, monthlyData.travelDays.toString()],
                    [`TOTALE COMPENSO:`, `€${monthlyData.monthlyTotal.toFixed(2)}`]
                ];
                
                summaryData.forEach(([label, value], index) => {
                    doc.text(label, margin, yPos + (index * 6));
                    doc.setFont(undefined, 'bold');
                    if (index === summaryData.length - 1) {
                        doc.setTextColor(139, 0, 0);
                        doc.setFontSize(12);
                    }
                    doc.text(value, margin + 60, yPos + (index * 6));
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(50, 50, 50);
                    doc.setFontSize(10);
                });
                
                yPos += 45;
                
                const tableData = filteredDays.map(day => [
                    formatDate(day.date),
                    day.entryTime,
                    day.breakStart || '--',
                    day.breakEnd || '--',
                    day.exitTime,
                    day.breakTime,
                    formatHours(parseFloat(day.workHours)),
                    formatHours(parseFloat(day.overtimeHours)),
                    formatHours(parseFloat(day.nightHours || 0)),
                    day.dayType?.substring(0, 15) || 'Feriale',
                    day.travelType || '--',
                    `€${day.dailyPay}`,
                    (day.notes || '').substring(0, 20)
                ]);
                
                const tableHeaders = [
                    'Data', 'Entrata', 'Pausa', 'Rientro', 'Uscita', 
                    'Pausa Tot.', 'Ore Lav.', 'Straord.', 'Notturne', 
                    'Tipo Giorno', 'Trasferta', 'Compenso', 'Note'
                ];
                
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [139, 0, 0],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 22 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 22 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 18 },
                        5: { cellWidth: 22 },
                        6: { cellWidth: 20 },
                        7: { cellWidth: 18 },
                        8: { cellWidth: 18 },
                        9: { cellWidth: 32 },
                        10: { cellWidth: 22 },
                        11: { cellWidth: 22, fontStyle: 'bold' },
                        12: { cellWidth: 30, fontSize: 8 }
                    },
                    didDrawPage: function(data) {
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Pagina ${data.pageNumber}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                        doc.text('Generato con Gestione Orari Lavorativi Pro v3.1 - Filtro Mensile', margin, pageHeight - 10);
                    }
                });
                
                const fileName = `registro_${currentMonth.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showMessage(`PDF per ${currentMonth} generato e scaricato con successo!`, 'success');
                
            } catch (error) {
                console.error('Errore export PDF filtrato:', error);
                showMessage('Errore nella generazione del PDF: ' + error.message, 'error');
            }
        }
        
        function calculateMonthlyTotals(filteredDays) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            const regularHours = filteredDays.reduce((sum, day) => {
                const workHours = parseFloat(day.workHours);
                const dayOfWeek = new Date(day.date).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) return sum;
                return sum + Math.min(workHours, standardHours);
            }, 0);
            
            const overtimeHours = filteredDays.reduce((sum, day) => sum + parseFloat(day.overtimeHours), 0);
            const nightHours = filteredDays.reduce((sum, day) => sum + parseFloat(day.nightHours || 0), 0);
            const travelDays = filteredDays.filter(day => day.travelType).length;
            const monthlyTotal = filteredDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);
            
            return {
                regularHours,
                overtimeHours,
                nightHours,
                travelDays,
                monthlyTotal
            };
        }
        
        function updateOvertimeBreakdown(completeDays) {
            console.log('📊 Calcolando breakdown dettagliato straordinari v3.0...');
            
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const breakdown = calculateOvertimeBreakdown(completeDays, hourlyRate);
            
            // Aggiorna tutti gli elementi HTML con i valori calcolati
            populateBreakdownDisplay(breakdown, hourlyRate);
            
            console.log('✅ Breakdown straordinari aggiornato:', breakdown);
        }

        function calculateOvertimeBreakdown(completeDays, hourlyRate) {
            let breakdown = {
                // Straordinari per tipo giorno
                weekdayOvertime: 0,      // Feriali oltre 8h
                saturdayFirst3: 0,       // Sabato prime 3h
                saturdayRest: 0,         // Sabato oltre 3h
                sundayAll: 0,            // Domenica tutto
                
                // Ore notturne
                nightNormal: 0,          // Notturne normali
                nightOvertime: 0,        // Notturne straordinarie
                
                // Trasferte
                travelDays: 0,
                travelAmount: 0,
                
                // Importi calcolati - ORA USANDO LA STESSA LOGICA DI calculateContractualPay()
                amounts: {
                    weekday: 0,          
                    saturdayFirst: 0,    
                    saturdayRest: 0,     
                    sunday: 0,           
                    nightNormal: 0,      
                    nightOvertime: 0,    
                    travel: 0            
                }
            };
            
            completeDays.forEach(day => {
                const workDate = new Date(day.date);
                const dayOfWeek = workDate.getDay();
                const workHours = parseFloat(day.workHours);
                const nightHours = parseFloat(day.nightHours || 0);
                const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
                
                // CORREZIONE: Usa ESATTAMENTE la stessa logica di calculateContractualPay()
                
                if (dayOfWeek === 0) {
                    // DOMENICA: tutto maggiorato +45%
                    breakdown.sundayAll += workHours;
                    breakdown.amounts.sunday += workHours * hourlyRate * 1.45;
                    
                } else if (dayOfWeek === 6) {
                    // SABATO: prime 3h +25%, resto +50%
                    const first3Hours = Math.min(workHours, 3);
                    const restHours = Math.max(0, workHours - 3);
                    
                    breakdown.saturdayFirst3 += first3Hours;
                    breakdown.saturdayRest += restHours;
                    
                    breakdown.amounts.saturdayFirst += first3Hours * hourlyRate * 1.25;
                    breakdown.amounts.saturdayRest += restHours * hourlyRate * 1.50;
                    
                    // Per sabato, aggiungi anche le maggiorazioni notturne se presenti
                    if (nightHours > 0) {
                        const nightNormalRate = Math.min(nightHours, 3) * hourlyRate * 0.15;
                        const nightOvertimeRate = Math.max(0, nightHours - 3) * hourlyRate * 0.05;
                        breakdown.amounts.saturdayFirst += nightNormalRate;
                        breakdown.amounts.saturdayRest += nightOvertimeRate;
                    }
                    
                } else {
                    // FERIALI: USA ESATTAMENTE LA STESSA LOGICA DI calculateContractualPay()
                    const regularHours = Math.min(workHours, standardHours);
                    const overtimeHours = Math.max(0, workHours - standardHours);
                    
                    // Calcola ore notturne usando la stessa logica precisa dell'originale
                    const preciseResult = calculatePreciseHoursForBreakdown(workDate, workHours, nightHours);
                    
                    breakdown.weekdayOvertime += overtimeHours;
                    
                    // CALCOLO IDENTICO a calculateContractualPay()
                    const regularDayHours = regularHours - preciseResult.regularNightHours;
                    const overtimeDayHours = overtimeHours - preciseResult.overtimeNightHours;
                    
                    // Solo gli straordinari feriali (non le ore normali)
                    breakdown.amounts.weekday += overtimeDayHours * hourlyRate * 1.25;
                    breakdown.amounts.weekday += preciseResult.overtimeNightHours * hourlyRate * 1.55;
                    
                    // Maggiorazioni notturne separate (solo bonus aggiuntivi oltre la paga base)
                    breakdown.nightNormal += preciseResult.regularNightHours;
                    breakdown.nightOvertime += preciseResult.overtimeNightHours;
                    
                    breakdown.amounts.nightNormal += preciseResult.regularNightHours * hourlyRate * 0.15;
                    breakdown.amounts.nightOvertime += preciseResult.overtimeNightHours * hourlyRate * 0.55;
                }
                
                // Trasferte (importo fisso)
                if (day.travelType) {
                    breakdown.travelDays++;
                    const travelType = travelTypes.find(t => t.name === day.travelType);
                    if (travelType) {
                        breakdown.travelAmount += travelType.amount;
                        breakdown.amounts.travel += travelType.amount;
                    }
                }
            });
            
            return breakdown;
        }
        
        // NUOVA FUNZIONE: Calcolo preciso identico per il breakdown
        function calculatePreciseHoursForBreakdown(workDate, totalWorkHours, nightHours) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            // Approssimazione: dividi le ore notturne proporzionalmente
            const regularHours = Math.min(totalWorkHours, standardHours);
            const overtimeHours = Math.max(0, totalWorkHours - standardHours);
            
            let regularNightHours = 0;
            let overtimeNightHours = 0;
            
            if (nightHours > 0) {
                // Distribuisci le ore notturne proporzionalmente tra regolari e straordinarie
                const regularRatio = regularHours / totalWorkHours;
                const overtimeRatio = overtimeHours / totalWorkHours;
                
                regularNightHours = nightHours * regularRatio;
                overtimeNightHours = nightHours * overtimeRatio;
            }
            
            return {
                regularNightHours,
                overtimeNightHours
            };
        }

        function populateBreakdownDisplay(breakdown, hourlyRate) {
            // === STRAORDINARI PER TIPO GIORNO (TOTALI EFFETTIVI) ===
            
            // Feriali oltre 8h - TOTALE EFFETTIVO
            document.getElementById('weekdayBreakdown').textContent = 
                `${formatHours(breakdown.weekdayOvertime)} × €${hourlyRate.toFixed(2)} × 1.25 = €${breakdown.amounts.weekday.toFixed(2)}`;
            document.getElementById('weekdayAmount').textContent = `€${breakdown.amounts.weekday.toFixed(2)}`;
            
            // Sabato prime 3h - TOTALE EFFETTIVO
            document.getElementById('saturdayFirstBreakdown').textContent = 
                `${formatHours(breakdown.saturdayFirst3)} × €${hourlyRate.toFixed(2)} × 1.25 = €${breakdown.amounts.saturdayFirst.toFixed(2)}`;
            document.getElementById('saturdayFirstAmount').textContent = `€${breakdown.amounts.saturdayFirst.toFixed(2)}`;
            
            // Sabato oltre 3h - TOTALE EFFETTIVO
            document.getElementById('saturdayRestBreakdown').textContent = 
                `${formatHours(breakdown.saturdayRest)} × €${hourlyRate.toFixed(2)} × 1.50 = €${breakdown.amounts.saturdayRest.toFixed(2)}`;
            document.getElementById('saturdayRestAmount').textContent = `€${breakdown.amounts.saturdayRest.toFixed(2)}`;
            
            // Domenica tutto - TOTALE EFFETTIVO
            document.getElementById('sundayBreakdown').textContent = 
                `${formatHours(breakdown.sundayAll)} × €${hourlyRate.toFixed(2)} × 1.45 = €${breakdown.amounts.sunday.toFixed(2)}`;
            document.getElementById('sundayAmount').textContent = `€${breakdown.amounts.sunday.toFixed(2)}`;
            
            // Subtotale straordinari - SOMMA DEI TOTALI EFFETTIVI
            const overtimeSubtotal = breakdown.amounts.weekday + breakdown.amounts.saturdayFirst + 
                                   breakdown.amounts.saturdayRest + breakdown.amounts.sunday;
            document.getElementById('overtimeSubtotal').textContent = `€${overtimeSubtotal.toFixed(2)}`;
            
            // === MAGGIORAZIONI SPECIALI (SOLO MAGGIORAZIONI) ===
            
            // Notturno normale - SOLO MAGGIORAZIONE
            document.getElementById('nightNormalBreakdown').textContent = 
                `${formatHours(breakdown.nightNormal)} × €${hourlyRate.toFixed(2)} × 0.15 = €${breakdown.amounts.nightNormal.toFixed(2)}`;
            document.getElementById('nightNormalAmount').textContent = `€${breakdown.amounts.nightNormal.toFixed(2)}`;
            
            // Notturno straordinario - SOLO MAGGIORAZIONE
            document.getElementById('nightOvertimeBreakdown').textContent = 
                `${formatHours(breakdown.nightOvertime)} × €${hourlyRate.toFixed(2)} × 0.55 = €${breakdown.amounts.nightOvertime.toFixed(2)}`;
            document.getElementById('nightOvertimeAmount').textContent = `€${breakdown.amounts.nightOvertime.toFixed(2)}`;
            
            // Trasferte - IMPORTO FISSO
            document.getElementById('travelBreakdown').textContent = 
                `${breakdown.travelDays} giorni × €${(breakdown.travelAmount / Math.max(breakdown.travelDays, 1)).toFixed(2)} = €${breakdown.travelAmount.toFixed(2)}`;
            document.getElementById('travelAmount').textContent = `€${breakdown.amounts.travel.toFixed(2)}`;
            
            // Subtotale maggiorazioni (notturne + trasferte)
            const bonusSubtotal = breakdown.amounts.nightNormal + breakdown.amounts.nightOvertime + breakdown.amounts.travel;
            document.getElementById('bonusSubtotal').textContent = `€${bonusSubtotal.toFixed(2)}`;
            
            // TOTALE GENERALE (straordinari + maggiorazioni)
            const totalBonuses = overtimeSubtotal + bonusSubtotal;
            document.getElementById('totalBonuses').textContent = `€${totalBonuses.toFixed(2)}`;
            document.getElementById('totalBonusesDisplay').textContent = `€${totalBonuses.toFixed(2)}`;
            
            // === CALCOLO FINALE CORRETTO - USA I VALORI ESISTENTI ===
            
            // CORREZIONE: Usa i dailyPay già calcolati (che sappiamo essere corretti)
            const completeDays = workDays.filter(day => day.status === 'completo');
            const monthlyTotal = completeDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);
            
            // CALCOLA PAGA BASE SOTTRAENDO LE MAGGIORAZIONI DAI TOTALI ESISTENTI
            let basePay = 0;
            
            completeDays.forEach(day => {
                const workDate = new Date(day.date);
                const dayOfWeek = workDate.getDay();
                const workHours = parseFloat(day.workHours);
                const dailyPayValue = parseFloat(day.dailyPay);
                
                if (dayOfWeek === 0) {
                    // Domenica: paga base = totale / 1.45
                    basePay += (dailyPayValue - (day.travelType ? travelTypes.find(t => t.name === day.travelType)?.amount || 0 : 0)) / 1.45 * hourlyRate;
                } else if (dayOfWeek === 6) {
                    // Sabato: più complesso, ma approssima
                    basePay += workHours * hourlyRate;
                } else {
                    // Feriali: sottrai solo gli straordinari e le maggiorazioni notturne
                    const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
                    const regularHours = Math.min(workHours, standardHours);
                    basePay += regularHours * hourlyRate;
                }
            });
            
            // ALTERNATIVA PIÙ SEMPLICE E SICURA: Calcola come differenza
            const calculatedBasePay = monthlyTotal - totalBonuses;
            
            document.getElementById('basePay').textContent = `€${calculatedBasePay.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `€${monthlyTotal.toFixed(2)}`;
            
            // Verifica perfetta corrispondenza
            console.log('🧮 Verifica calcolo v3.1 CORRETTA con Filtro Mensile:', {
                'Monthly Total (sistema)': monthlyTotal.toFixed(2),
                'Base Pay (calcolata)': calculatedBasePay.toFixed(2),
                'Total Bonuses (breakdown)': totalBonuses.toFixed(2),
                'Somma (base + bonus)': (calculatedBasePay + totalBonuses).toFixed(2),
                'Differenza': Math.abs(monthlyTotal - (calculatedBasePay + totalBonuses)).toFixed(4),
                'MATCH': Math.abs(monthlyTotal - (calculatedBasePay + totalBonuses)) < 0.01 ? '✅ PERFETTO' : '❌ ERRORE'
            });
        }

        // === NUOVE FUNZIONI IMPORT EXCEL CORRETTE ===
        
        // IMPORT EXCEL MIGLIORATO - VERSIONE CORRETTA
        function importFromExcelFixed() {
            console.log('🚀 Avviando import Excel con funzioni corrette...');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log('📁 File selezionato:', file.name);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            console.log('=== STARTING EXCEL IMPORT FIXED ===');
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            console.log('✅ Excel data loaded:', jsonData.length, 'rows');
                            console.log('📋 Sample data:', jsonData[0]);
                            
                            // USA LA NUOVA FUNZIONE processImportedDataFixed
                            processImportedDataFixed(jsonData);
                            
                        } catch (error) {
                            console.error('❌ Errore nella lettura del file Excel:', error);
                            showMessage('Errore nella lettura del file Excel: ' + error.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
        }

        // FUNZIONE PROCESSAMENTO DATI CORRETTA
        function processImportedDataFixed(data) {
            if (!data || data.length === 0) {
                showMessage('File Excel vuoto o formato non riconosciuto', 'error');
                return;
            }

            let importedCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            const errors = [];

            console.log('🔄 Processando', data.length, 'record...');

            data.forEach((row, index) => {
                try {
                    console.log(`\n=== PROCESSING ROW ${index + 1} ===`);
                    console.log('Row data:', row);
                    
                    // USA LA NUOVA FUNZIONE mapYourExcelFormat
                    const mappedRow = mapYourExcelFormat(row, index);
                    
                    if (mappedRow && mappedRow.date && mappedRow.entryTime && mappedRow.exitTime) {
                        // Controlla se la data esiste già
                        const existingIndex = workDays.findIndex(day => day.date === mappedRow.date);
                        if (existingIndex !== -1) {
                            workDays.splice(existingIndex, 1);
                        }
                        
                        workDays.push(mappedRow);
                        importedCount++;
                        console.log('✅ Imported successfully:', mappedRow.date);
                    } else if (mappedRow && mappedRow.date && mappedRow.entryTime && !mappedRow.exitTime) {
                        // Giornata incompleta - importa comunque
                        const existingIndex = workDays.findIndex(day => day.date === mappedRow.date);
                        if (existingIndex !== -1) {
                            workDays.splice(existingIndex, 1);
                        }
                        
                        workDays.push(mappedRow);
                        importedCount++;
                        console.log('⚠️ Imported incomplete day:', mappedRow.date);
                    } else {
                        skippedCount++;
                        errors.push(`Riga ${index + 2}: dati mancanti o non validi`);
                        console.log('❌ Skipped row:', index + 1);
                    }
                } catch (error) {
                    errorCount++;
                    errors.push(`Riga ${index + 2}: ${error.message}`);
                    console.error('Error processing row:', error);
                }
            });

            // Ordina per data
            workDays.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Aggiorna visualizzazione e salva
            updateTable();
            populateMonthSelector(); // NOVITÀ v3.1: Aggiorna selettore mese
            updateSummary();
            generateCalendar();
            autoSaveWorkDays();
            
            // Callback post-import per analisi
            if (window.postImportCallback) {
                setTimeout(window.postImportCallback, 500);
            }
            
            // Mostra risultato dettagliato
            let message = `✅ Import completato: ${importedCount} righe importate`;
            if (skippedCount > 0) {
                message += `, ${skippedCount} saltate`;
            }
            if (errorCount > 0) {
                message += `, ${errorCount} errori`;
                console.log('Errori import:', errors);
            }
            showMessage(message, importedCount > 0 ? 'success' : 'error');
            
            console.log('🎯 Import v3.1 completato - Filtro per mese aggiornato con breakdown dettagliato calcolati correttamente!');
        }

        // NUOVA FUNZIONE specifica per il TUO formato Excel
        function mapYourExcelFormat(row, rowIndex) {
            console.log('🔍 Mapping row with your Excel format...');
            
            // I nomi dei campi ESATTI dal tuo Excel
            const data = row['Data'];
            const entrata = row['Entrata'];
            const pausa = row['Pausa'];  // Inizio pausa
            const rientro = row['Rientro']; // Fine pausa  
            const uscita = row['Uscita'];
            const note = row['Note'] || '';

            console.log('📋 Raw fields:', { data, entrata, pausa, rientro, uscita });

            if (!data) {
                console.log('❌ No date found');
                return null;
            }

            // Converte data da DD/MM/YYYY a YYYY-MM-DD
            let date;
            if (typeof data === 'string' && data.includes('/')) {
                const dateParts = data.split('/');
                if (dateParts.length === 3) {
                    // DD/MM/YYYY → YYYY-MM-DD
                    const day = dateParts[0].padStart(2, '0');
                    const month = dateParts[1].padStart(2, '0');
                    const year = dateParts[2];
                    date = `${year}-${month}-${day}`;
                    console.log('📅 Date converted:', data, '→', date);
                }
            }

            if (!date) {
                console.log('❌ Invalid date format:', data);
                return null;
            }

            // Pulisci gli orari (sono già in formato HH:MM)
            const entryTime = cleanTimeString(entrata);
            const exitTime = cleanTimeString(uscita);
            const breakStart = cleanTimeString(pausa);
            const breakEnd = cleanTimeString(rientro);

            console.log('🕐 Cleaned times:', { entryTime, exitTime, breakStart, breakEnd });

            // Se non c'è entrata, salta
            if (!entryTime) {
                console.log('❌ No entry time found');
                return null;
            }

            // Calcola SOLO se abbiamo entrata E uscita
            if (entryTime && exitTime) {
                // Salva configurazione attuale
                const currentConfig = {
                    date: document.getElementById('workDate').value,
                    breakStart: document.getElementById('breakStart').value,
                    breakEnd: document.getElementById('breakEnd').value,
                    additionalBreaks: [...additionalBreaks]
                };

                try {
                    // Imposta valori temporanei per calcolo
                    document.getElementById('workDate').value = date;
                    document.getElementById('breakStart').value = breakStart || '';
                    document.getElementById('breakEnd').value = breakEnd || '';
                    additionalBreaks = [];

                    // Calcola
                    const result = calculateWorkHours(entryTime, exitTime);
                    
                    console.log('💰 Calculation result:', result);

                    // Ripristina configurazione
                    document.getElementById('workDate').value = currentConfig.date;
                    document.getElementById('breakStart').value = currentConfig.breakStart;
                    document.getElementById('breakEnd').value = currentConfig.breakEnd;
                    additionalBreaks = currentConfig.additionalBreaks;

                    return {
                        date,
                        entryTime,
                        breakStart: breakStart || '',
                        breakEnd: breakEnd || '',
                        additionalBreaks: [],
                        exitTime,
                        breakTime: result.breakTime,
                        workHours: result.workHours,
                        overtimeHours: result.overtimeHours,
                        nightHours: result.nightHours || '0.00',
                        dayType: result.dayType || 'Feriale',
                        travelType: '',
                        dailyPay: result.dailyPay,
                        notes: note,
                        status: 'completo'
                    };

                } catch (error) {
                    console.error('❌ Calcolo fallito:', error);
                    
                    // Ripristina comunque la configurazione
                    document.getElementById('workDate').value = currentConfig.date;
                    document.getElementById('breakStart').value = currentConfig.breakStart;
                    document.getElementById('breakEnd').value = currentConfig.breakEnd;
                    additionalBreaks = currentConfig.additionalBreaks;
                    
                    return null;
                }
            } else {
                // Giornata incompleta
                console.log('⚠️ Incomplete day:', date);
                return {
                    date,
                    entryTime: entryTime || '',
                    breakStart: breakStart || '',
                    breakEnd: breakEnd || '',
                    additionalBreaks: [],
                    exitTime: exitTime || '',
                    breakTime: '--',
                    workHours: '0.00',
                    overtimeHours: '0.00',
                    nightHours: '0.00',
                    dayType: '--',
                    travelType: '',
                    dailyPay: '0.00',
                    notes: note,
                    status: entryTime ? 'in_corso' : 'incompleto'
                };
            }
        }

        // Funzione utility per pulire le stringhe orario
        function cleanTimeString(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') {
                return '';
            }
            
            const cleaned = timeStr.trim();
            
            // Se è già in formato HH:MM, ritorna così com'è
            if (cleaned.match(/^\d{1,2}:\d{2}$/)) {
                return cleaned;
            }
            
            // Se è vuoto o contiene solo "-", ritorna vuoto
            if (cleaned === '' || cleaned === '-' || cleaned === '--') {
                return '';
            }
            
            return cleaned;
        }

        // === FUNZIONI DI TEST E DEBUG ===
        
        // FUNZIONE per verificare la configurazione prima dell'import
        function checkConfigBeforeImport() {
            console.log('=== CONFIGURAZIONE ATTUALE ===');
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
            const standardHours = parseFloat(document.getElementById('standardHours').value);
            const standardBreak = parseFloat(document.getElementById('standardBreak').value);
            
            console.log('💰 Paga oraria:', hourlyRate);
            console.log('⏱️ Ore standard:', standardHours);
            console.log('☕ Pausa standard:', standardBreak, 'min');
            console.log('✈️ Tipi trasferta:', travelTypes);
            
            // Verifica se la configurazione è realistica
            if (hourlyRate < 5 || hourlyRate > 100) {
                console.warn('⚠️ Paga oraria sembra anomala:', hourlyRate);
            }
            
            if (standardHours !== 8) {
                console.warn('⚠️ Ore standard diverse da 8:', standardHours);
            }
            
            const isValid = hourlyRate > 0 && standardHours > 0;
            
            showMessage(`Configurazione ${isValid ? 'valida' : 'NON valida'} - Paga: €${hourlyRate}/h, Ore: ${standardHours}h`, 
                       isValid ? 'success' : 'error');
            
            return {
                hourlyRate: hourlyRate,
                standardHours: standardHours,
                isValid: isValid
            };
        }

        // FUNZIONE per testare il calcolo degli straordinari
        function testOvertimeCalculation() {
            console.log('=== 🧪 TEST CALCOLO STRAORDINARI ===');
            
            // Salva configurazione attuale
            const originalConfig = {
                hourlyRate: document.getElementById('hourlyRate').value,
                standardHours: document.getElementById('standardHours').value,
                standardBreak: document.getElementById('standardBreak').value
            };
            
            // Imposta configurazione test
            document.getElementById('hourlyRate').value = '15';
            document.getElementById('standardHours').value = '8';
            document.getElementById('standardBreak').value = '60';
            
            // Test cases
            const testCases = [
                {
                    name: 'Giorno normale 8h',
                    date: '2024-03-15', // Venerdì
                    entry: '09:00',
                    exit: '18:00',
                    breakStart: '13:00',
                    breakEnd: '14:00',
                    expectedWork: 8,
                    expectedOvertime: 0
                },
                {
                    name: 'Giorno con straordinari 10h',
                    date: '2024-03-15', // Venerdì
                    entry: '08:00',
                    exit: '19:00',
                    breakStart: '13:00',
                    breakEnd: '14:00',
                    expectedWork: 10,
                    expectedOvertime: 2
                },
                {
                    name: 'Sabato 6h',
                    date: '2024-03-16', // Sabato
                    entry: '09:00',
                    exit: '16:00',
                    breakStart: '12:00',
                    breakEnd: '13:00',
                    expectedWork: 6,
                    expectedOvertime: 6 // Tutto straordinario nei weekend
                }
            ];
            
            testCases.forEach(testCase => {
                console.log(`\n--- 🧪 Test: ${testCase.name} ---`);
                
                // Imposta valori test
                document.getElementById('workDate').value = testCase.date;
                document.getElementById('breakStart').value = testCase.breakStart;
                document.getElementById('breakEnd').value = testCase.breakEnd;
                additionalBreaks = [];
                
                // Calcola
                const result = calculateWorkHours(testCase.entry, testCase.exit);
                
                // Verifica risultati
                const actualWork = parseFloat(result.workHours);
                const actualOvertime = parseFloat(result.overtimeHours);
                
                console.log(`📊 Ore lavorate: ${actualWork} (atteso: ${testCase.expectedWork})`);
                console.log(`⚡ Straordinari: ${actualOvertime} (atteso: ${testCase.expectedOvertime})`);
                console.log(`🏷️ Tipo giorno: ${result.dayType}`);
                console.log(`💰 Compenso: €${result.dailyPay}`);
                
                // Controlli
                if (Math.abs(actualWork - testCase.expectedWork) > 0.01) {
                    console.error(`❌ ERRORE: Ore lavorate sbagliate!`);
                } else {
                    console.log(`✅ Ore lavorate corrette`);
                }
                
                if (Math.abs(actualOvertime - testCase.expectedOvertime) > 0.01) {
                    console.error(`❌ ERRORE: Straordinari sbagliati!`);
                } else {
                    console.log(`✅ Straordinari corretti`);
                }
            });
            
            // Ripristina configurazione originale
            document.getElementById('hourlyRate').value = originalConfig.hourlyRate;
            document.getElementById('standardHours').value = originalConfig.standardHours;
            document.getElementById('standardBreak').value = originalConfig.standardBreak;
            
            console.log('\n=== 🏁 FINE TEST v3.1 ===');
            showMessage('Test calcolo straordinari v3.1 completato - controlla la console (F12) e il breakdown dettagliato per mese', 'success');
        }

        // FUNZIONE per confrontare i risultati prima/dopo
        function compareImportResults() {
            const beforeImport = [...workDays]; // Copia dei dati attuali
            
            return function(afterImport) {
                console.log('=== 📊 CONFRONTO RISULTATI IMPORT ===');
                console.log('Prima:', beforeImport.length, 'record');
                console.log('Dopo:', afterImport.length, 'record');
                
                const beforeTotal = beforeImport.reduce((sum, day) => sum + parseFloat(day.overtimeHours || 0), 0);
                const afterTotal = afterImport.reduce((sum, day) => sum + parseFloat(day.overtimeHours || 0), 0);
                
                console.log('⚡ Straordinari prima:', beforeTotal.toFixed(2), 'ore');
                console.log('⚡ Straordinari dopo:', afterTotal.toFixed(2), 'ore');
                console.log('📈 Differenza:', (afterTotal - beforeTotal).toFixed(2), 'ore');
                
                // Mostra record cambiati
                afterImport.forEach(newDay => {
                    const oldDay = beforeImport.find(d => d.date === newDay.date);
                    if (!oldDay) {
                        console.log('✅ Nuovo record:', newDay.date, '- Straordinari:', newDay.overtimeHours);
                    } else if (oldDay.overtimeHours !== newDay.overtimeHours) {
                        console.log('🔄 Modificato:', newDay.date, 
                                   '- Prima:', oldDay.overtimeHours, 
                                   '- Dopo:', newDay.overtimeHours);
                    }
                });
            };
        }

        // PROCEDURA COMPLETA di import sicuro
        function safeExcelImport() {
            console.log('=== 🛡️ IMPORT SICURO EXCEL v3.1 ===');
            
            // 1. Controlla configurazione
            const config = checkConfigBeforeImport();
            if (!config.isValid) {
                alert('⚠️ Controlla la configurazione prima di importare (paga oraria e ore standard)');
                return;
            }
            
            // 2. Backup dei dati attuali
            const backup = [...workDays];
            const compareFunction = compareImportResults();
            
            // 3. Procedi con import
            console.log('✅ Configurazione OK, procedendo con import...');
            showMessage('Import sicuro avviato - backup creato automaticamente', 'success');
            
            // Usa la versione corretta dell'import
            importFromExcelFixed();
            
            // 4. Dopo l'import (questa funzione sarà chiamata da processImportedDataFixed)
            window.postImportCallback = function() {
                compareFunction(workDays);
                
                // Opzione per ripristinare
                window.rollbackImport = function() {
                    workDays.length = 0;
                    workDays.push(...backup);
                    updateTable();
                    populateMonthSelector(); // NOVITÀ v3.1: Aggiorna selettore mese
                    updateSummary();
                    generateCalendar();
                    autoSaveWorkDays();
                    showMessage('✅ Import annullato - dati ripristinati dal backup', 'success');
                };
                
                console.log('💡 Per annullare l\'import: rollbackImport()');
                showMessage('Import v3.1 completato! Per annullare usa rollbackImport() nella console', 'success');
            };
        }

        // === UTILITY ===
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            
            if (minutes === 60) {
                return `${hours + 1}h 00m`;
            }
            
            return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        }

        function dateToString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // === SISTEMA DI PERSISTENZA COMPLETO ===
        function saveConfig() {
            const config = {
                hourlyRate: document.getElementById('hourlyRate').value,
                standardHours: document.getElementById('standardHours').value,
                standardBreak: document.getElementById('standardBreak').value,
                travelTypes: travelTypes
            };
            
            try {
                localStorage.setItem('timesheetConfig', JSON.stringify(config));
                showMessage('✅ Configurazione salvata manualmente', 'success');
            } catch (e) {
                showMessage('❌ Salvataggio non disponibile in questo ambiente (funziona in locale)', 'error');
            }
        }

        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('timesheetConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    document.getElementById('hourlyRate').value = config.hourlyRate || 15;
                    document.getElementById('standardHours').value = config.standardHours || 8;
                    document.getElementById('standardBreak').value = config.standardBreak || 60;
                    
                    if (config.travelTypes) {
                        travelTypes = config.travelTypes;
                    }
                    
                    return true;
                }
            } catch (e) {
                console.log('Errore nel caricamento configurazione:', e);
            }
            return false;
        }

        function autoSaveConfig() {
            setTimeout(() => {
                const config = {
                    hourlyRate: document.getElementById('hourlyRate').value,
                    standardHours: document.getElementById('standardHours').value,
                    standardBreak: document.getElementById('standardBreak').value,
                    travelTypes: travelTypes
                };
                
                try {
                    localStorage.setItem('timesheetConfig', JSON.stringify(config));
                } catch (e) {
                    // Silenzioso in caso di errore
                }
            }, 500);
        }

        function loadWorkDays() {
            try {
                const savedWorkDays = localStorage.getItem('timesheetWorkDays');
                if (savedWorkDays) {
                    workDays = JSON.parse(savedWorkDays);
                    return workDays.length;
                }
            } catch (e) {
                console.log('Errore nel caricamento dati registro:', e);
            }
            return 0;
        }

        function autoSaveWorkDays() {
            setTimeout(() => {
                try {
                    localStorage.setItem('timesheetWorkDays', JSON.stringify(workDays));
                } catch (e) {
                    // Silenzioso in caso di errore
                }
            }, 100);
        }
    </script>
</body>
</html>
