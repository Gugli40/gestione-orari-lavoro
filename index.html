<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B0000">
    <meta name="description" content="Gestione professionale orari lavorativi mobile-first">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Orari Lavoro Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #8B0000;
            --primary-light: #DC143C;
            --secondary: #198754;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border: #e9ecef;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            padding-bottom: 70px;
            line-height: 1.5;
        }

        /* TOP HEADER - Mobile First */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 12px 16px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .top-header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .top-header p {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* MAIN CONTENT AREA */
        .content-wrapper {
            margin-top: 80px;
            padding: 0 0 20px 0;
            min-height: calc(100vh - 150px);
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARD SYSTEM */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin: 12px 12px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* FORM INPUTS - Mobile Optimized */
        .form-row {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg-card);
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1);
        }

        /* TIME INPUTS - Big and Touch Friendly */
        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 16px 0;
        }

        .time-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            min-width: 0;
            overflow: hidden;
        }

        .time-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .time-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        .time-card input[type="time"] {
            width: 100%;
            padding: 8px 4px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            background: white;
            box-sizing: border-box;
        }

        /* BUTTONS - Large and Touch Friendly */
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e83 100%);
            color: white;
        }

        .btn-small {
            padding: 12px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        /* FLOATING ACTION BUTTON */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            font-size: 32px;
            box-shadow: 0 8px 24px rgba(139, 0, 0, 0.4);
            cursor: pointer;
            z-index: 90;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab.hidden {
            display: none;
        }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        /* SUMMARY CARDS */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }

        .summary-card.full {
            grid-column: 1 / -1;
        }

        .summary-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* CALENDAR - Mobile Optimized */
        .calendar-header-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            margin: 0 16px;
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 700;
        }

        .calendar-nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 16px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            padding: 12px 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .calendar-day.today {
            border-color: var(--primary);
            background: #fff5f5;
        }

        .calendar-day.has-work {
            background: #f0fdf4;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 700;
        }

        .calendar-day-indicator {
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
            margin-top: 4px;
        }

        /* LIST ITEMS */
        .list-item {
            background: var(--bg-card);
            padding: 16px;
            margin: 8px 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .list-item-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d1f4e0;
            color: #0f5132;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #842029;
        }

        /* MESSAGES */
        .message {
            position: fixed;
            top: 90px;
            left: 16px;
            right: 16px;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 200;
            animation: slideDown 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message.success {
            background: #d1f4e0;
            color: #0f5132;
            border-left: 4px solid #198754;
        }

        .message.error {
            background: #f8d7da;
            color: #842029;
            border-left: 4px solid #dc3545;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            font-weight: 600;
        }

        /* BREAKDOWN SECTION */
        .breakdown-item {
            background: var(--bg-card);
            padding: 16px;
            margin: 8px 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .breakdown-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .breakdown-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .breakdown-detail {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* MODAL/OVERLAY */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .overlay.active {
            display: block;
        }

        .modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            z-index: 160;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal.active {
            transform: translateY(0);
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        /* DESKTOP FALLBACK */
        @media (min-width: 768px) {
            body {
                max-width: 480px;
                margin: 0 auto;
                box-shadow: 0 0 40px rgba(0,0,0,0.1);
            }
        }

        /* HIDDEN ELEMENTS */
        .hidden {
            display: none !important;
        }

        /* PAUSE MANAGEMENT */
        .pause-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid var(--border);
        }

        .pause-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pause-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
        }

        /* TABLE RESPONSIVE */
        .table-scroll {
            overflow-x: auto;
            margin: 0 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            font-size: 13px;
        }

        table th {
            background: var(--primary);
            color: white;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
            font-size: 12px;
        }

        table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* DIVIDER */
        .divider {
            height: 12px;
            background: transparent;
        }

        /* SECTION PADDING */
        .section {
            padding: 0;
        }

        /* CALCULATION PREVIEW */
        .calc-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }

        .calc-preview-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calc-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .calc-preview-item {
            text-align: center;
        }

        .calc-preview-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calc-preview-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- TOP HEADER -->
    <div class="top-header">
        <h1>Orari Lavoro Pro</h1>
        <p>Gestione completa orari e compensi</p>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content-wrapper">
        <!-- TAB: INSERIMENTO -->
        <div id="tab-inserimento" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📅 Data e Trasferta</div>
                </div>
                <div class="form-row">
                    <label class="form-label">Data</label>
                    <input type="date" id="workDate" class="form-input">
                </div>
                <div class="form-row">
                    <label class="form-label">Tipo Trasferta</label>
                    <select id="travelType" class="form-select">
                        <option value="">Nessuna</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">⏰ Orari</div>
                </div>
                <div class="time-grid">
                    <div class="time-card">
                        <span class="time-label">🟢 Entrata</span>
                        <input type="time" id="entryTime">
                    </div>
                    <div class="time-card">
                        <span class="time-label">⏸️ Pausa</span>
                        <input type="time" id="breakStart">
                    </div>
                    <div class="time-card">
                        <span class="time-label">▶️ Rientro</span>
                        <input type="time" id="breakEnd">
                    </div>
                    <div class="time-card">
                        <span class="time-label">🔴 Uscita</span>
                        <input type="time" id="exitTime">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">⏸️ Pause Extra</div>
                    <button class="btn btn-small btn-secondary" onclick="addBreak()">+ Aggiungi</button>
                </div>
                <div id="breaksContainer">
                    <div class="empty-state">
                        <div class="empty-state-text">Nessuna pausa aggiuntiva</div>
                    </div>
                </div>
                <div id="breaksSummary" class="hidden">
                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 12px;">
                        <span style="font-weight: 600;">Totale pause extra: </span>
                        <span id="totalBreakTime" style="color: var(--primary); font-weight: 700;">0h 00m</span>
                    </div>
                </div>
            </div>

            <div id="autoCalc" class="calc-preview hidden">
                <div class="calc-preview-title">📊 Anteprima Calcolo</div>
                <div class="calc-preview-grid">
                    <div class="calc-preview-item">
                        <div class="calc-preview-label">Ore Lavoro</div>
                        <div class="calc-preview-value" id="calcWork">--</div>
                    </div>
                    <div class="calc-preview-item">
                        <div class="calc-preview-label">Straordinari</div>
                        <div class="calc-preview-value" id="calcOvertime">--</div>
                    </div>
                    <div class="calc-preview-item">
                        <div class="calc-preview-label">Ore Notturne</div>
                        <div class="calc-preview-value" id="calcNight">--</div>
                    </div>
                    <div class="calc-preview-item">
                        <div class="calc-preview-label">Compenso</div>
                        <div class="calc-preview-value" id="calcPay">--</div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                    <strong>Tipo:</strong> <span id="calcDayType">--</span><br>
                    <strong>Pausa:</strong> <span id="calcBreak">--</span>
                </div>
                <div id="calcBreakdown" style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-size: 12px; color: var(--text-secondary);"></div>
            </div>

            <div class="card">
                <div class="form-row">
                    <label class="form-label">Note (opzionali)</label>
                    <input type="text" id="notes" class="form-input" placeholder="Aggiungi una nota...">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addWorkDay()">✓ Salva</button>
                    <button class="btn btn-secondary" onclick="clearForm()">⟲ Pulisci</button>
                </div>
            </div>

            <div id="message"></div>
        </div>

        <!-- TAB: CALENDARIO -->
        <div id="tab-calendario" class="tab-content">
            <div class="calendar-header-nav">
                <button class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
                <div class="calendar-title" id="calendarTitle">Marzo 2025</div>
                <button class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
            </div>

            <div class="calendar-grid">
                <div class="calendar-day-header">L</div>
                <div class="calendar-day-header">M</div>
                <div class="calendar-day-header">M</div>
                <div class="calendar-day-header">G</div>
                <div class="calendar-day-header">V</div>
                <div class="calendar-day-header">S</div>
                <div class="calendar-day-header">D</div>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>

            <div class="divider"></div>

            <div id="dayDetails" class="card hidden">
                <div id="dayDetailsContent"></div>
            </div>
        </div>

        <!-- TAB: CONFIGURAZIONE -->
        <div id="tab-configurazione" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">⚙️ Parametri Base</div>
                </div>
                <div class="form-row">
                    <label class="form-label">Paga Oraria (€)</label>
                    <input type="number" id="hourlyRate" class="form-input" value="15" step="0.01">
                </div>
                <div class="form-row">
                    <label class="form-label">Ore Standard/Giorno</label>
                    <input type="number" id="standardHours" class="form-input" value="8" step="0.5">
                </div>
                <div class="form-row">
                    <label class="form-label">Pausa Standard (minuti)</label>
                    <input type="number" id="standardBreak" class="form-input" value="60" step="15">
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ℹ️ Maggiorazioni Auto</div>
                </div>
                <div style="font-size: 13px; line-height: 1.8;">
                    <div style="margin-bottom: 8px;"><strong>Feriali oltre 8h:</strong> +25%</div>
                    <div style="margin-bottom: 8px;"><strong>Sabato 1-3h:</strong> +25%</div>
                    <div style="margin-bottom: 8px;"><strong>Sabato oltre 3h:</strong> +50%</div>
                    <div style="margin-bottom: 8px;"><strong>Domenica:</strong> +45%</div>
                    <div style="margin-bottom: 8px;"><strong>Notturno normale:</strong> +15%</div>
                    <div style="margin-bottom: 8px;"><strong>Notturno straord.:</strong> +55%</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">✈️ Trasferte</div>
                </div>
                <div class="form-row">
                    <label class="form-label">Nome Tipo</label>
                    <input type="text" id="newTravelName" class="form-input" placeholder="es. Nazionale">
                </div>
                <div class="form-row">
                    <label class="form-label">Importo Fisso (€)</label>
                    <input type="number" id="newTravelAmount" class="form-input" placeholder="15" step="0.50">
                </div>
                <button class="btn btn-success" onclick="addTravelType()">+ Aggiungi Tipo Trasferta</button>
                <div class="divider"></div>
                <div id="travelList"></div>
            </div>

            <div class="card">
                <button class="btn btn-primary" onclick="saveConfig()">💾 Salva Configurazione</button>
            </div>
        </div>

        <!-- TAB: REGISTRO -->
        <div id="tab-registro" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Tutte le Giornate</div>
                    <div class="card-badge" id="totalDaysCount">0</div>
                </div>
            </div>

            <div id="workDaysList"></div>

            <div class="empty-state" id="emptyRegistry" style="display: none;">
                <div class="empty-state-icon">📋</div>
                <div class="empty-state-text">Nessuna giornata registrata</div>
            </div>
        </div>

        <!-- TAB: RIEPILOGO -->
        <div id="tab-riepilogo" class="tab-content">
            <div class="card">
                <div class="form-row">
                    <label class="form-label">📅 Seleziona Mese</label>
                    <select id="monthSelector" class="form-select" onchange="updateMonthFilter()">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                    <span>Giornate: <strong id="monthDaysCount">0</strong></span>
                    <span>Ore totali: <strong id="monthHoursCount">0h</strong></span>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Ore Ordinarie</div>
                    <div class="summary-value" id="regularHours">0h</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Straordinari</div>
                    <div class="summary-value" id="overtimeHours">0h</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Ore Notturne</div>
                    <div class="summary-value" id="nightHours">0h</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Trasferte</div>
                    <div class="summary-value" id="travelDays">0</div>
                </div>
                <div class="summary-card full">
                    <div class="summary-label">💰 TOTALE MENSILE</div>
                    <div class="summary-value" id="monthlyTotal">€0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">⚡ Breakdown Dettagliato</div>
                </div>
                <div id="breakdownSubtitle" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Analisi compensi aggiuntivi
                </div>

                <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; margin-bottom: 12px; color: var(--primary);">📅 Straordinari per Tipo</div>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🟢 Feriali (+25%)</div>
                            <div class="breakdown-value" id="weekdayAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="weekdayBreakdown">0h 00m × €0.00 × 1.25</div>
                    </div>

                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🟠 Sab 1-3h (+25%)</div>
                            <div class="breakdown-value" id="saturdayFirstAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="saturdayFirstBreakdown">0h 00m × €0.00 × 1.25</div>
                    </div>

                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🔴 Sab 3h+ (+50%)</div>
                            <div class="breakdown-value" id="saturdayRestAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="saturdayRestBreakdown">0h 00m × €0.00 × 1.50</div>
                    </div>

                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🔴 Domenica (+45%)</div>
                            <div class="breakdown-value" id="sundayAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="sundayBreakdown">0h 00m × €0.00 × 1.45</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; margin-bottom: 12px; color: var(--primary);">🌙 Maggiorazioni Speciali</div>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🌙 Nott. Normale (+15%)</div>
                            <div class="breakdown-value" id="nightNormalAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="nightNormalBreakdown">0h 00m × €0.00 × 0.15</div>
                    </div>

                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">🌜 Nott. Straord. (+55%)</div>
                            <div class="breakdown-value" id="nightOvertimeAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="nightOvertimeBreakdown">0h 00m × €0.00 × 0.55</div>
                    </div>

                    <div class="breakdown-item">
                        <div class="breakdown-header">
                            <div class="breakdown-label">✈️ Trasferte</div>
                            <div class="breakdown-value" id="travelAmount">€0</div>
                        </div>
                        <div class="breakdown-detail" id="travelBreakdown">0 giorni</div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #d1f4e0 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 13px; margin-bottom: 8px; font-weight: 600;">💰 Paga Base</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 16px;" id="basePay">€0</div>
                    <div style="font-size: 13px; margin-bottom: 8px; font-weight: 600;">➕ Maggiorazioni</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 16px;" id="totalBonusesDisplay">€0</div>
                    <div style="height: 2px; background: rgba(0,0,0,0.1); margin: 16px 0;"></div>
                    <div style="font-size: 14px; margin-bottom: 8px; font-weight: 700;">🎯 TOTALE FINALE</div>
                    <div style="font-size: 32px; font-weight: 700;" id="grandTotal">€0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">🔧 Azioni</div>
                </div>
                <div style="display: grid; gap: 12px;">
                    <button class="btn btn-success" onclick="importFromExcelFixed()">📁 Importa Excel</button>
                    <button class="btn btn-primary" onclick="handleExportExcel()">📄 Esporta Excel</button>
                    <button class="btn btn-primary" onclick="handleExportPDF()">📑 Esporta PDF</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Cancella Tutto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FLOATING ACTION BUTTON -->
    <button class="fab" id="fabButton" onclick="goToInserimento()">+</button>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showTab('inserimento')" data-tab="inserimento">
            <div class="nav-icon">✏️</div>
            <div class="nav-label">Inserisci</div>
        </button>
        <button class="nav-item" onclick="showTab('calendario')" data-tab="calendario">
            <div class="nav-icon">📅</div>
            <div class="nav-label">Calendario</div>
        </button>
        <button class="nav-item" onclick="showTab('registro')" data-tab="registro">
            <div class="nav-icon">📊</div>
            <div class="nav-label">Registro</div>
        </button>
        <button class="nav-item" onclick="showTab('riepilogo')" data-tab="riepilogo">
            <div class="nav-icon">📈</div>
            <div class="nav-label">Riepilogo</div>
        </button>
        <button class="nav-item" onclick="showTab('configurazione')" data-tab="configurazione">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label">Config</div>
        </button>
    </div>

    <script>
        // STESSA LOGICA IDENTICA - Solo UI cambiata
        let workDays = [];
        let travelTypes = [
            { name: 'In Regione', amount: 10 },
            { name: 'Fuori Regione', amount: 15 },
            { name: 'Estero', amount: 25 }
        ];
        
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;
        let additionalBreaks = [];
        let breakCounter = 0;

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            const configLoaded = loadConfig();
            const workDaysCount = loadWorkDays();
            
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            
            additionalBreaks = [];
            breakCounter = 0;
            renderBreaks();
            
            updateTravelDropdown();
            updateTravelList();
            updateWorkDaysList();
            populateMonthSelector();
            updateSummary();
            generateCalendar();
            addCalculationListeners();
            addConfigListeners();
            
            if (configLoaded || workDaysCount > 0) {
                showMessage(`Caricati ${workDaysCount} record`, 'success');
            }
        }

        function addConfigListeners() {
            ['hourlyRate', 'standardHours', 'standardBreak'].forEach(id => {
                document.getElementById(id).addEventListener('change', autoSaveConfig);
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Gestisci FAB visibility
            const fab = document.getElementById('fabButton');
            if (tabName === 'inserimento' || tabName === 'configurazione') {
                fab.classList.add('hidden');
            } else {
                fab.classList.remove('hidden');
            }

            // Se vai su registro, aggiorna lista
            if (tabName === 'registro') {
                updateWorkDaysList();
            }
        }

        function goToInserimento() {
            showTab('inserimento');
        }

        function addBreak() {
            breakCounter++;
            const breakId = `break_${breakCounter}`;
            
            const breakItem = {
                id: breakId,
                start: '',
                end: ''
            };
            
            additionalBreaks.push(breakItem);
            renderBreaks();
            
            setTimeout(() => {
                document.getElementById(`${breakId}_start`).focus();
            }, 100);
        }
        
        function removeBreak(breakId) {
            additionalBreaks = additionalBreaks.filter(br => br.id !== breakId);
            renderBreaks();
            updateBreaksSummary();
            calculateAutomatic();
        }
        
        function renderBreaks() {
            const container = document.getElementById('breaksContainer');
            
            if (additionalBreaks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-text">Nessuna pausa aggiuntiva</div>
                    </div>
                `;
                document.getElementById('breaksSummary').classList.add('hidden');
                return;
            }
            
            let html = '';
            additionalBreaks.forEach((breakItem, index) => {
                html += `
                    <div class="pause-item">
                        <div class="pause-header">
                            <span style="font-weight: 600;">Pausa ${index + 2}</span>
                            <button class="btn btn-small btn-danger" onclick="removeBreak('${breakItem.id}')">🗑️</button>
                        </div>
                        <div class="pause-inputs">
                            <input type="time" id="${breakItem.id}_start" value="${breakItem.start}" 
                                   onchange="updateBreak('${breakItem.id}', 'start', this.value)"
                                   style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                            <span style="font-weight: bold; color: var(--text-secondary);">→</span>
                            <input type="time" id="${breakItem.id}_end" value="${breakItem.end}"
                                   onchange="updateBreak('${breakItem.id}', 'end', this.value)"
                                   style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('breaksSummary').classList.remove('hidden');
            updateBreaksSummary();
        }
        
        function updateBreak(breakId, field, value) {
            const breakItem = additionalBreaks.find(br => br.id === breakId);
            if (breakItem) {
                breakItem[field] = value;
                updateBreaksSummary();
                calculateAutomatic();
            }
        }
        
        function updateBreaksSummary() {
            let totalMinutes = 0;
            let validBreaks = 0;
            
            additionalBreaks.forEach(breakItem => {
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (end > start) {
                        totalMinutes += (end - start) / (1000 * 60);
                        validBreaks++;
                    }
                }
            });
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            
            document.getElementById('totalBreakTime').textContent = `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        }
        
        function validateBreaks() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            
            if (!entryTime || !exitTime) return true;
            
            const entry = new Date(`2000-01-01T${entryTime}`);
            let exit = new Date(`2000-01-01T${exitTime}`);
            
            if (exit <= entry) {
                exit = new Date(`2000-01-02T${exitTime}`);
            }
            
            if (breakStart && breakEnd) {
                const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (mainBreakEnd <= mainBreakStart) {
                    mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                
                if (mainBreakStart < entry || mainBreakEnd > exit) {
                    return 'La pausa principale deve essere compresa tra entrata e uscita';
                }
            }
            
            for (let i = 0; i < additionalBreaks.length; i++) {
                const breakItem = additionalBreaks[i];
                
                if (breakItem.start && breakItem.end) {
                    const start = new Date(`2000-01-01T${breakItem.start}`);
                    let end = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (end <= start) {
                        end = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (start < entry || end > exit) {
                        return `La pausa aggiuntiva ${i + 1} deve essere compresa tra entrata e uscita`;
                    }
                    
                    if (breakStart && breakEnd) {
                        const mainBreakStart = new Date(`2000-01-01T${breakStart}`);
                        let mainBreakEnd = new Date(`2000-01-01T${breakEnd}`);
                        
                        if (mainBreakEnd <= mainBreakStart) {
                            mainBreakEnd = new Date(`2000-01-02T${breakEnd}`);
                        }
                        
                        if ((start < mainBreakEnd && end > mainBreakStart)) {
                            return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa principale`;
                        }
                    }
                    
                    for (let j = i + 1; j < additionalBreaks.length; j++) {
                        const otherBreak = additionalBreaks[j];
                        if (otherBreak.start && otherBreak.end) {
                            const otherStart = new Date(`2000-01-01T${otherBreak.start}`);
                            let otherEnd = new Date(`2000-01-01T${otherBreak.end}`);
                            
                            if (otherEnd <= otherStart) {
                                otherEnd = new Date(`2000-01-02T${otherBreak.end}`);
                            }
                            
                            if ((start < otherEnd && end > otherStart)) {
                                return `La pausa aggiuntiva ${i + 1} si sovrappone con la pausa aggiuntiva ${j + 1}`;
                            }
                        }
                    }
                }
            }
            
            return true;
        }

        function addTravelType() {
            const name = document.getElementById('newTravelName').value.trim();
            const amount = parseFloat(document.getElementById('newTravelAmount').value);
            
            if (!name || isNaN(amount)) {
                showMessage('Compila nome e importo', 'error');
                return;
            }
            
            if (travelTypes.find(type => type.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Tipo già esistente', 'error');
                return;
            }
            
            travelTypes.push({ name, amount });
            updateTravelDropdown();
            updateTravelList();
            autoSaveConfig();
            
            document.getElementById('newTravelName').value = '';
            document.getElementById('newTravelAmount').value = '';
            
            showMessage('Tipo trasferta aggiunto', 'success');
        }

        function removeTravelType(index) {
            if (confirm('Eliminare questo tipo trasferta?')) {
                travelTypes.splice(index, 1);
                updateTravelDropdown();
                updateTravelList();
                autoSaveConfig();
                showMessage('Tipo eliminato', 'success');
            }
        }

        function updateTravelDropdown() {
            const select = document.getElementById('travelType');
            select.innerHTML = '<option value="">Nessuna</option>';
            
            travelTypes.forEach((type, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${type.name} (+€${type.amount})`;
                select.appendChild(option);
            });
        }

        function updateTravelList() {
            const container = document.getElementById('travelList');
            container.innerHTML = '';
            
            if (travelTypes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">Nessun tipo trasferta</div></div>';
                return;
            }
            
            travelTypes.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${type.name}</div>
                        <div class="list-item-subtitle">Importo fisso</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="list-item-value">€${type.amount}</div>
                        <button class="btn btn-small btn-danger" onclick="removeTravelType(${index})">🗑️</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function addCalculationListeners() {
            const timeInputs = ['entryTime', 'breakStart', 'breakEnd', 'exitTime'];
            const typeInputs = ['travelType'];
            
            timeInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateAutomatic);
            });
            
            typeInputs.forEach(id => {
                document.getElementById(id).addEventListener('change', calculateAutomatic);
            });
        }

        function calculateAutomatic() {
            const entryTime = document.getElementById('entryTime').value;
            const exitTime = document.getElementById('exitTime').value;
            
            const autoCalc = document.getElementById('autoCalc');
            
            if (entryTime && exitTime) {
                const breakValidation = validateBreaks();
                if (breakValidation !== true) {
                    autoCalc.classList.remove('hidden');
                    document.getElementById('calcDayType').textContent = 'Errore';
                    document.getElementById('calcBreak').textContent = '--';
                    document.getElementById('calcWork').textContent = '--';
                    document.getElementById('calcNight').textContent = '--';
                    document.getElementById('calcOvertime').textContent = '--';
                    document.getElementById('calcPay').textContent = '--';
                    document.getElementById('calcBreakdown').innerHTML = `<strong style="color: #dc3545;">Errore:</strong> ${breakValidation}`;
                    return;
                }
                
                autoCalc.classList.remove('hidden');
                
                const result = calculateWorkHours(entryTime, exitTime);
                
                document.getElementById('calcDayType').textContent = result.dayType || '--';
                document.getElementById('calcBreak').textContent = result.breakTime;
                document.getElementById('calcWork').textContent = formatHours(parseFloat(result.workHours));
                document.getElementById('calcNight').textContent = formatHours(parseFloat(result.nightHours));
                document.getElementById('calcOvertime').textContent = formatHours(parseFloat(result.overtimeHours));
                document.getElementById('calcPay').textContent = '€' + result.dailyPay;
                
                showDetailedBreakdown(result);
            } else if (entryTime || exitTime) {
                autoCalc.classList.remove('hidden');
                
                document.getElementById('calcDayType').textContent = entryTime ? 'In corso' : 'Incompleto';
                document.getElementById('calcBreak').textContent = '--';
                document.getElementById('calcWork').textContent = '--';
                document.getElementById('calcNight').textContent = '--';
                document.getElementById('calcOvertime').textContent = '--';
                document.getElementById('calcPay').textContent = '--';
                
                const statusMsg = entryTime && !exitTime ? 
                    'Aggiungi orario uscita per calcolare' :
                    'Compila entrata e uscita';
                    
                document.getElementById('calcBreakdown').innerHTML = statusMsg;
            } else {
                autoCalc.classList.add('hidden');
            }
        }

        function showDetailedBreakdown(result) {
            const workDate = new Date(document.getElementById('workDate').value);
            const dayOfWeek = workDate.getDay();
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const workHours = parseFloat(result.workHours);
            const nightHours = parseFloat(result.nightHours);
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            let breakdown = '';
            
            if (dayOfWeek === 0) {
                breakdown += `Domenica: ${formatHours(workHours)} × €${hourlyRate} × 1.45 = €${(workHours * hourlyRate * 1.45).toFixed(2)}`;
            } else if (dayOfWeek === 6) {
                const firstThree = Math.min(workHours, 3);
                const remaining = Math.max(0, workHours - 3);
                
                breakdown += `Sab 1-3h: ${formatHours(firstThree)} × €${hourlyRate} × 1.25 = €${(firstThree * hourlyRate * 1.25).toFixed(2)}`;
                if (remaining > 0) {
                    breakdown += `<br>Sab oltre 3h: ${formatHours(remaining)} × €${hourlyRate} × 1.50 = €${(remaining * hourlyRate * 1.50).toFixed(2)}`;
                }
            } else {
                const regularHours = Math.min(workHours, standardHours);
                const overtimeHours = Math.max(0, workHours - standardHours);
                
                breakdown += `Normali: ${formatHours(regularHours)} × €${hourlyRate} = €${(regularHours * hourlyRate).toFixed(2)}`;
                
                if (overtimeHours > 0) {
                    breakdown += `<br>Straord: ${formatHours(overtimeHours)} × €${hourlyRate} × 1.25 = €${(overtimeHours * hourlyRate * 1.25).toFixed(2)}`;
                }
                
                if (nightHours > 0) {
                    breakdown += `<br>Notturno: ${formatHours(nightHours)} con maggiorazioni`;
                }
            }
            
            const travelTypeIndex = document.getElementById('travelType').value;
            if (travelTypeIndex !== '') {
                const travelAmount = travelTypes[travelTypeIndex].amount;
                breakdown += `<br>Trasferta: +€${travelAmount}`;
            }
            
            document.getElementById('calcBreakdown').innerHTML = breakdown;
        }

        function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDate = new Date(firstDay);
            const dayOfWeek = (firstDay.getDay() + 6) % 7;
            startDate.setDate(startDate.getDate() - dayOfWeek);
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = createCalendarDay(currentDate, month, today);
                calendarGrid.appendChild(dayElement);
            }
        }

        function createCalendarDay(date, currentMonth, today) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dayNumber = date.getDate();
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.getTime() === today.getTime();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            
            if (!isCurrentMonth) dayElement.classList.add('other-month');
            if (isToday) dayElement.classList.add('today');
            if (workData) dayElement.classList.add('has-work');
            
            dayElement.innerHTML = `
                <div class="calendar-day-number">${dayNumber}</div>
                ${workData && workData.status === 'completo' ? '<div class="calendar-day-indicator"></div>' : ''}
            `;
            
            dayElement.addEventListener('click', () => selectCalendarDay(date, dayElement));
            
            return dayElement;
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            generateCalendar();
        }

        function selectCalendarDay(date, element) {
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedCalendarDay = date;
            
            showDayDetails(date);
        }

        function showDayDetails(date) {
            const dateString = dateToString(date);
            const workData = workDays.find(day => day.date === dateString);
            const dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            
            const detailsSection = document.getElementById('dayDetails');
            const detailsContent = document.getElementById('dayDetailsContent');
            
            let content = `<div class="card-header"><div class="card-title">${dayNames[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}</div></div>`;
            
            if (workData) {
                if (workData.status === 'completo') {
                    content += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="background: #d1f4e0; padding: 16px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 12px; color: #0f5132; margin-bottom: 4px;">Ore Lavorate</div>
                                <div style="font-size: 24px; font-weight: 700; color: #0f5132;">${formatHours(parseFloat(workData.workHours))}</div>
                            </div>
                            <div style="background: #fff3cd; padding: 16px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 12px; color: #856404; margin-bottom: 4px;">Compenso</div>
                                <div style="font-size: 24px; font-weight: 700; color: #856404;">€${workData.dailyPay}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; line-height: 2;">
                            <div><strong>Entrata:</strong> ${workData.entryTime}</div>
                            <div><strong>Pausa:</strong> ${workData.breakStart || '--'} - ${workData.breakEnd || '--'}</div>
                            <div><strong>Uscita:</strong> ${workData.exitTime}</div>
                            <div><strong>Straordinari:</strong> ${formatHours(parseFloat(workData.overtimeHours))}</div>
                            <div><strong>Notturne:</strong> ${formatHours(parseFloat(workData.nightHours || 0))}</div>
                            <div><strong>Tipo:</strong> ${workData.dayType || 'Feriale'}</div>
                            ${workData.notes ? `<div><strong>Note:</strong> ${workData.notes}</div>` : ''}
                        </div>
                    `;
                } else {
                    content += `
                        <div style="background: #f8d7da; padding: 16px; border-radius: 12px; text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 16px; font-weight: 600; color: #842029;">
                                ${workData.status === 'in_corso' ? '⏳ In Corso' : '❌ Incompleto'}
                            </div>
                        </div>
                        <div style="font-size: 14px; line-height: 2;">
                            <div><strong>Entrata:</strong> ${workData.entryTime || '--'}</div>
                            <div><strong>Uscita:</strong> ${workData.exitTime || '--'}</div>
                        </div>
                    `;
                }
                
                content += `
                    <div class="btn-group" style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="editDay('${dateString}')">✏️ Modifica</button>
                        <button class="btn btn-danger" onclick="deleteDay('${dateString}')">🗑️ Elimina</button>
                    </div>
                `;
            } else {
                content += `
                    <div class="empty-state">
                        <div class="empty-state-text">Nessun dato per questa giornata</div>
                    </div>
                    <button class="btn btn-success" onclick="addDayFromCalendar('${dateString}')" style="margin-top: 16px;">+ Aggiungi Giornata</button>
                `;
            }
            
            detailsContent.innerHTML = content;
            detailsSection.classList.remove('hidden');
        }

        function addDayFromCalendar(dateString) {
            document.getElementById('workDate').value = dateString;
            showTab('inserimento');
            setTimeout(() => document.getElementById('entryTime').focus(), 100);
        }

        function editDay(dateString) {
            const workData = workDays.find(day => day.date === dateString);
            if (workData) {
                document.getElementById('workDate').value = dateString;
                document.getElementById('entryTime').value = workData.entryTime;
                document.getElementById('breakStart').value = workData.breakStart || '';
                document.getElementById('breakEnd').value = workData.breakEnd || '';
                document.getElementById('exitTime').value = workData.exitTime;
                document.getElementById('notes').value = workData.notes || '';
                
                additionalBreaks = [];
                breakCounter = 0;
                
                if (workData.additionalBreaks && Array.isArray(workData.additionalBreaks)) {
                    workData.additionalBreaks.forEach((br, index) => {
                        if (br.start || br.end) {
                            breakCounter++;
                            additionalBreaks.push({
                                id: `break_${breakCounter}`,
                                start: br.start || '',
                                end: br.end || ''
                            });
                        }
                    });
                }
                
                renderBreaks();
                
                const travelIndex = travelTypes.findIndex(t => t.name === workData.travelType);
                document.getElementById('travelType').value = travelIndex >= 0 ? travelIndex : '';
                
                showTab('inserimento');
                calculateAutomatic();
                showMessage('Dati caricati per modifica', 'success');
            }
        }

        function deleteDay(dateString) {
            if (confirm('Eliminare questa giornata?')) {
                const index = workDays.findIndex(day => day.date === dateString);
                if (index >= 0) {
                    workDays.splice(index, 1);
                    updateWorkDaysList();
                    populateMonthSelector();
                    updateSummary();
                    generateCalendar();
                    autoSaveWorkDays();
                    document.getElementById('dayDetails').classList.add('hidden');
                    showMessage('Giornata eliminata', 'success');
                }
            }
        }

        function calculateWorkHours(entryTime, exitTime) {
            const entry = new Date(`2000-01-01T${entryTime}`);
            let exit = new Date(`2000-01-01T${exitTime}`);
            
            if (exit <= entry) {
                exit = new Date(`2000-01-02T${exitTime}`);
            }
            
            let totalMinutes = (exit - entry) / (1000 * 60);
            let breakMinutes = 0;
            let breakTime = 'Nessuna';
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            
            if (breakStart && breakEnd) {
                let bStart = new Date(`2000-01-01T${breakStart}`);
                let bEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (bEnd <= bStart) {
                    bEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                
                if (bEnd > bStart) {
                    breakMinutes += (bEnd - bStart) / (1000 * 60);
                }
            }
            
            let additionalBreakMinutes = 0;
            let validAdditionalBreaks = 0;
            
            additionalBreaks.forEach((breakItem) => {
                if (breakItem.start && breakItem.end) {
                    let bStart = new Date(`2000-01-01T${breakItem.start}`);
                    let bEnd = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (bEnd <= bStart) {
                        bEnd = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    
                    if (bEnd > bStart) {
                        additionalBreakMinutes += (bEnd - bStart) / (1000 * 60);
                        validAdditionalBreaks++;
                    }
                }
            });
            
            breakMinutes += additionalBreakMinutes;
            
            if (breakMinutes > 0) {
                const hours = Math.floor(breakMinutes / 60);
                const minutes = Math.round(breakMinutes % 60);
                
                let pauseDescription = `${hours}h ${minutes}m`;
                if (breakStart && breakEnd && validAdditionalBreaks > 0) {
                    pauseDescription += ` (principale + ${validAdditionalBreaks} extra)`;
                }
                
                breakTime = pauseDescription;
            }
            
            const workMinutes = totalMinutes - breakMinutes;
            const workHours = workMinutes / 60;
            
            const workDate = new Date(document.getElementById('workDate').value);
            const dayOfWeek = workDate.getDay();
            
            const preciseResult = calculatePreciseHours(entry, exit, workHours);
            
            const result = calculateContractualPay(
                workHours, 
                dayOfWeek, 
                preciseResult.totalNightHours,
                preciseResult.regularNightHours,
                preciseResult.overtimeNightHours
            );
            
            const travelTypeIndex = document.getElementById('travelType').value;
            if (travelTypeIndex !== '') {
                const travelAmount = travelTypes[travelTypeIndex].amount;
                result.dailyPay += travelAmount;
            }
            
            return {
                breakTime,
                workHours: workHours.toFixed(2),
                overtimeHours: result.overtimeHours.toFixed(2),
                dailyPay: result.dailyPay.toFixed(2),
                nightHours: preciseResult.totalNightHours.toFixed(2),
                dayType: result.dayType
            };
        }

        function calculatePreciseHours(entry, exit, totalWorkHours) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            const pausePeriods = [];
            
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            if (breakStart && breakEnd) {
                let pauseStart = new Date(`2000-01-01T${breakStart}`);
                let pauseEnd = new Date(`2000-01-01T${breakEnd}`);
                
                if (pauseEnd <= pauseStart) {
                    pauseEnd = new Date(`2000-01-02T${breakEnd}`);
                }
                if (pauseStart < entry) {
                    pauseStart = new Date(`2000-01-02T${breakStart}`);
                }
                
                pausePeriods.push({ start: pauseStart, end: pauseEnd });
            }
            
            additionalBreaks.forEach(breakItem => {
                if (breakItem.start && breakItem.end) {
                    let pauseStart = new Date(`2000-01-01T${breakItem.start}`);
                    let pauseEnd = new Date(`2000-01-01T${breakItem.end}`);
                    
                    if (pauseEnd <= pauseStart) {
                        pauseEnd = new Date(`2000-01-02T${breakItem.end}`);
                    }
                    if (pauseStart < entry) {
                        pauseStart = new Date(`2000-01-02T${breakItem.start}`);
                    }
                    
                    pausePeriods.push({ start: pauseStart, end: pauseEnd });
                }
            });
            
            let currentTime = new Date(entry);
            let workedMinutes = 0;
            let regularNightMinutes = 0;
            let overtimeNightMinutes = 0;
            
            const nightStart = 22 * 60;
            const nightEnd = 6 * 60;
            
            while (currentTime < exit && workedMinutes < totalWorkHours * 60) {
                const inBreak = pausePeriods.some(pause => 
                    currentTime >= pause.start && currentTime < pause.end
                );
                
                if (!inBreak) {
                    const timeMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
                    const isNight = timeMinutes >= nightStart || timeMinutes < nightEnd;
                    
                    const workedHours = workedMinutes / 60;
                    const isRegularTime = workedHours < standardHours;
                    
                    if (isNight) {
                        if (isRegularTime) {
                            regularNightMinutes++;
                        } else {
                            overtimeNightMinutes++;
                        }
                    }
                    
                    workedMinutes++;
                }
                
                currentTime = new Date(currentTime.getTime() + 60000);
            }
            
            return {
                totalNightHours: (regularNightMinutes + overtimeNightMinutes) / 60,
                regularNightHours: regularNightMinutes / 60,
                overtimeNightHours: overtimeNightMinutes / 60
            };
        }

        function calculateContractualPay(workHours, dayOfWeek, totalNightHours, regularNightHours = 0, overtimeNightHours = 0) {
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            let dailyPay = 0;
            let overtimeHours = 0;
            let dayType = '';
            
            if (dayOfWeek === 0) {
                dayType = 'Domenica (+45%)';
                dailyPay = workHours * hourlyRate * 1.45;
                overtimeHours = workHours;
            } else if (dayOfWeek === 6) {
                dayType = 'Sabato';
                const firstThreeHours = Math.min(workHours, 3);
                const remainingHours = Math.max(0, workHours - 3);
                
                dailyPay = firstThreeHours * hourlyRate * 1.25;
                dailyPay += remainingHours * hourlyRate * 1.50;
                overtimeHours = workHours;
                
                if (totalNightHours > 0) {
                    dayType += ' + Notturno';
                    const nightNormalRate = Math.min(totalNightHours, 3) * hourlyRate * 0.15;
                    const nightOvertimeRate = Math.max(0, totalNightHours - 3) * hourlyRate * 0.05;
                    dailyPay += nightNormalRate + nightOvertimeRate;
                }
            } else {
                dayType = 'Feriale';
                
                const regularHours = Math.min(workHours, standardHours);
                overtimeHours = Math.max(0, workHours - standardHours);
                
                const regularDayHours = regularHours - regularNightHours;
                const overtimeDayHours = overtimeHours - overtimeNightHours;
                
                dailyPay += regularDayHours * hourlyRate;
                dailyPay += regularNightHours * hourlyRate * 1.15;
                dailyPay += overtimeDayHours * hourlyRate * 1.25;
                dailyPay += overtimeNightHours * hourlyRate * 1.55;
                
                if (totalNightHours > 0) {
                    if (overtimeNightHours > 0) {
                        dayType += ` + Nott. (+15%/+55%)`;
                    } else {
                        dayType += ` + Nott. (+15%)`;
                    }
                }
            }
            
            return {
                dailyPay,
                overtimeHours,
                dayType
            };
        }

        function addWorkDay() {
            const date = document.getElementById('workDate').value;
            const entryTime = document.getElementById('entryTime').value;
            const breakStart = document.getElementById('breakStart').value;
            const breakEnd = document.getElementById('breakEnd').value;
            const exitTime = document.getElementById('exitTime').value;
            const travelTypeIndex = document.getElementById('travelType').value;
            const notes = document.getElementById('notes').value;

            if (!date) {
                showMessage('La data è obbligatoria', 'error');
                return;
            }

            if (entryTime && exitTime) {
                const entry = new Date(`2000-01-01T${entryTime}`);
                let exit = new Date(`2000-01-01T${exitTime}`);
                
                if (exit <= entry) {
                    exit = new Date(`2000-01-02T${exitTime}`);
                }
                
                const breakValidation = validateBreaks();
                if (breakValidation !== true) {
                    showMessage(breakValidation, 'error');
                    return;
                }
            }

            const existingIndex = workDays.findIndex(day => day.date === date);
            if (existingIndex !== -1) {
                if (!confirm('Esiste già un record per questa data. Sostituirlo?')) {
                    return;
                }
                workDays.splice(existingIndex, 1);
            }

            let workDay = {
                date,
                entryTime: entryTime || '',
                breakStart: breakStart || '',
                breakEnd: breakEnd || '',
                additionalBreaks: JSON.parse(JSON.stringify(additionalBreaks)),
                exitTime: exitTime || '',
                travelType: travelTypeIndex !== '' ? travelTypes[travelTypeIndex].name : '',
                notes: notes || ''
            };

            if (entryTime && exitTime) {
                const result = calculateWorkHours(entryTime, exitTime);
                
                workDay = {
                    ...workDay,
                    breakTime: result.breakTime,
                    workHours: result.workHours,
                    overtimeHours: result.overtimeHours,
                    nightHours: result.nightHours,
                    dayType: result.dayType,
                    dailyPay: result.dailyPay,
                    status: 'completo'
                };
            } else {
                workDay = {
                    ...workDay,
                    breakTime: '--',
                    workHours: '0.00',
                    overtimeHours: '0.00',
                    nightHours: '0.00',
                    dayType: '--',
                    dailyPay: '0.00',
                    status: entryTime ? 'in_corso' : 'incompleto'
                };
            }

            workDays.push(workDay);
            workDays.sort((a, b) => new Date(a.date) - new Date(b.date));

            updateWorkDaysList();
            populateMonthSelector();
            updateSummary();
            generateCalendar();
            autoSaveWorkDays();
            clearForm();
            
            const statusText = workDay.status === 'completo' ? 'completa' : 
                              workDay.status === 'in_corso' ? 'in corso' : 'incompleta';
            showMessage(`Giornata ${statusText} salvata!`, 'success');
        }

        function clearForm() {
            document.getElementById('entryTime').value = '';
            document.getElementById('breakStart').value = '';
            document.getElementById('breakEnd').value = '';
            document.getElementById('exitTime').value = '';
            document.getElementById('travelType').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('autoCalc').classList.add('hidden');
            
            additionalBreaks = [];
            breakCounter = 0;
            renderBreaks();
            
            const currentDate = new Date(document.getElementById('workDate').value);
            currentDate.setDate(currentDate.getDate() + 1);
            document.getElementById('workDate').value = currentDate.toISOString().split('T')[0];
        }

        function updateWorkDaysList() {
            const container = document.getElementById('workDaysList');
            const emptyState = document.getElementById('emptyRegistry');
            const countBadge = document.getElementById('totalDaysCount');
            
            if (workDays.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                countBadge.textContent = '0';
                return;
            }
            
            emptyState.style.display = 'none';
            countBadge.textContent = workDays.length;
            
            container.innerHTML = '';
            
            // Raggruppa per mese
            const byMonth = {};
            workDays.forEach(day => {
                const date = new Date(day.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!byMonth[monthKey]) byMonth[monthKey] = [];
                byMonth[monthKey].push(day);
            });
            
            // Ordina mesi (più recenti prima)
            const sortedMonths = Object.keys(byMonth).sort().reverse();
            
            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(parseInt(year), parseInt(month) - 1, 1)
                    .toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                
                const monthHeader = document.createElement('div');
                monthHeader.style.cssText = 'padding: 16px 16px 8px 16px; font-weight: 700; color: var(--text-secondary); font-size: 14px; text-transform: uppercase;';
                monthHeader.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                container.appendChild(monthHeader);
                
                byMonth[monthKey].reverse().forEach((day, index) => {
                    const dayItem = document.createElement('div');
                    dayItem.className = 'list-item';
                    
                    let badge = '';
                    if (day.status === 'completo') {
                        badge = '<span class="badge badge-success">✓ Completo</span>';
                    } else if (day.status === 'in_corso') {
                        badge = '<span class="badge badge-warning">⏳ In corso</span>';
                    } else {
                        badge = '<span class="badge badge-danger">❌ Incompleto</span>';
                    }
                    
                    dayItem.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${formatDate(day.date)} ${badge}</div>
                            <div class="list-item-subtitle">
                                ${day.entryTime || '--'} → ${day.exitTime || '--'} 
                                ${day.status === 'completo' ? `• ${formatHours(parseFloat(day.workHours))}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${day.status === 'completo' ? `<div class="list-item-value">€${day.dailyPay}</div>` : ''}
                            <button class="btn btn-small btn-danger" onclick="deleteDay('${day.date}')">🗑️</button>
                        </div>
                    `;
                    
                    dayItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            editDay(day.date);
                        }
                    });
                    
                    container.appendChild(dayItem);
                });
            });
        }

        function populateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            
            if (workDays.length === 0) {
                selector.innerHTML = '<option value="">Nessun dato</option>';
                return;
            }
            
            const monthsSet = new Set();
            workDays.forEach(day => {
                const date = new Date(day.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthsSet.add(monthKey);
            });
            
            const months = Array.from(monthsSet).sort().reverse();
            
            selector.innerHTML = '';
            
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(parseInt(year), parseInt(month) - 1, 1)
                    .toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                selector.appendChild(option);
            });
            
            if (months.length > 0) {
                selector.value = months[0];
            }
        }
        
        function updateMonthFilter() {
            updateSummary();
        }
        
        function getFilteredDaysByMonth() {
            const selectedMonth = document.getElementById('monthSelector').value;
            
            if (!selectedMonth) {
                return workDays.filter(day => day.status === 'completo');
            }
            
            const filteredDays = workDays.filter(day => {
                if (day.status !== 'completo') return false;
                
                const date = new Date(day.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                return monthKey === selectedMonth;
            });
            
            return filteredDays;
        }
        
        function getCurrentMonthName() {
            const selectedMonth = document.getElementById('monthSelector').value;
            if (!selectedMonth) return 'Nessun mese selezionato';
            
            const [year, month] = selectedMonth.split('-');
            const monthName = new Date(parseInt(year), parseInt(month) - 1, 1)
                .toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            
            return monthName.charAt(0).toUpperCase() + monthName.slice(1);
        }

        function updateSummary() {
            const completeDays = getFilteredDaysByMonth();
            const incompleteDays = workDays.filter(day => day.status !== 'completo');
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            document.getElementById('monthDaysCount').textContent = completeDays.length;
            
            const regularHours = completeDays.reduce((sum, day) => {
                const workHours = parseFloat(day.workHours);
                const dayOfWeek = new Date(day.date).getDay();
                
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    return sum;
                }
                
                return sum + Math.min(workHours, standardHours);
            }, 0);
            
            const totalWorkHours = completeDays.reduce((sum, day) => sum + parseFloat(day.workHours), 0);
            const overtimeHours = completeDays.reduce((sum, day) => sum + parseFloat(day.overtimeHours), 0);
            const nightHours = completeDays.reduce((sum, day) => sum + parseFloat(day.nightHours || 0), 0);
            const travelDays = completeDays.filter(day => day.travelType).length;
            const monthlyTotal = completeDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);

            document.getElementById('monthHoursCount').textContent = formatHours(totalWorkHours);

            document.getElementById('regularHours').textContent = formatHours(regularHours);
            document.getElementById('overtimeHours').textContent = formatHours(overtimeHours);
            document.getElementById('nightHours').textContent = formatHours(nightHours);
            document.getElementById('travelDays').textContent = travelDays;
            
            let totalText = '€' + monthlyTotal.toFixed(2);
            if (incompleteDays.length > 0) {
                totalText += ` (${incompleteDays.length} incomp.)`;
            }
            document.getElementById('monthlyTotal').textContent = totalText;
            
            const currentMonth = getCurrentMonthName();
            document.getElementById('breakdownSubtitle').textContent = 
                `Analisi compensi ${currentMonth}`;
            
            updateOvertimeBreakdown(completeDays);
        }
        
        function updateOvertimeBreakdown(completeDays) {
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const breakdown = calculateOvertimeBreakdown(completeDays, hourlyRate);
            
            populateBreakdownDisplay(breakdown, hourlyRate);
        }

        function calculateOvertimeBreakdown(completeDays, hourlyRate) {
            let breakdown = {
                weekdayOvertime: 0,
                saturdayFirst3: 0,
                saturdayRest: 0,
                sundayAll: 0,
                nightNormal: 0,
                nightOvertime: 0,
                travelDays: 0,
                travelAmount: 0,
                amounts: {
                    weekday: 0,
                    saturdayFirst: 0,
                    saturdayRest: 0,
                    sunday: 0,
                    nightNormal: 0,
                    nightOvertime: 0,
                    travel: 0
                }
            };
            
            completeDays.forEach(day => {
                const workDate = new Date(day.date);
                const dayOfWeek = workDate.getDay();
                const workHours = parseFloat(day.workHours);
                const nightHours = parseFloat(day.nightHours || 0);
                const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
                
                if (dayOfWeek === 0) {
                    breakdown.sundayAll += workHours;
                    breakdown.amounts.sunday += workHours * hourlyRate * 1.45;
                } else if (dayOfWeek === 6) {
                    const first3Hours = Math.min(workHours, 3);
                    const restHours = Math.max(0, workHours - 3);
                    
                    breakdown.saturdayFirst3 += first3Hours;
                    breakdown.saturdayRest += restHours;
                    
                    breakdown.amounts.saturdayFirst += first3Hours * hourlyRate * 1.25;
                    breakdown.amounts.saturdayRest += restHours * hourlyRate * 1.50;
                    
                    if (nightHours > 0) {
                        const nightNormalRate = Math.min(nightHours, 3) * hourlyRate * 0.15;
                        const nightOvertimeRate = Math.max(0, nightHours - 3) * hourlyRate * 0.05;
                        breakdown.amounts.saturdayFirst += nightNormalRate;
                        breakdown.amounts.saturdayRest += nightOvertimeRate;
                    }
                } else {
                    const regularHours = Math.min(workHours, standardHours);
                    const overtimeHours = Math.max(0, workHours - standardHours);
                    
                    const preciseResult = calculatePreciseHoursForBreakdown(workDate, workHours, nightHours);
                    
                    breakdown.weekdayOvertime += overtimeHours;
                    
                    const overtimeDayHours = overtimeHours - preciseResult.overtimeNightHours;
                    
                    breakdown.amounts.weekday += overtimeDayHours * hourlyRate * 1.25;
                    breakdown.amounts.weekday += preciseResult.overtimeNightHours * hourlyRate * 1.55;
                    
                    breakdown.nightNormal += preciseResult.regularNightHours;
                    breakdown.nightOvertime += preciseResult.overtimeNightHours;
                    
                    breakdown.amounts.nightNormal += preciseResult.regularNightHours * hourlyRate * 0.15;
                    breakdown.amounts.nightOvertime += preciseResult.overtimeNightHours * hourlyRate * 0.55;
                }
                
                if (day.travelType) {
                    breakdown.travelDays++;
                    const travelType = travelTypes.find(t => t.name === day.travelType);
                    if (travelType) {
                        breakdown.travelAmount += travelType.amount;
                        breakdown.amounts.travel += travelType.amount;
                    }
                }
            });
            
            return breakdown;
        }
        
        function calculatePreciseHoursForBreakdown(workDate, totalWorkHours, nightHours) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            const regularHours = Math.min(totalWorkHours, standardHours);
            const overtimeHours = Math.max(0, totalWorkHours - standardHours);
            
            let regularNightHours = 0;
            let overtimeNightHours = 0;
            
            if (nightHours > 0) {
                const regularRatio = regularHours / totalWorkHours;
                const overtimeRatio = overtimeHours / totalWorkHours;
                
                regularNightHours = nightHours * regularRatio;
                overtimeNightHours = nightHours * overtimeRatio;
            }
            
            return {
                regularNightHours,
                overtimeNightHours
            };
        }

        function populateBreakdownDisplay(breakdown, hourlyRate) {
            document.getElementById('weekdayBreakdown').textContent = 
                `${formatHours(breakdown.weekdayOvertime)} × €${hourlyRate.toFixed(2)} × 1.25`;
            document.getElementById('weekdayAmount').textContent = `€${breakdown.amounts.weekday.toFixed(2)}`;
            
            document.getElementById('saturdayFirstBreakdown').textContent = 
                `${formatHours(breakdown.saturdayFirst3)} × €${hourlyRate.toFixed(2)} × 1.25`;
            document.getElementById('saturdayFirstAmount').textContent = `€${breakdown.amounts.saturdayFirst.toFixed(2)}`;
            
            document.getElementById('saturdayRestBreakdown').textContent = 
                `${formatHours(breakdown.saturdayRest)} × €${hourlyRate.toFixed(2)} × 1.50`;
            document.getElementById('saturdayRestAmount').textContent = `€${breakdown.amounts.saturdayRest.toFixed(2)}`;
            
            document.getElementById('sundayBreakdown').textContent = 
                `${formatHours(breakdown.sundayAll)} × €${hourlyRate.toFixed(2)} × 1.45`;
            document.getElementById('sundayAmount').textContent = `€${breakdown.amounts.sunday.toFixed(2)}`;
            
            document.getElementById('nightNormalBreakdown').textContent = 
                `${formatHours(breakdown.nightNormal)} × €${hourlyRate.toFixed(2)} × 0.15`;
            document.getElementById('nightNormalAmount').textContent = `€${breakdown.amounts.nightNormal.toFixed(2)}`;
            
            document.getElementById('nightOvertimeBreakdown').textContent = 
                `${formatHours(breakdown.nightOvertime)} × €${hourlyRate.toFixed(2)} × 0.55`;
            document.getElementById('nightOvertimeAmount').textContent = `€${breakdown.amounts.nightOvertime.toFixed(2)}`;
            
            document.getElementById('travelBreakdown').textContent = 
                `${breakdown.travelDays} giorni × €${(breakdown.travelAmount / Math.max(breakdown.travelDays, 1)).toFixed(2)}`;
            document.getElementById('travelAmount').textContent = `€${breakdown.amounts.travel.toFixed(2)}`;
            
            const overtimeSubtotal = breakdown.amounts.weekday + breakdown.amounts.saturdayFirst + 
                                   breakdown.amounts.saturdayRest + breakdown.amounts.sunday;
            
            const bonusSubtotal = breakdown.amounts.nightNormal + breakdown.amounts.nightOvertime + breakdown.amounts.travel;
            
            const totalBonuses = overtimeSubtotal + bonusSubtotal;
            document.getElementById('totalBonusesDisplay').textContent = `€${totalBonuses.toFixed(2)}`;
            
            const completeDays = workDays.filter(day => day.status === 'completo');
            const monthlyTotal = completeDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);
            
            const calculatedBasePay = monthlyTotal - totalBonuses;
            
            document.getElementById('basePay').textContent = `€${calculatedBasePay.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `€${monthlyTotal.toFixed(2)}`;
        }
        
        function calculateMonthlyTotals(filteredDays) {
            const standardHours = parseFloat(document.getElementById('standardHours').value) || 8;
            
            const regularHours = filteredDays.reduce((sum, day) => {
                const workHours = parseFloat(day.workHours);
                const dayOfWeek = new Date(day.date).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) return sum;
                return sum + Math.min(workHours, standardHours);
            }, 0);
            
            const overtimeHours = filteredDays.reduce((sum, day) => sum + parseFloat(day.overtimeHours), 0);
            const nightHours = filteredDays.reduce((sum, day) => sum + parseFloat(day.nightHours || 0), 0);
            const travelDays = filteredDays.filter(day => day.travelType).length;
            const monthlyTotal = filteredDays.reduce((sum, day) => sum + parseFloat(day.dailyPay), 0);
            
            return {
                regularHours,
                overtimeHours,
                nightHours,
                travelDays,
                monthlyTotal
            };
        }

        function handleExportExcel() {
            try {
                // Verifica che la libreria XLSX sia caricata
                if (typeof XLSX === 'undefined') {
                    showMessage('Libreria Excel non caricata. Ricarica la pagina.', 'error');
                    return;
                }
                
                exportToExcelFiltered();
            } catch (error) {
                console.error('Errore export Excel:', error);
                showMessage('Errore durante l\'export Excel', 'error');
            }
        }

        function handleExportPDF() {
            try {
                // Verifica che la libreria jsPDF sia caricata
                if (typeof window.jspdf === 'undefined') {
                    showMessage('Libreria PDF non caricata. Ricarica la pagina.', 'error');
                    return;
                }
                
                exportToPDFFiltered();
            } catch (error) {
                console.error('Errore export PDF:', error);
                showMessage('Errore durante l\'export PDF: ' + error.message, 'error');
            }
        }

        function exportToExcelFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Nessun dato da esportare', 'error');
                return;
            }

            const currentMonth = getCurrentMonthName();
            
            const exportData = filteredDays.map(day => ({
                'Data': formatDate(day.date),
                'Entrata': day.entryTime,
                'Pausa': day.breakStart || '--',
                'Rientro': day.breakEnd || '--',
                'Uscita': day.exitTime,
                'Pausa Totale': day.breakTime,
                'Ore Lavorate': formatHours(parseFloat(day.workHours)),
                'Straordinari': formatHours(parseFloat(day.overtimeHours)),
                'Ore Notturne': formatHours(parseFloat(day.nightHours || 0)),
                'Tipo Giorno': day.dayType || 'Feriale',
                'Tipo Trasferta': day.travelType || '--',
                'Compenso (€)': day.dailyPay,
                'Note': day.notes
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            const monthlyData = calculateMonthlyTotals(filteredDays);
            
            const summary = [
                [`RIEPILOGO - ${currentMonth.toUpperCase()}`],
                [''],
                ['Ore Ordinarie:', formatHours(monthlyData.regularHours)],
                ['Ore Straordinari:', formatHours(monthlyData.overtimeHours)],
                ['Ore Notturne:', formatHours(monthlyData.nightHours)],
                ['Giorni Trasferta:', monthlyData.travelDays.toString()],
                ['Totale:', `€${monthlyData.monthlyTotal.toFixed(2)}`]
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Dettagli');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Riepilogo');

            const fileName = `orari_${currentMonth.toLowerCase().replace(' ', '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('Excel esportato!', 'success');
        }

        function exportToPDFFiltered() {
            const filteredDays = getFilteredDaysByMonth();
            
            if (filteredDays.length === 0) {
                showMessage('Nessun dato da esportare', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const currentMonth = getCurrentMonthName();
                
                doc.setFontSize(20);
                doc.setTextColor(139, 0, 0);
                doc.text(`REGISTRO - ${currentMonth.toUpperCase()}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const today = new Date().toLocaleDateString('it-IT');
                doc.text(`Generato: ${today}`, pageWidth / 2, 40, { align: 'center' });
                
                const monthlyData = calculateMonthlyTotals(filteredDays);
                
                let yPos = 55;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`RIEPILOGO ${currentMonth.toUpperCase()}`, margin, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                
                const summaryData = [
                    [`Ore Ordinarie:`, formatHours(monthlyData.regularHours)],
                    [`Ore Straordinari:`, formatHours(monthlyData.overtimeHours)],
                    [`Ore Notturne:`, formatHours(monthlyData.nightHours)],
                    [`Giorni Trasferta:`, monthlyData.travelDays.toString()],
                    [`TOTALE:`, `€${monthlyData.monthlyTotal.toFixed(2)}`]
                ];
                
                summaryData.forEach(([label, value], index) => {
                    doc.text(label, margin, yPos + (index * 6));
                    doc.setFont(undefined, 'bold');
                    if (index === summaryData.length - 1) {
                        doc.setTextColor(139, 0, 0);
                        doc.setFontSize(12);
                    }
                    doc.text(value, margin + 60, yPos + (index * 6));
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(50, 50, 50);
                    doc.setFontSize(10);
                });
                
                yPos += 45;
                
                const tableData = filteredDays.map(day => [
                    formatDate(day.date),
                    day.entryTime,
                    day.breakStart || '--',
                    day.breakEnd || '--',
                    day.exitTime,
                    day.breakTime,
                    formatHours(parseFloat(day.workHours)),
                    formatHours(parseFloat(day.overtimeHours)),
                    formatHours(parseFloat(day.nightHours || 0)),
                    day.dayType?.substring(0, 15) || 'Feriale',
                    day.travelType || '--',
                    `€${day.dailyPay}`,
                    (day.notes || '').substring(0, 20)
                ]);
                
                const tableHeaders = [
                    'Data', 'Entrata', 'Pausa', 'Rientro', 'Uscita', 
                    'Pausa Tot.', 'Ore Lav.', 'Straord.', 'Notturne', 
                    'Tipo', 'Trasferta', 'Compenso', 'Note'
                ];
                
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [139, 0, 0],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 22 },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 18 },
                        3: { cellWidth: 18 },
                        4: { cellWidth: 18 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 18 },
                        7: { cellWidth: 18 },
                        8: { cellWidth: 18 },
                        9: { cellWidth: 25 },
                        10: { cellWidth: 20 },
                        11: { cellWidth: 22, fontStyle: 'bold' },
                        12: { cellWidth: 25, fontSize: 7 }
                    },
                    didDrawPage: function(data) {
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Pag. ${data.pageNumber}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                        doc.text('Orari Lavoro Pro v4.0', margin, pageHeight - 10);
                    }
                });
                
                const fileName = `registro_${currentMonth.toLowerCase().replace(' ', '_')}.pdf`;
                doc.save(fileName);
                
                showMessage('PDF generato!', 'success');
                
            } catch (error) {
                console.error('Errore PDF:', error);
                showMessage('Errore generazione PDF', 'error');
            }
        }

        function clearAllData() {
            if (confirm('Cancellare TUTTI i dati? Non è reversibile!')) {
                workDays = [];
                updateWorkDaysList();
                populateMonthSelector();
                updateSummary();
                generateCalendar();
                autoSaveWorkDays();
                showMessage('Dati cancellati', 'success');
            }
        }

        function importFromExcelFixed() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            processImportedDataFixed(jsonData);
                            
                        } catch (error) {
                            console.error('Errore import:', error);
                            showMessage('Errore lettura Excel', 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
        }

        function processImportedDataFixed(data) {
            if (!data || data.length === 0) {
                showMessage('File vuoto', 'error');
                return;
            }

            let importedCount = 0;
            let errorCount = 0;
            let skippedCount = 0;

            data.forEach((row, index) => {
                try {
                    const mappedRow = mapYourExcelFormat(row, index);
                    
                    if (mappedRow && mappedRow.date && mappedRow.entryTime) {
                        const existingIndex = workDays.findIndex(day => day.date === mappedRow.date);
                        if (existingIndex !== -1) {
                            workDays.splice(existingIndex, 1);
                        }
                        
                        workDays.push(mappedRow);
                        importedCount++;
                    } else {
                        skippedCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            });

            workDays.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            updateWorkDaysList();
            populateMonthSelector();
            updateSummary();
            generateCalendar();
            autoSaveWorkDays();
            
            showMessage(`Importati: ${importedCount} | Saltati: ${skippedCount}`, importedCount > 0 ? 'success' : 'error');
        }

        function mapYourExcelFormat(row, rowIndex) {
            const data = row['Data'];
            const entrata = row['Entrata'];
            const pausa = row['Pausa'];
            const rientro = row['Rientro'];
            const uscita = row['Uscita'];
            const note = row['Note'] || '';

            if (!data) return null;

            let date;
            if (typeof data === 'string' && data.includes('/')) {
                const dateParts = data.split('/');
                if (dateParts.length === 3) {
                    const day = dateParts[0].padStart(2, '0');
                    const month = dateParts[1].padStart(2, '0');
                    const year = dateParts[2];
                    date = `${year}-${month}-${day}`;
                }
            }

            if (!date) return null;

            const entryTime = cleanTimeString(entrata);
            const exitTime = cleanTimeString(uscita);
            const breakStart = cleanTimeString(pausa);
            const breakEnd = cleanTimeString(rientro);

            if (!entryTime) return null;

            if (entryTime && exitTime) {
                const currentConfig = {
                    date: document.getElementById('workDate').value,
                    breakStart: document.getElementById('breakStart').value,
                    breakEnd: document.getElementById('breakEnd').value,
                    additionalBreaks: [...additionalBreaks]
                };

                try {
                    document.getElementById('workDate').value = date;
                    document.getElementById('breakStart').value = breakStart || '';
                    document.getElementById('breakEnd').value = breakEnd || '';
                    additionalBreaks = [];

                    const result = calculateWorkHours(entryTime, exitTime);

                    document.getElementById('workDate').value = currentConfig.date;
                    document.getElementById('breakStart').value = currentConfig.breakStart;
                    document.getElementById('breakEnd').value = currentConfig.breakEnd;
                    additionalBreaks = currentConfig.additionalBreaks;

                    return {
                        date,
                        entryTime,
                        breakStart: breakStart || '',
                        breakEnd: breakEnd || '',
                        additionalBreaks: [],
                        exitTime,
                        breakTime: result.breakTime,
                        workHours: result.workHours,
                        overtimeHours: result.overtimeHours,
                        nightHours: result.nightHours || '0.00',
                        dayType: result.dayType || 'Feriale',
                        travelType: '',
                        dailyPay: result.dailyPay,
                        notes: note,
                        status: 'completo'
                    };

                } catch (error) {
                    document.getElementById('workDate').value = currentConfig.date;
                    document.getElementById('breakStart').value = currentConfig.breakStart;
                    document.getElementById('breakEnd').value = currentConfig.breakEnd;
                    additionalBreaks = currentConfig.additionalBreaks;
                    
                    return null;
                }
            } else {
                return {
                    date,
                    entryTime: entryTime || '',
                    breakStart: breakStart || '',
                    breakEnd: breakEnd || '',
                    additionalBreaks: [],
                    exitTime: exitTime || '',
                    breakTime: '--',
                    workHours: '0.00',
                    overtimeHours: '0.00',
                    nightHours: '0.00',
                    dayType: '--',
                    travelType: '',
                    dailyPay: '0.00',
                    notes: note,
                    status: entryTime ? 'in_corso' : 'incompleto'
                };
            }
        }

        function cleanTimeString(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return '';
            
            const cleaned = timeStr.trim();
            if (cleaned.match(/^\d{1,2}:\d{2}$/)) return cleaned;
            if (cleaned === '' || cleaned === '-' || cleaned === '--') return '';
            
            return cleaned;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            
            if (minutes === 60) {
                return `${hours + 1}h 00m`;
            }
            
            return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        }

        function dateToString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        function saveConfig() {
            const config = {
                hourlyRate: document.getElementById('hourlyRate').value,
                standardHours: document.getElementById('standardHours').value,
                standardBreak: document.getElementById('standardBreak').value,
                travelTypes: travelTypes
            };
            
            try {
                localStorage.setItem('timesheetConfig', JSON.stringify(config));
                showMessage('Config salvata', 'success');
            } catch (e) {
                showMessage('Errore salvataggio', 'error');
            }
        }

        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('timesheetConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    document.getElementById('hourlyRate').value = config.hourlyRate || 15;
                    document.getElementById('standardHours').value = config.standardHours || 8;
                    document.getElementById('standardBreak').value = config.standardBreak || 60;
                    
                    if (config.travelTypes) {
                        travelTypes = config.travelTypes;
                    }
                    
                    return true;
                }
            } catch (e) {
                console.log('Errore caricamento config:', e);
            }
            return false;
        }

        function autoSaveConfig() {
            setTimeout(() => {
                const config = {
                    hourlyRate: document.getElementById('hourlyRate').value,
                    standardHours: document.getElementById('standardHours').value,
                    standardBreak: document.getElementById('standardBreak').value,
                    travelTypes: travelTypes
                };
                
                try {
                    localStorage.setItem('timesheetConfig', JSON.stringify(config));
                } catch (e) {}
            }, 500);
        }

        function loadWorkDays() {
            try {
                const savedWorkDays = localStorage.getItem('timesheetWorkDays');
                if (savedWorkDays) {
                    workDays = JSON.parse(savedWorkDays);
                    return workDays.length;
                }
            } catch (e) {
                console.log('Errore caricamento dati:', e);
            }
            return 0;
        }

        function autoSaveWorkDays() {
            setTimeout(() => {
                try {
                    localStorage.setItem('timesheetWorkDays', JSON.stringify(workDays));
                } catch (e) {}
            }, 100);
        }
    </script>
</body>
</html>
